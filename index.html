<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@latest/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            transition: background 0.5s ease;
            min-height: 100vh;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #8B0000, #4B0000);
            color: #fff;
        }
        body.light-mode {
            background: linear-gradient(135deg, #1C2526, #000000);
            color: #fff;
        }
        #app {
            padding: 1rem;
        }
        .hidden {
            display: none;
        }
        /* Login Page */
        .login-form {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }
        .login-form input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border: none;
        }
        .login-button {
            width: 100%;
            padding: 0.5rem;
            background: #28A745;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            animation: buttonGlow 2s infinite;
            transition: transform 0.2s;
        }
        .login-button:hover {
            transform: scale(1.05);
        }
        @keyframes buttonGlow {
            0% { box-shadow: 0 0 10px #28A745; }
            50% { box-shadow: 0 0 20px #34D058; }
            100% { box-shadow: 0 0 10px #28A745; }
        }
        .register-link {
            color: #00008B;
            cursor: pointer;
        }
        .register-link:hover {
            text-decoration: underline;
        }
        /* Popups */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .popup-content {
            background: #fff;
            color: #000;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .popup-content input, .popup-content select, .popup-content textarea {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .popup-content button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.2s;
        }
        .popup-content button:hover {
            transform: scale(1.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .profile {
            position: relative;
            cursor: pointer;
        }
        .profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #DC3545;
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            color: #000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            z-index: 10;
        }
        .profile-dropdown ul {
            list-style: none;
        }
        .profile-dropdown li {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .profile-dropdown li:hover {
            background: #f0f0f0;
        }
        .mode-switcher {
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .mode-switcher:hover {
            transform: rotate(180deg);
        }
        .timer {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 24px;
        }
        /* Users Section */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .user-card {
            background: #fff;
            color: #000;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .user-card:hover {
            transform: scale(1.05);
        }
        .user-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        /* Tasks Section */
        .summary {
            margin: 1rem 0;
        }
        .summary .cards {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        .card {
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            flex: 1;
            text-align: center;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .completed { background: #28A745; }
        .pending { background: #FFC107; }
        .tasks-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }
        .buttons button, #users-button, #back-to-tasks {
            padding: 0.5rem 1rem;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .buttons button:hover, #users-button:hover, #back-to-tasks:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        #add-task { background: #28A745; }
        #export-tasks, #import-tasks, #users-button, #back-to-tasks { background: #6C757D; }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .filters select, .filters input {
            padding: 0.5rem;
            border-radius: 5px;
            border: none;
        }
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .task-row {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            cursor: move;
        }
        .task-row:hover {
            transform: scale(1.02);
        }
        .task-row.expired { border-left: 5px solid #DC3545; }
        .task-row.due-soon { border-left: 5px solid #FFC107; }
        .task-row.normal { border-left: 5px solid #28A745; }
        .task-row.high { background: rgba(220, 53, 69, 0.1); }
        .task-row.medium { background: rgba(255, 193, 7, 0.1); }
        .task-row.low { background: rgba(108, 117, 125, 0.1); }
        .task-row > * {
            margin-right: 0.5rem;
        }
        .task-row button {
            padding: 0.3rem 0.6rem;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
        }
        .play-task, .pause-task { background: #007BFF; }
        .view-task { background: #17A2B8; }
        .edit-task { background: #FFC107; }
        .delete-task { background: #DC3545; }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #28A745;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #28A745, #34D058);
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            gap: 1rem;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .graph-view {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .graph-view canvas {
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            max-width: 100%;
        }
        .view-switcher button {
            padding: 0.5rem 1rem;
            border: none;
            color: #fff;
            cursor: pointer;
            background: #6C757D;
        }
        .view-switcher button.active {
            background: #28A745;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: #333;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .users-grid {
                grid-template-columns: 1fr;
            }
            .summary .cards {
                flex-direction: column;
            }
            .task-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .filters {
                flex-direction: column;
            }
            .graph-view {
                flex-direction: column;
            }
            .buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="app">
        <div id="login-page">
            <div class="login-form">
                <h2>Login</h2>
                <label for="email">Email:</label>
                <input type="email" id="email" value="test@example.com" aria-label="Email">
                <label for="password">Password:</label>
                <input type="password" id="password" value="123456" aria-label="Password">
                <button class="login-button" aria-label="Login">Login</button>
                <p>Don't have an account? <span class="register-link" tabindex="0">Register now.</span></p>
            </div>
        </div>
        <div id="dashboard" class="hidden">
            <header>
                <h1>To-Do App</h1>
                <button id="users-button" aria-label="View Users">Users</button>
                <div class="header-right">
                    <div class="timer">
                        <span id="timer-display">00:00:00</span>
                    </div>
                    <div class="profile">
                        <img id="profile-picture" alt="Profile Picture">
                        <span class="notification-badge" id="notification-count">0</span>
                        <div class="profile-dropdown hidden">
                            <ul>
                                <li id="view-profile" tabindex="0">View Profile</li>
                                <li id="logout" tabindex="0">Logout</li>
                                <li id="switch-mode" tabindex="0">Switch Mode</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mode-switcher" aria-label="Toggle Mode">
                        <i id="mode-icon" class="fas fa-moon"></i>
                    </div>
                </div>
            </header>
            <div id="tasks-section">
                <div class="summary">
                    <h2>Total Tasks: <span id="total-tasks">0</span></h2>
                    <div class="cards">
                        <div class="card completed">Completed Tasks: <span id="completed-tasks">0</span></div>
                        <div class="card pending">Pending Tasks: <span id="pending-tasks">0</span></div>
                    </div>
                </div>
                <div class="tasks-title">
                    <h2>Tasks</h2>
                    <div class="view-switcher">
                        <button id="list-view" class="active" aria-label="List View">List View</button>
                        <button id="graph-view" aria-label="Graph View">Graph View</button>
                    </div>
                    <div class="buttons">
                        <button id="add-task" aria-label="Add Task">+ Add Task</button>
                        <button id="export-tasks" aria-label="Export Tasks">Export</button>
                        <button id="import-tasks" aria-label="Import Tasks">Import</button>
                        <button id="manage-categories" aria-label="Manage Categories">Manage Categories</button>
                    </div>
                </div>
                <div class="filters">
                    <select id="filter-status" aria-label="Filter by Status">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="filter-category" aria-label="Filter by Category"></select>
                    <select id="filter-priority" aria-label="Filter by Priority">
                        <option value="all">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="filter-due-date" aria-label="Filter by Due Date">
                        <option value="all">All Due Dates</option>
                        <option value="today">Today</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="custom-date-range" class="hidden">
                        <input type="text" id="start-date" placeholder="Start Date" aria-label="Start Date">
                        <input type="text" id="end-date" placeholder="End Date" aria-label="End Date">
                    </div>
                    <input type="text" id="search-bar" placeholder="Search tasks..." aria-label="Search Tasks">
                    <select id="sort-by" aria-label="Sort By">
                        <option value="title-asc">Title A-Z</option>
                        <option value="title-desc">Title Z-A</option>
                        <option value="due-date-asc">Due Date Earliest</option>
                        <option value="due-date-desc">Due Date Latest</option>
                        <option value="priority-desc">Priority High to Low</option>
                        <option value="priority-asc">Priority Low to High</option>
                    </select>
                </div>
                <div class="task-list" role="list"></div>
                <div class="graph-view hidden">
                    <canvas id="xy-graph"></canvas>
                    <canvas id="pie-chart"></canvas>
                </div>
            </div>
            <div id="users-section" class="hidden">
                <h2>Users</h2>
                <div class="users-grid"></div>
                <button id="back-to-tasks" aria-label="Back to Tasks">Back to Tasks</button>
            </div>
            <div class="action-bar hidden">
                <button id="batch-delete" aria-label="Delete Selected">Delete Selected</button>
                <button id="batch-complete" aria-label="Complete Selected">Complete Selected</button>
            </div>
        </div>
        <div id="registration-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Register</h2>
                <label for="last-name">Last Name:</label>
                <input type="text" id="last-name" aria-label="Last Name">
                <label for="first-name">First Name:</label>
                <input type="text" id="first-name" aria-label="First Name">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" aria-label="Email">
                <label for="confirm-email">Confirm Email:</label>
                <input type="email" id="confirm-email" aria-label="Confirm Email">
                <label for="reg-password">Password:</label>
                <input type="password" id="reg-password" aria-label="Password">
                <label for="confirm-password">Confirm Password:</label>
                <input type="password" id="confirm-password" aria-label="Confirm Password">
                <label for="birthdate">Birthdate:</label>
                <input type="text" id="birthdate" placeholder="Select date" aria-label="Birthdate">
                <label for="nationality">Nationality:</label>
                <select id="nationality" aria-label="Nationality"></select>
                <label for="role">Role:</label>
                <select id="role" aria-label="Role">
                    <option value="Manager">Manager</option>
                    <option value="Staff">Staff</option>
                    <option value="Customer">Customer</option>
                    <option value="Admin">Admin</option>
                </select>
                <button id="create-account" style="background: #28A745;" aria-label="Create Account">Create</button>
                <button id="cancel-registration" style="background: #6C757D;" aria-label="Cancel">Cancel</button>
            </div>
        </div>
        <div id="profile-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Profile</h2>
                <img id="profile-pic-display" alt="Profile Picture">
                <p>Name: <span id="profile-name"></span></p>
                <p>Email: <span id="profile-email"></span></p>
                <p>Country: <span id="profile-country"></span></p>
                <p>Role: <span id="profile-role"></span></p>
                <p>Joining Date: <span id="profile-joining-date"></span></p>
                <button id="edit-profile" style="background: #28A745;" aria-label="Edit Profile">Edit Profile</button>
                <button id="close-profile" style="background: #6C757D;" aria-label="Close">Close</button>
            </div>
        </div>
        <div id="add-task-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Add Task</h2>
                <label for="task-title">Title:</label>
                <input type="text" id="task-title" aria-label="Task Title">
                <label for="task-description">Description:</label>
                <textarea id="task-description" aria-label="Task Description"></textarea>
                <label for="task-due-date">Due Date:</label>
                <input type="text" id="task-due-date" aria-label="Due Date">
                <label for="task-priority">Priority:</label>
                <select id="task-priority" aria-label="Priority">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <label for="task-category">Category:</label>
                <select id="task-category" aria-label="Category"></select>
                <label for="task-notes">Notes:</label>
                <textarea id="task-notes" aria-label="Notes"></textarea>
                <div id="sub-tasks">
                    <h3>Sub-Tasks</h3>
                    <button id="add-sub-task" style="background: #007BFF;" aria-label="Add Sub-Task">+ Add Sub-Task</button>
                    <div id="sub-task-list"></div>
                </div>
                <button id="create-task" style="background: #28A745;" aria-label="Create Task">Create</button>
                <button id="cancel-add-task" style="background: #6C757D;" aria-label="Cancel">Cancel</button>
            </div>
        </div>
        <div id="edit-task-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Edit Task</h2>
                <input type="hidden" id="edit-task-id">
                <label for="edit-task-title">Title:</label>
                <input type="text" id="edit-task-title" aria-label="Task Title">
                <label for="edit-task-description">Description:</label>
                <textarea id="edit-task-description" aria-label="Task Description"></textarea>
                <label for="edit-task-due-date">Due Date:</label>
                <input type="text" id="edit-task-due-date" aria-label="Due Date">
                <label for="edit-task-priority">Priority:</label>
                <select id="edit-task-priority" aria-label="Priority">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <label for="edit-task-category">Category:</label>
                <select id="edit-task-category" aria-label="Category"></select>
                <label for="edit-task-notes">Notes:</label>
                <textarea id="edit-task-notes" aria-label="Notes"></textarea>
                <div id="edit-sub-tasks">
                    <h3>Sub-Tasks</h3>
                    <button id="edit-add-sub-task" style="background: #007BFF;" aria-label="Add Sub-Task">+ Add Sub-Task</button>
                    <div id="edit-sub-task-list"></div>
                </div>
                <button id="save-task" style="background: #28A745;" aria-label="Save Task">Save</button>
                <button id="cancel-edit-task" style="background: #6C757D;" aria-label="Cancel">Cancel</button>
            </div>
        </div>
        <div id="view-task-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Task Details</h2>
                <p>Title: <span id="view-task-title"></span></p>
                <p>Description: <span id="view-task-description"></span></p>
                <p>Due Date: <span id="view-task-due-date"></span></p>
                <p>Priority: <span id="view-task-priority"></span></p>
                <p>Category: <span id="view-task-category"></span></p>
                <p>Notes: <span id="view-task-notes"></span></p>
                <h3>Sub-Tasks</h3>
                <ul id="view-sub-task-list"></ul>
                <button id="close-view-task" style="background: #6C757D;" aria-label="Close">Close</button>
            </div>
        </div>
        <div id="notifications-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Notifications</h2>
                <ul id="notifications-list"></ul>
                <button id="mark-all-read" style="background: #28A745;" aria-label="Mark All Read">Mark All as Read</button>
                <button id="close-notifications" style="background: #6C757D;" aria-label="Close">Close</button>
            </div>
        </div>
        <div id="export-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Export Tasks</h2>
                <select id="export-format" aria-label="Export Format">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                    <option value="json">JSON</option>
                </select>
                <button id="export-now" style="background: #28A745;" aria-label="Export Now">Export</button>
                <button id="cancel-export" style="background: #6C757D;" aria-label="Cancel">Cancel</button>
            </div>
        </div>
        <div id="import-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Import Tasks</h2>
                <input type="file" id="import-file" accept=".json" aria-label="Upload JSON File">
                <button id="import-now" style="background: #28A745;" aria-label="Import Now">Import</button>
                <button id="cancel-import" style="background: #6C757D;" aria-label="Cancel">Cancel</button>
            </div>
        </div>
        <div id="categories-popup" class="popup hidden">
            <div class="popup-content">
                <h2>Manage Categories</h2>
                <input type="text" id="new-category" placeholder="New Category" aria-label="New Category">
                <button id="add-category" style="background: #28A745;" aria-label="Add Category">Add</button>
                <ul id="category-list"></ul>
                <button id="close-categories" style="background: #6C757D;" aria-label="Close">Close</button>
            </div>
        </div>
    </div>
    <script>
        let currentMode = localStorage.getItem('mode') || 'dark';
        let activeTaskId = null;
        let startTime = null;
        let timerInterval = null;
        let undoStack = [];
        let redoStack = [];

        // Local Storage Functions
        function getUsers() {
            return JSON.parse(localStorage.getItem('users') || '[]');
        }
        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }
        function getTasks() {
            return JSON.parse(localStorage.getItem('tasks') || '[]');
        }
        function saveTasks(tasks) {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        function getNotifications() {
            return JSON.parse(localStorage.getItem('notifications') || '[]');
        }
        function saveNotifications(notifications) {
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }
        function getCategories() {
            return JSON.parse(localStorage.getItem('categories') || '["Work", "Personal"]');
        }
        function saveCategories(categories) {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        // Page Navigation
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadProfilePicture();
            updateNotificationCount();
            loadFilters();
            renderTaskList();
        }
        function showLogin() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
        }

        // Mode Switching
        document.body.classList.add(currentMode + '-mode');
        document.getElementById('mode-icon').classList.add(currentMode === 'dark' ? 'fa-moon' : 'fa-sun');
        function toggleMode() {
            currentMode = currentMode === 'dark' ? 'light' : 'dark';
            document.body.classList.toggle('dark-mode', currentMode === 'dark');
            document.body.classList.toggle('light-mode', currentMode === 'light');
            document.getElementById('mode-icon').classList.toggle('fa-moon', currentMode === 'dark');
            document.getElementById('mode-icon').classList.toggle('fa-sun', currentMode === 'light');
            localStorage.setItem('mode', currentMode);
        }
        document.querySelector('.mode-switcher').addEventListener('click', toggleMode);
        document.getElementById('switch-mode').addEventListener('click', toggleMode);

        // Login
        document.querySelector('.login-button').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const users = getUsers();
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                localStorage.setItem('currentUserEmail', email);
                showDashboard();
            } else {
                alert('Invalid email or password.');
            }
        });

        // Registration
        document.querySelector('.register-link').addEventListener('click', () => {
            document.getElementById('registration-popup').classList.remove('hidden');
            flatpickr("#birthdate", { dateFormat: "Y-m-d" });
        });
        fetch('https://restcountries.com/v3.1/all')
            .then(res => res.json())
            .then(data => {
                const nationality = document.getElementById('nationality');
                data.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.name.common;
                    option.textContent = country.name.common;
                    nationality.appendChild(option);
                });
            });
        document.getElementById('create-account').addEventListener('click', () => {
            const user = {
                lastName: document.getElementById('last-name').value,
                firstName: document.getElementById('first-name').value,
                email: document.getElementById('reg-email').value,
                confirmEmail: document.getElementById('confirm-email').value,
                password: document.getElementById('reg-password').value,
                confirmPassword: document.getElementById('confirm-password').value,
                birthdate: document.getElementById('birthdate').value,
                nationality: document.getElementById('nationality').value,
                role: document.getElementById('role').value
            };
            if (Object.values(user).some(v => !v)) {
                alert('All fields are required.');
                return;
            }
            if (user.email !== user.confirmEmail) {
                alert('Emails do not match.');
                return;
            }
            if (user.password !== user.confirmPassword) {
                alert('Passwords do not match.');
                return;
            }
            const users = getUsers();
            if (users.some(u => u.email === user.email)) {
                alert('Email already exists.');
                return;
            }
            users.push({
                ...user,
                joiningDate: new Date().toISOString(),
                profilePicture: null
            });
            saveUsers(users);
            document.getElementById('registration-popup').classList.add('hidden');
            alert('Account created successfully.');
        });
        document.getElementById('cancel-registration').addEventListener('click', () => {
            document.getElementById('registration-popup').classList.add('hidden');
        });

        // Profile
        document.querySelector('.profile').addEventListener('click', () => {
            document.querySelector('.profile-dropdown').classList.toggle('hidden');
        });
        document.getElementById('view-profile').addEventListener('click', () => {
            const user = getUsers().find(u => u.email === localStorage.getItem('currentUserEmail'));
            document.getElementById('profile-name').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-country').textContent = user.nationality;
            document.getElementById('profile-role').textContent = user.role;
            document.getElementById('profile-joining-date').textContent = new Date(user.joiningDate).toLocaleDateString();
            document.getElementById('profile-pic-display').src = user.profilePicture || `https://randomuser.me/api/portraits/men/${Math.floor(Math.random() * 100)}.jpg`;
            document.getElementById('profile-popup').classList.remove('hidden');
        });
        document.getElementById('close-profile').addEventListener('click', () => {
            document.getElementById('profile-popup').classList.add('hidden');
        });
        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('currentUserEmail');
            showLogin();
        });

        // Timer
        function startTimer(taskId) {
            if (activeTaskId && activeTaskId !== taskId) pauseTimer();
            activeTaskId = taskId;
            startTime = new Date().getTime();
            localStorage.setItem('activeTaskId', taskId);
            localStorage.setItem('startTime', startTime);
            timerInterval = setInterval(updateTimer, 1000);
        }
        function pauseTimer() {
            if (!activeTaskId) return;
            const endTime = new Date().getTime();
            const elapsed = Math.floor((endTime - startTime) / 1000);
            const tasks = getTasks();
            const task = tasks.find(t => t.id === activeTaskId);
            task.totalTimeSpent = (task.totalTimeSpent || 0) + elapsed;
            saveTasks(tasks);
            alert(`Time spent on '${task.title}': ${formatTime(elapsed)}`);
            clearInterval(timerInterval);
            activeTaskId = null;
            startTime = null;
            localStorage.removeItem('activeTaskId');
            localStorage.removeItem('startTime');
            document.getElementById('timer-display').textContent = '00:00:00';
        }
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((new Date().getTime() - startTime) / 1000);
                document.getElementById('timer-display').textContent = formatTime(elapsed);
            }
        }
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // Users
        document.getElementById('users-button').addEventListener('click', () => {
            document.getElementById('tasks-section').classList.add('hidden');
            document.getElementById('users-section').classList.remove('hidden');
            loadUsers();
        });
        document.getElementById('back-to-tasks').addEventListener('click', () => {
            document.getElementById('users-section').classList.add('hidden');
            document.getElementById('tasks-section').classList.remove('hidden');
        });
        function loadUsers() {
            fetch('https://randomuser.me/api/?results=9')
                .then(res => res.json())
                .then(data => {
                    const grid = document.querySelector('.users-grid');
                    grid.innerHTML = '';
                    data.results.forEach(user => {
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <img src="${user.picture.medium}" alt="${user.name.first}">
                            <h3>${user.name.first} ${user.name.last}</h3>
                            <p>${user.email}</p>
                            <p>Role: ${['Manager', 'Staff', 'Customer', 'Admin'][Math.floor(Math.random() * 4)]}</p>
                        `;
                        grid.appendChild(card);
                    });
                });
        }

        // Tasks
        function loadFilters() {
            const categories = getCategories();
            ['task-category', 'edit-task-category', 'filter-category'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = id === 'filter-category' ? '<option value="all">All Categories</option>' : '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            });
        }
        function getFilteredTasks() {
            let tasks = getTasks();
            const status = document.getElementById('filter-status').value;
            if (status === 'active') tasks = tasks.filter(t => !t.completed);
            else if (status === 'completed') tasks = tasks.filter(t => t.completed);
            const category = document.getElementById('filter-category').value;
            if (category !== 'all') tasks = tasks.filter(t => t.category === category);
            const priority = document.getElementById('filter-priority').value;
            if (priority !== 'all') tasks = tasks.filter(t => t.priority === priority);
            const dueDateFilter = document.getElementById('filter-due-date').value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (dueDateFilter === 'today') {
                tasks = tasks.filter(t => new Date(t.dueDate).setHours(0, 0, 0, 0) === today.getTime());
            } else if (dueDateFilter === 'this-week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                tasks = tasks.filter(t => {
                    const due = new Date(t.dueDate);
                    return due >= weekStart && due <= weekEnd;
                });
            } else if (dueDateFilter === 'this-month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                tasks = tasks.filter(t => {
                    const due = new Date(t.dueDate);
                    return due >= monthStart && due <= monthEnd;
                });
            } else if (dueDateFilter === 'custom') {
                const start = document.getElementById('start-date').value;
                const end = document.getElementById('end-date').value;
                if (start && end) {
                    tasks = tasks.filter(t => {
                        const due = new Date(t.dueDate);
                        return due >= new Date(start) && due <= new Date(end);
                    });
                }
            }
            const search = document.getElementById('search-bar').value.toLowerCase();
            if (search) {
                tasks = tasks.filter(t => t.title.toLowerCase().includes(search) || t.description.toLowerCase().includes(search));
            }
            const sortBy = document.getElementById('sort-by').value;
            if (sortBy === 'title-asc') tasks.sort((a, b) => a.title.localeCompare(b.title));
            else if (sortBy === 'title-desc') tasks.sort((a, b) => b.title.localeCompare(a.title));
            else if (sortBy === 'due-date-asc') tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            else if (sortBy === 'due-date-desc') tasks.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
            else if (sortBy === 'priority-desc') {
                const order = { 'High': 3, 'Medium': 2, 'Low': 1 };
                tasks.sort((a, b) => order[b.priority] - order[a.priority]);
            } else if (sortBy === 'priority-asc') {
                const order = { 'High': 3, 'Medium': 2, 'Low': 1 };
                tasks.sort((a, b) => order[a.priority] - order[b.priority]);
            }
            return tasks;
        }
        function renderTaskList() {
            const tasks = getFilteredTasks();
            const list = document.querySelector('.task-list');
            list.innerHTML = '';
            tasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'task-row';
                row.draggable = true;
                row.dataset.id = task.id;
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                if (dueDate < now) row.classList.add('expired');
                else if ((dueDate - now) / (1000 * 3600) < 48) row.classList.add('due-soon');
                else row.classList.add('normal');
                row.classList.add(task.priority.toLowerCase());
                row.innerHTML = `
                    <input type="checkbox" class="task-checkbox" data-id="${task.id}" aria-label="Select Task">
                    <span>${task.title}</span>
                    <span>${task.description}</span>
                    <span>${task.dueDate}</span>
                    <span>${task.priority}</span>
                    <span>${task.category}</span>
                    <button class="view-task" data-id="${task.id}" aria-label="View Task">View</button>
                    <button class="edit-task" data-id="${task.id}" aria-label="Edit Task">Edit</button>
                    <button class="delete-task" data-id="${task.id}" aria-label="Delete Task">Delete</button>
                    <button class="play-task" data-id="${task.id}" style="${activeTaskId === task.id ? 'display: none;' : ''}" aria-label="Play Task">Play</button>
                    <button class="pause-task" data-id="${task.id}" style="${activeTaskId === task.id ? '' : 'display: none;'}" aria-label="Pause Task">Pause</button>
                    <label class="switch">
                        <input type="checkbox" class="complete-task" data-id="${task.id}" ${task.completed ? 'checked' : ''} aria-label="Complete Task">
                        <span class="slider"></span>
                    </label>
                `;
                list.appendChild(row);
            });
            updateSummary();
        }
        function updateSummary() {
            const tasks = getTasks();
            document.getElementById('total-tasks').textContent = tasks.length;
            document.getElementById('completed-tasks').textContent = tasks.filter(t => t.completed).length;
            document.getElementById('pending-tasks').textContent = tasks.filter(t => !t.completed).length;
        }
        document.querySelector('.task-list').addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (e.target.classList.contains('play-task')) {
                startTimer(id);
                renderTaskList();
            } else if (e.target.classList.contains('pause-task')) {
                pauseTimer();
                renderTaskList();
            } else if (e.target.classList.contains('view-task')) {
                const task = getTasks().find(t => t.id === id);
                document.getElementById('view-task-title').textContent = task.title;
                document.getElementById('view-task-description').textContent = task.description;
                document.getElementById('view-task-due-date').textContent = task.dueDate;
                document.getElementById('view-task-priority').textContent = task.priority;
                document.getElementById('view-task-category').textContent = task.category;
                document.getElementById('view-task-notes').textContent = task.notes;
                const subList = document.getElementById('view-sub-task-list');
                subList.innerHTML = '';
                (task.subTasks || []).forEach(st => {
                    const li = document.createElement('li');
                    li.textContent = st;
                    subList.appendChild(li);
                });
                document.getElementById('view-task-popup').classList.remove('hidden');
            } else if (e.target.classList.contains('edit-task')) {
                const task = getTasks().find(t => t.id === id);
                document.getElementById('edit-task-id').value = task.id;
                document.getElementById('edit-task-title').value = task.title;
                document.getElementById('edit-task-description').value = task.description;
                document.getElementById('edit-task-due-date').value = task.dueDate;
                document.getElementById('edit-task-priority').value = task.priority;
                document.getElementById('edit-task-category').value = task.category;
                document.getElementById('edit-task-notes').value = task.notes;
                const subList = document.getElementById('edit-sub-task-list');
                subList.innerHTML = '';
                (task.subTasks || []).forEach(st => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = st;
                    input.className = 'sub-task-input';
                    subList.appendChild(input);
                });
                flatpickr("#edit-task-due-date", { dateFormat: "Y-m-d" });
                document.getElementById('edit-task-popup').classList.remove('hidden');
            } else if (e.target.classList.contains('delete-task')) {
                undoStack.push({ action: 'delete', tasks: getTasks() });
                let tasks = getTasks().filter(t => t.id !== id);
                saveTasks(tasks);
                renderTaskList();
                addNotification(`Task deleted: ${id}`);
            } else if (e.target.classList.contains('complete-task')) {
                undoStack.push({ action: 'update', tasks: getTasks() });
                const tasks = getTasks();
                const task = tasks.find(t => t.id === id);
                task.completed = e.target.checked;
                saveTasks(tasks);
                renderTaskList();
                addNotification(`Task '${task.title}' marked as ${task.completed ? 'completed' : 'incomplete'}`);
            }
        });
        document.querySelector('.task-list').addEventListener('change', e => {
            if (e.target.classList.contains('task-checkbox')) updateActionBar();
        });
        document.querySelector('.task-list').addEventListener('dragstart', e => {
            if (e.target.classList.contains('task-row')) {
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
            }
        });
        document.querySelector('.task-list').addEventListener('dragover', e => e.preventDefault());
        document.querySelector('.task-list').addEventListener('drop', e => {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData('text/plain');
            const target = e.target.closest('.task-row');
            if (target && target.dataset.id !== draggedId) {
                undoStack.push({ action: 'reorder', tasks: getTasks() });
                let tasks = getTasks();
                const draggedTask = tasks.find(t => t.id === draggedId);
                const targetTask = tasks.find(t => t.id === target.dataset.id);
                const draggedIndex = tasks.indexOf(draggedTask);
                const targetIndex = tasks.indexOf(targetTask);
                tasks.splice(draggedIndex, 1);
                tasks.splice(targetIndex, 0, draggedTask);
                saveTasks(tasks);
                renderTaskList();
            }
        });
        document.getElementById('add-task').addEventListener('click', () => {
            document.getElementById('add-task-popup').classList.remove('hidden');
            flatpickr("#task-due-date", { dateFormat: "Y-m-d" });
            loadFilters();
        });
        document.getElementById('add-sub-task').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'sub-task-input';
            document.getElementById('sub-task-list').appendChild(input);
        });
        document.getElementById('create-task').addEventListener('click', () => {
            const task = {
                id: Date.now().toString(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                dueDate: document.getElementById('task-due-date').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                notes: document.getElementById('task-notes').value,
                subTasks: Array.from(document.querySelectorAll('#sub-task-list .sub-task-input')).map(i => i.value).filter(v => v),
                completed: false,
                totalTimeSpent: 0
            };
            if (!task.title || !task.dueDate) {
                alert('Title and due date are required.');
                return;
            }
            undoStack.push({ action: 'create', tasks: getTasks() });
            const tasks = getTasks();
            tasks.push(task);
            saveTasks(tasks);
            renderTaskList();
            addNotification(`Task '${task.title}' created`);
            document.getElementById('add-task-popup').classList.add('hidden');
        });
        document.getElementById('cancel-add-task').addEventListener('click', () => {
            document.getElementById('add-task-popup').classList.add('hidden');
        });
        document.getElementById('edit-add-sub-task').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'sub-task-input';
            document.getElementById('edit-sub-task-list').appendChild(input);
        });
        document.getElementById('save-task').addEventListener('click', () => {
            undoStack.push({ action: 'update', tasks: getTasks() });
            const tasks = getTasks();
            const task = tasks.find(t => t.id === document.getElementById('edit-task-id').value);
            task.title = document.getElementById('edit-task-title').value;
            task.description = document.getElementById('edit-task-description').value;
            task.dueDate = document.getElementById('edit-task-due-date').value;
            task.priority = document.getElementById('edit-task-priority').value;
            task.category = document.getElementById('edit-task-category').value;
            task.notes = document.getElementById('edit-task-notes').value;
            task.subTasks = Array.from(document.querySelectorAll('#edit-sub-task-list .sub-task-input')).map(i => i.value).filter(v => v);
            saveTasks(tasks);
            renderTaskList();
            addNotification(`Task '${task.title}' updated`);
            document.getElementById('edit-task-popup').classList.add('hidden');
        });
        document.getElementById('cancel-edit-task').addEventListener('click', () => {
            document.getElementById('edit-task-popup').classList.add('hidden');
        });
        document.getElementById('close-view-task').addEventListener('click', () => {
            document.getElementById('view-task-popup').classList.add('hidden');
        });

        // Action Bar
        function updateActionBar() {
            const selected = document.querySelectorAll('.task-checkbox:checked').length;
            document.querySelector('.action-bar').classList.toggle('hidden', selected === 0);
        }
        document.getElementById('batch-delete').addEventListener('click', () => {
            undoStack.push({ action: 'delete', tasks: getTasks() });
            const ids = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => cb.dataset.id);
            let tasks = getTasks().filter(t => !ids.includes(t.id));
            saveTasks(tasks);
            renderTaskList();
            addNotification(`${ids.length} tasks deleted`);
        });
        document.getElementById('batch-complete').addEventListener('click', () => {
            undoStack.push({ action: 'update', tasks: getTasks() });
            const ids = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => cb.dataset.id);
            let tasks = getTasks();
            tasks.forEach(t => { if (ids.includes(t.id)) t.completed = true; });
            saveTasks(tasks);
            renderTaskList();
            addNotification(`${ids.length} tasks completed`);
        });

        // Filters and Sort
        document.getElementById('filter-status').addEventListener('change', renderTaskList);
        document.getElementById('filter-category').addEventListener('change', renderTaskList);
        document.getElementById('filter-priority').addEventListener('change', renderTaskList);
        document.getElementById('filter-due-date').addEventListener('change', e => {
            const custom = document.getElementById('custom-date-range');
            if (e.target.value === 'custom') {
                custom.classList.remove('hidden');
                flatpickr("#start-date", { dateFormat: "Y-m-d" });
                flatpickr("#end-date", { dateFormat: "Y-m-d" });
            } else {
                custom.classList.add('hidden');
            }
            renderTaskList();
        });
        document.getElementById('start-date').addEventListener('change', renderTaskList);
        document.getElementById('end-date').addEventListener('change', renderTaskList);
        document.getElementById('search-bar').addEventListener('input', renderTaskList);
        document.getElementById('sort-by').addEventListener('change', renderTaskList);

        // Graph View
        document.getElementById('list-view').addEventListener('click', () => {
            document.getElementById('list-view').classList.add('active');
            document.getElementById('graph-view').classList.remove('active');
            document.querySelector('.task-list').classList.remove('hidden');
            document.querySelector('.graph-view').classList.add('hidden');
        });
        document.getElementById('graph-view').addEventListener('click', () => {
            document.getElementById('graph-view').classList.add('active');
            document.getElementById('list-view').classList.remove('active');
            document.querySelector('.task-list').classList.add('hidden');
            document.querySelector('.graph-view').classList.remove('hidden');
            renderGraphs();
        });
        function renderGraphs() {
            const tasks = getTasks();
            const dates = [...new Set(tasks.map(t => t.dueDate))].sort();
            const completedData = dates.map(d => tasks.filter(t => t.dueDate === d && t.completed).length);
            const pendingData = dates.map(d => tasks.filter(t => t.dueDate === d && !t.completed).length);
            new Chart(document.getElementById('xy-graph'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        { label: 'Completed', data: completedData, backgroundColor: '#28A745' },
                        { label: 'Pending', data: pendingData, backgroundColor: '#FFC107' }
                    ]
                },
                options: { scales: { x: { stacked: true }, y: { stacked: true } }, animation: { duration: 1000 } }
            });
            const completed = tasks.filter(t => t.completed).length;
            const pending = tasks.length - completed;
            new Chart(document.getElementById('pie-chart'), {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{ data: [completed, pending], backgroundColor: ['#28A745', '#FFC107'] }]
                },
                options: { responsive: true, animation: { animateScale: true } }
            });
        }

        // Export
        document.getElementById('export-tasks').addEventListener('click', () => {
            document.getElementById('export-popup').classList.remove('hidden');
        });
        document.getElementById('export-now').addEventListener('click', () => {
            const format = document.getElementById('export-format').value;
            const tasks = getTasks();
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Tasks', 10, 10);
                tasks.forEach((t, i) => {
                    doc.text(`${i + 1}. ${t.title} - ${t.dueDate} (${t.priority})`, 10, 20 + i * 10);
                });
                doc.save('tasks.pdf');
            } else if (format === 'excel') {
                const ws = XLSX.utils.json_to_sheet(tasks);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
                XLSX.writeFile(wb, 'tasks.xlsx');
            } else {
                const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tasks.json';
                a.click();
                URL.revokeObjectURL(url);
            }
            document.getElementById('export-popup').classList.add('hidden');
        });
        document.getElementById('cancel-export').addEventListener('click', () => {
            document.getElementById('export-popup').classList.add('hidden');
        });

        // Import
        document.getElementById('import-tasks').addEventListener('click', () => {
            document.getElementById('import-popup').classList.remove('hidden');
        });
        document.getElementById('import-now').addEventListener('click', () => {
            const file = document.getElementById('import-file').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const importedTasks = JSON.parse(e.target.result);
                    const tasks = getTasks();
                    importedTasks.forEach(t => {
                        if (!tasks.some(existing => existing.id === t.id)) tasks.push(t);
                    });
                    saveTasks(tasks);
                    renderTaskList();
                    addNotification(`${importedTasks.length} tasks imported`);
                    document.getElementById('import-popup').classList.add('hidden');
                };
                reader.readAsText(file);
            }
        });
        document.getElementById('cancel-import').addEventListener('click', () => {
            document.getElementById('import-popup').classList.add('hidden');
        });

        // Categories
        document.getElementById('manage-categories').addEventListener('click', () => {
            document.getElementById('categories-popup').classList.remove('hidden');
            const list = document.getElementById('category-list');
            list.innerHTML = '';
            getCategories().forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat;
                const del = document.createElement('button');
                del.textContent = 'Delete';
                del.style.background = '#DC3545';
                del.addEventListener('click', () => {
                    const categories = getCategories().filter(c => c !== cat);
                    saveCategories(categories);
                    loadFilters();
                    renderTaskList();
                    li.remove();
                });
                li.appendChild(del);
                list.appendChild(li);
            });
        });
        document.getElementById('add-category').addEventListener('click', () => {
            const cat = document.getElementById('new-category').value;
            if (cat) {
                const categories = getCategories();
                if (!categories.includes(cat)) {
                    categories.push(cat);
                    saveCategories(categories);
                    loadFilters();
                    renderTaskList();
                    document.getElementById('new-category').value = '';
                    document.getElementById('categories-popup').classList.add('hidden');
                }
            }
        });
        document.getElementById('close-categories').addEventListener('click', () => {
            document.getElementById('categories-popup').classList.add('hidden');
        });

        // Notifications
        function addNotification(message) {
            const notifications = getNotifications();
            notifications.push({ id: Date.now(), message, read: false });
            saveNotifications(notifications);
            updateNotificationCount();
            showToast(message);
        }
        function updateNotificationCount() {
            const unread = getNotifications().filter(n => !n.read).length;
            document.getElementById('notification-count').textContent = unread;
        }
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        document.querySelector('.notification-badge').addEventListener('click', () => {
            document.getElementById('notifications-popup').classList.remove('hidden');
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';
            getNotifications().forEach(n => {
                const li = document.createElement('li');
                li.textContent = n.message;
                if (!n.read) li.style.fontWeight = 'bold';
                list.appendChild(li);
            });
        });
        document.getElementById('mark-all-read').addEventListener('click', () => {
            const notifications = getNotifications().map(n => ({ ...n, read: true }));
            saveNotifications(notifications);
            updateNotificationCount();
            document.getElementById('notifications-popup').classList.add('hidden');
        });
        document.getElementById('close-notifications').addEventListener('click', () => {
            document.getElementById('notifications-popup').classList.add('hidden');
        });

        // Profile Picture
        function loadProfilePicture() {
            const user = getUsers().find(u => u.email === localStorage.getItem('currentUserEmail'));
            document.getElementById('profile-picture').src = user.profilePicture || `https://randomuser.me/api/portraits/men/${Math.floor(Math.random() * 100)}.jpg`;
        }

        // Initialization
        window.addEventListener('load', () => {
            const email = localStorage.getItem('currentUserEmail');
            if (email && getUsers().some(u => u.email === email)) {
                showDashboard();
            } else {
                showLogin();
            }
            const activeId = localStorage.getItem('activeTaskId');
            const start = localStorage.getItem('startTime');
            if (activeId && start) {
                activeTaskId = activeId;
                startTime = parseInt(start);
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
        });
    </script>
</body>
</html>
