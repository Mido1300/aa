<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced To-Do App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a040f"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            /* --- Light Mode --- */
            --lm-page-bg-start: #6a040f; /* Dark Red */
            --lm-page-bg-end: #9d0208;   /* Slightly Lighter Red */
            --lm-component-bg: #ffffff; /* WHITE component background */
            --lm-text: #212529;     /* DARK text */
            --lm-muted-text: #6c757d; /* Grayish text */
            --lm-border: #dee2e6;   /* Light gray border */
            --lm-input-bg: #f8f9fa;  /* Very light gray input bg */
            --lm-input-border: #ced4da; /* Standard input border */
            --lm-shadow-color: rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --lm-header-bg: #ffffff; /* White header */
            --lm-task-bg: #ffffff; /* White task item */
            --lm-task-selected-bg: #e9ecef; /* Light gray selected task */
            --lm-task-completed-bg: rgba(40, 167, 69, 0.08); /* Lighter green completed task */
            --lm-subtask-bg: #f8f9fa;
            --lm-primary: #007bff;  /* Standard Blue */
            --lm-secondary: #6c757d; /* Gray */
            --lm-success: #28a745;  /* Standard Green */
            --lm-danger: #dc3545;   /* Standard Red */
            --lm-warning: #ffc107;  /* Standard Yellow */
            --lm-info: #17a2b8;     /* Standard Teal */
            --lm-tag-high-bg: rgba(220, 53, 69, 0.1);
            --lm-tag-medium-bg: rgba(0, 123, 255, 0.1);
            --lm-tag-low-bg: rgba(108, 117, 125, 0.1);
            --lm-tag-high-text: var(--lm-danger);
            --lm-tag-medium-text: var(--lm-primary);
            --lm-tag-low-text: var(--lm-secondary);
            --lm-alert-expired-bg: rgba(220, 53, 69, 0.1);
            --lm-alert-expired-text: var(--lm-danger);
            --lm-alert-upcoming-bg: rgba(255, 193, 7, 0.1);
            --lm-alert-upcoming-text: #b58900; /* Darker yellow for text */

            /* --- Dark Mode --- */
            --dm-page-bg-start: #141414; /* Very dark gray */
            --dm-page-bg-end: #252525;   /* Slightly lighter gray */
            --dm-component-bg: #333; /* Dark component background */
            --dm-text: #e9ecef;     /* Light gray text */
            --dm-muted-text: #8b949e; /* GitHub Gray */
            --dm-border: #555;     /* Gray border */
            --dm-input-bg: #222;    /* Darker input bg */
            --dm-input-border: #555;
            --dm-shadow-color: rgba(0, 0, 0, 0.5);
            --dm-header-bg: #2a2a2a; /* Slightly different header bg */
            --dm-task-bg: #3a3a3a;   /* Task item bg */
            --dm-task-selected-bg: #4a4a4a; /* Darker gray selected task */
            --dm-task-completed-bg: rgba(86, 211, 100, 0.1); /* Darker green completed task */
            --dm-subtask-bg: #2c2c2c;
            --dm-primary: #58a6ff; /* Brighter Blue */
            --dm-secondary: #8b949e; /* GitHub Gray */
            --dm-success: #56d364; /* Brighter Green */
            --dm-danger: #f85149;  /* Brighter Red */
            --dm-warning: #e3b341; /* Brighter Yellow */
            --dm-info: #79c0ff;    /* Brighter Teal */
            --dm-tag-high-bg: rgba(248, 81, 73, 0.2);
            --dm-tag-medium-bg: rgba(88, 166, 255, 0.2);
            --dm-tag-low-bg: rgba(139, 148, 158, 0.2);
            --dm-tag-high-text: var(--dm-danger);
            --dm-tag-medium-text: var(--dm-primary);
            --dm-tag-low-text: var(--dm-secondary);
            --dm-alert-expired-bg: rgba(248, 81, 73, 0.2);
            --dm-alert-expired-text: var(--dm-danger);
            --dm-alert-upcoming-bg: rgba(227, 179, 65, 0.2);
            --dm-alert-upcoming-text: var(--dm-warning);

            /* --- General --- */
            --border-radius: 8px;
            --notification-bg: rgba(10, 10, 10, 0.9); /* Consistent dark notification */
            --notification-text: white;
        }

        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        html { font-size: 16px; }

        body {
            background: linear-gradient(135deg, var(--lm-page-bg-start), var(--lm-page-bg-end));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: var(--lm-text);
            overflow-x: hidden;
        }

        body.app-view {
            background: linear-gradient(135deg, var(--lm-page-bg-start), var(--lm-page-bg-end));
            padding: 0;
            display: block;
            align-items: normal;
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dm-page-bg-start), var(--dm-page-bg-end));
            color: var(--dm-text);
        }

        /* --- Component Styling (Defaults to Light Mode) --- */
        .login-container, .modal-content, header, .stat-card, .progress-item,
        .todo-section, .graph-item, .insight-card, .notification-list,
        .distribution-item {
            background-color: var(--lm-component-bg);
            border: 1px solid var(--lm-border);
            box-shadow: 0 4px 12px var(--lm-shadow-color);
            color: var(--lm-text);
            border-radius: var(--border-radius);
        }

        .task-item {
             background-color: var(--lm-task-bg);
             border: 1px solid var(--lm-border);
             box-shadow: 0 2px 5px var(--lm-shadow-color);
             color: var(--lm-text);
             border-left: 5px solid var(--lm-secondary); /* Default pending border */
             border-radius: var(--border-radius);
             position: relative; /* For alert positioning */
             padding-left: 1.5rem; /* Space for checkbox */
        }
        .task-item.selected {
            background-color: var(--lm-task-selected-bg);
            border-left-color: var(--lm-primary);
        }
        .task-item.completed {
             background-color: var(--lm-task-completed-bg);
             border-left-color: var(--lm-success);
        }
        .task-item.completed.selected {
             background-color: color-mix(in srgb, var(--lm-task-completed-bg), var(--lm-task-selected-bg));
             border-left-color: var(--lm-primary);
        }
        .task-item.pending { border-left-color: var(--lm-warning); }

        /* --- Dark Mode Component Overrides --- */
        body.dark-mode .login-container, body.dark-mode .modal-content, body.dark-mode .stat-card,
        body.dark-mode .progress-item, body.dark-mode .todo-section, body.dark-mode .graph-item,
        body.dark-mode .insight-card, body.dark-mode .notification-list,
        body.dark-mode .distribution-item {
             background-color: var(--dm-component-bg);
             border-color: var(--dm-border);
             box-shadow: 0 4px 12px var(--dm-shadow-color);
             color: var(--dm-text);
        }
        body.dark-mode header {
            background-color: var(--dm-header-bg);
            border-color: var(--dm-border);
            box-shadow: 0 4px 12px var(--dm-shadow-color);
            color: var(--dm-text);
        }
         body.dark-mode .task-item {
             background-color: var(--dm-task-bg);
             border-color: var(--dm-border);
             box-shadow: 0 2px 5px var(--dm-shadow-color);
             color: var(--dm-text);
             border-left-color: var(--dm-secondary);
         }
         body.dark-mode .task-item.selected {
            background-color: var(--dm-task-selected-bg);
            border-left-color: var(--dm-primary);
         }
         body.dark-mode .task-item.completed {
             background-color: var(--dm-task-completed-bg);
             border-left-color: var(--dm-success);
         }
         body.dark-mode .task-item.completed.selected {
             background-color: color-mix(in srgb, var(--dm-task-completed-bg), var(--dm-task-selected-bg));
             border-left-color: var(--dm-primary);
         }
         body.dark-mode .task-item.pending { border-left-color: var(--dm-warning); }

        /* --- Login & Modal Styles --- */
        .login-container { padding: 2rem; width: 100%; max-width: 450px; text-align: center; }
        .login-title { font-size: 1.75rem; margin-bottom: 1.5rem; color: inherit; }
        .input-group { margin-bottom: 1.25rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .input-group label { color: var(--dm-muted-text); }

        .input-field, .filter-select, .filter-date, .sort-select {
            width: 100%; padding: 0.75rem 1rem; border-radius: var(--border-radius);
            border: 1px solid var(--lm-input-border); font-size: 1rem; outline: none;
            background-color: var(--lm-input-bg); color: var(--lm-text); line-height: 1.5;
        }
        .input-field::placeholder, .filter-date::placeholder { color: var(--lm-muted-text); opacity: 0.7; }
        .input-field:focus, .filter-select:focus, .filter-date:focus, .sort-select:focus {
            border-color: var(--lm-primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        body.dark-mode .input-field, body.dark-mode .filter-select, body.dark-mode .filter-date, body.dark-mode .sort-select {
            background-color: var(--dm-input-bg); color: var(--dm-text); border-color: var(--dm-input-border);
        }
         body.dark-mode .input-field::placeholder, body.dark-mode .filter-date::placeholder { color: var(--dm-muted-text); opacity: 0.7; }
         body.dark-mode .input-field:focus, body.dark-mode .filter-select:focus, body.dark-mode .filter-date:focus, body.dark-mode .sort-select:focus {
            border-color: var(--dm-primary); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.25);
        }
        .flatpickr-input { cursor: pointer; }

        /* --- Button Styles --- */
        .btn {
            padding: 0.65rem 1.25rem; border: none; border-radius: var(--border-radius);
            font-size: 0.95rem; cursor: pointer; font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.5; text-align: center;
        }
        .btn i { margin-right: 0.5em; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        body.dark-mode .btn:disabled { background-color: #555; }

        /* Light Mode Buttons */
        .btn { background-color: var(--lm-primary); color: white; }
        .btn.btn-green { background-color: var(--lm-success); color: white; }
        .btn.btn-danger { background-color: var(--lm-danger); color: white; }
        #resetFiltersBtn { background-color: var(--lm-secondary); color: white; }
        header #logoutBtn { background-color: var(--lm-danger); color: white; }
        .modal-footer .btn:first-child { background-color: var(--lm-secondary); color: white; }

        /* Dark Mode Buttons */
        body.dark-mode .btn { background-color: var(--dm-primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        body.dark-mode .btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        body.dark-mode .btn:active { box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        body.dark-mode .btn.btn-green { background-color: var(--dm-success); color: white; }
        body.dark-mode .btn.btn-danger { background-color: var(--dm-danger); color: white; }
        body.dark-mode #resetFiltersBtn { background-color: var(--dm-secondary); color: white; }
        body.dark-mode header #logoutBtn { background-color: var(--dm-danger); color: white; }
        body.dark-mode .modal-footer .btn:first-child { background-color: var(--dm-secondary); color: white; }

        .btn-block { display: block; width: 100%; }
        .register-link { margin-top: 1.25rem; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .register-link { color: var(--dm-muted-text); }
        .register-link a { color: var(--lm-primary); text-decoration: none; font-weight: 500; }
        body.dark-mode .register-link a { color: var(--dm-primary); }
        .register-link a:hover { text-decoration: underline; }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center;
            backdrop-filter: blur(3px); padding: 1rem;
        }
        .modal-content {
            border-radius: var(--border-radius); padding: 1.5rem; width: 100%; max-width: 550px; /* Slightly wider for subtasks */
            max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-title { font-size: 1.4rem; margin-bottom: 1.5rem; text-align: center; font-weight: 600; color: inherit; }
        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* --- App Layout & Header --- */
        .app-container { display: none; width: 100%; min-height: 100vh; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; position: sticky; top: 0; z-index: 10;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--lm-primary); cursor: pointer; }
        body.dark-mode .logo { color: var(--dm-primary); }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .icon-btn {
            background: none; border: none; font-size: 1.25rem; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--lm-muted-text);
        }
        body.dark-mode .icon-btn { color: var(--dm-muted-text); }
        .icon-btn:hover { background-color: rgba(0, 0, 0, 0.05); color: var(--lm-primary); }
        body.dark-mode .icon-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--dm-primary); }

        /* --- Notifications --- */
        .notification-badge { position: relative; }
        .badge {
            position: absolute; top: 0px; right: 0px; color: white; font-size: 0.65rem;
            width: 18px; height: 18px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-weight: bold;
            background-color: var(--lm-danger); border: 2px solid var(--lm-header-bg);
        }
        body.dark-mode .badge { background-color: var(--dm-danger); border-color: var(--dm-header-bg); }
        .notification-list {
            display: none; position: absolute; top: 60px; right: 10px;
            border-radius: var(--border-radius); width: clamp(280px, 80vw, 320px);
            padding: 0.5rem 0; z-index: 20; max-height: 400px; overflow-y: auto;
        }
        .notification-item {
            padding: 0.75rem 1rem; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--lm-input-border); color: var(--lm-text);
        }
        .notification-item.unread { background-color: rgba(0, 123, 255, 0.08); font-weight: 500; }
        body.dark-mode .notification-item { border-bottom-color: var(--dm-input-border); color: var(--dm-text); }
        body.dark-mode .notification-item.unread { background-color: rgba(88, 166, 255, 0.15); }
        .notification-item:hover { background-color: rgba(0, 0, 0, 0.03); }
        body.dark-mode .notification-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .notification-item:last-child { border-bottom: none; }
        .notification-list-empty { padding: 1.25rem; text-align: center; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .notification-list-empty { color: var(--dm-muted-text); }
        #notification-popup-container { position: fixed; bottom: 1rem; left: 1rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem; max-width: 320px; }
        .notification-popup {
            background-color: var(--notification-bg); color: var(--notification-text); padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); font-size: 0.9rem;
            opacity: 0; transform: translateX(-110%); animation: slideInFadeOut 5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .notification-popup i { font-size: 1rem; flex-shrink: 0; }
        @keyframes slideInFadeOut { 0% { opacity: 0; transform: translateX(-110%); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(-110%); } }

        /* --- Main Content Area --- */
        .main-container { padding: 1.5rem; }
        .action-buttons { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .action-buttons-left { display: flex; gap: 1rem; flex-wrap: wrap; }
        .action-buttons-right { display: flex; gap: 1rem; flex-wrap: wrap; }
        #batchActionContainer { display: flex; gap: 0.5rem; } /* Initially hidden */
        #batchActionContainer .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }

        /* --- Stats & Progress --- */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .stat-card { border-radius: var(--border-radius); padding: 1.25rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.total { background: linear-gradient(135deg, var(--lm-primary), #0056b3); color: white; border: none; }
        .stat-card.completed { background: linear-gradient(135deg, var(--lm-success), #1e7e34); color: white; border: none; }
        .stat-card.pending { background: linear-gradient(135deg, var(--lm-warning), #d39e00); color: #212529; border: none; }
        body.dark-mode .stat-card.total { background: linear-gradient(135deg, var(--dm-primary), #3c8ce7); color: white; border: none; }
        body.dark-mode .stat-card.completed { background: linear-gradient(135deg, var(--dm-success), #38c172); color: white; border: none; }
        body.dark-mode .stat-card.pending { background: linear-gradient(135deg, var(--dm-warning), #f7c74c); color: #212529; border: none; }
        .stat-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; color: inherit; opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: inherit; }

        .progress-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .progress-item { border-radius: var(--border-radius); padding: 1.25rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .progress-item:hover { transform: translateY(-5px); }
        .progress-title { margin-bottom: 0.5rem; font-weight: 500; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .progress-title { color: var(--dm-muted-text); }
        .progress-value { font-size: 1.5rem; font-weight: 700; color: var(--lm-primary); }
        body.dark-mode .progress-value { color: var(--dm-primary); }

        /* --- To-Do Section --- */
        .todo-section { border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; }
        .todo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; border-bottom: 1px solid var(--lm-input-border); padding-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        body.dark-mode .todo-header { border-bottom-color: var(--dm-input-border); }
        .todo-header h2 { font-size: 1.5rem; font-weight: 600; color: black; margin: 0; }
        body.dark-mode .todo-header h2 { color: var(--dm-text); }
        .view-toggle { display: flex; gap: 0.5rem; }
        .view-toggle .btn {
             background-color: var(--lm-input-bg); color: var(--lm-secondary); padding: 0.5rem 1rem;
             font-size: 0.85rem; font-weight: 500; text-transform: none; letter-spacing: 0;
             box-shadow: none; border: 1px solid var(--lm-border);
        }
        .view-toggle .btn:hover { background-color: #e9ecef; border-color: var(--lm-primary); color: var(--lm-primary); }
        body.dark-mode .view-toggle .btn { background-color: rgba(255, 255, 255, 0.1); color: var(--dm-secondary); border-color: var(--dm-border); }
        body.dark-mode .view-toggle .btn:hover { background-color: rgba(255, 255, 255, 0.15); border-color: var(--dm-primary); color: var(--dm-primary); }

        /* --- Filters & Sorting --- */
        .filters-container { margin-bottom: 1.5rem; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
        .filter-group {}
        .filter-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--lm-muted-text); }
        body.dark-mode .filter-label { color: var(--dm-muted-text); }
        .filter-select, .filter-date, .sort-select { padding: 0.65rem 0.75rem; font-size: 0.95rem; }
        .filter-actions { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .sort-group { flex-grow: 1; max-width: 250px; } /* Limit sort width */

        /* --- Tasks List --- */
        .tasks-container {}
        .task-list { list-style-type: none; }
        .task-item {
            display: flex; justify-content: space-between; align-items: flex-start; /* Align items top */
            padding: 1rem; border-radius: var(--border-radius); margin-bottom: 0.75rem;
            transition: background-color 0.3s ease, border-left-color 0.3s ease;
        }
        .task-item-main { display: flex; flex-grow: 1; align-items: flex-start; }
        .task-checkbox-container { margin-right: 0.75rem; padding-top: 0.15rem; /* Align checkbox slightly */ }
        .task-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--lm-primary); }
        body.dark-mode .task-checkbox { accent-color: var(--dm-primary); }

        .task-info { flex: 1; margin-right: 1rem; overflow: hidden; }
        .task-title { font-weight: 600; margin-bottom: 0.25rem; color: inherit; transition: color 0.3s ease, text-decoration 0.3s ease; font-size: 1rem; }
        .task-item.completed .task-title { text-decoration: line-through; color: var(--lm-muted-text); }
        body.dark-mode .task-item.completed .task-title { color: var(--dm-muted-text); }

        .task-details { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; font-size: 0.8rem; color: var(--lm-muted-text); margin-bottom: 0.5rem; }
        body.dark-mode .task-details { color: var(--dm-muted-text); }
        .task-detail { display: flex; align-items: center; gap: 0.25rem; }
        .task-detail i { font-size: 0.75rem; opacity: 0.8; }

        .task-description { font-size: 0.85rem; color: var(--lm-muted-text); margin-top: 0.3rem; line-height: 1.4; word-break: break-word; }
        body.dark-mode .task-description { color: var(--dm-muted-text); }

        .task-actions { display: flex; gap: 0.25rem; align-items: center; flex-shrink: 0; /* Prevent shrinking */ padding-top: 0.1rem; /* Align with title */ }
        .task-actions .icon-btn { background-color: rgba(0, 0, 0, 0.03); color: var(--lm-muted-text); width: 32px; height: 32px; font-size: 0.9rem; } /* Smaller action buttons */
        .task-actions .icon-btn:hover { background-color: rgba(0, 0, 0, 0.06); color: var(--lm-primary); }
        .task-actions .delete-btn:hover { color: var(--lm-danger); }
        .task-actions .timer-btn:hover { color: var(--lm-info); }
        .task-actions .timer-btn.active { color: var(--lm-success); background-color: rgba(40, 167, 69, 0.1); } /* Active timer style */
        body.dark-mode .task-actions .icon-btn { background-color: rgba(255, 255, 255, 0.08); color: var(--dm-muted-text); }
        body.dark-mode .task-actions .icon-btn:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--dm-primary); }
        body.dark-mode .task-actions .delete-btn:hover { color: var(--dm-danger); }
        body.dark-mode .task-actions .timer-btn:hover { color: var(--dm-info); }
        body.dark-mode .task-actions .timer-btn.active { color: var(--dm-success); background-color: rgba(86, 211, 100, 0.15); }

        .toggle-switch { position: relative; width: 40px; height: 22px; margin-right: 0.5rem; } /* Slightly smaller toggle */
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 22px; }
        body.dark-mode .slider { background-color: #555; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: 0.4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--lm-success); }
        body.dark-mode input:checked + .slider { background-color: var(--dm-success); }
        input:checked + .slider:before { transform: translateX(18px); } /* Adjusted translation */

        .tag { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; border: 1px solid transparent; }
        .tag-high { background-color: var(--lm-tag-high-bg); color: var(--lm-tag-high-text); border-color: var(--lm-danger); }
        .tag-medium { background-color: var(--lm-tag-medium-bg); color: var(--lm-tag-medium-text); border-color: var(--lm-primary); }
        .tag-low { background-color: var(--lm-tag-low-bg); color: var(--lm-tag-low-text); border-color: var(--lm-secondary); }
        body.dark-mode .tag-high { background-color: var(--dm-tag-high-bg); color: var(--dm-tag-high-text); border-color: var(--dm-danger); }
        body.dark-mode .tag-medium { background-color: var(--dm-tag-medium-bg); color: var(--dm-tag-medium-text); border-color: var(--dm-primary); }
        body.dark-mode .tag-low { background-color: var(--dm-tag-low-bg); color: var(--dm-tag-low-text); border-color: var(--dm-secondary); }

        .due-date-alert {
            padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600;
            text-transform: uppercase; margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.2rem;
        }
        .alert-expired { background-color: var(--lm-alert-expired-bg); color: var(--lm-alert-expired-text); border: 1px solid var(--lm-alert-expired-text); }
        .alert-upcoming { background-color: var(--lm-alert-upcoming-bg); color: var(--lm-alert-upcoming-text); border: 1px solid var(--lm-alert-upcoming-text); }
        body.dark-mode .alert-expired { background-color: var(--dm-alert-expired-bg); color: var(--dm-alert-expired-text); border-color: var(--dm-alert-expired-text); }
        body.dark-mode .alert-upcoming { background-color: var(--dm-alert-upcoming-bg); color: var(--dm-alert-upcoming-text); border-color: var(--dm-alert-upcoming-text); }

        /* --- Subtasks --- */
        .subtasks-container { margin-top: 0.75rem; padding-left: 1.5rem; border-left: 2px solid var(--lm-border); }
        body.dark-mode .subtasks-container { border-left-color: var(--dm-border); }
        .subtask-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; padding: 0.25rem 0; color: var(--lm-muted-text); }
        body.dark-mode .subtask-item { color: var(--dm-muted-text); }
        .subtask-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; accent-color: var(--lm-secondary); }
        body.dark-mode .subtask-item input[type="checkbox"] { accent-color: var(--dm-secondary); }
        .subtask-item.completed span { text-decoration: line-through; opacity: 0.7; }
        .subtask-item span { flex-grow: 1; }

        /* Modal Subtask Input */
        .subtask-input-area { margin-top: 1rem; }
        .subtask-input-area label { font-weight: 500; font-size: 0.9rem; color: var(--lm-muted-text); }
        body.dark-mode .subtask-input-area label { color: var(--dm-muted-text); }
        .subtask-list-editor { list-style: none; padding: 0; margin-top: 0.5rem; max-height: 150px; overflow-y: auto; border: 1px solid var(--lm-input-border); border-radius: var(--border-radius); padding: 0.5rem; background-color: var(--lm-input-bg); }
        body.dark-mode .subtask-list-editor { border-color: var(--dm-input-border); background-color: var(--dm-input-bg); }
        .subtask-editor-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .subtask-editor-item input[type="text"] { flex-grow: 1; padding: 0.4rem 0.6rem; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 4px; background-color: var(--lm-component-bg); color: var(--lm-text); }
        body.dark-mode .subtask-editor-item input[type="text"] { background-color: var(--dm-component-bg); color: var(--dm-text); border-color: var(--dm-border); }
        .subtask-editor-item .remove-subtask-btn { background: none; border: none; color: var(--lm-danger); cursor: pointer; font-size: 1rem; padding: 0.2rem; }
        body.dark-mode .subtask-editor-item .remove-subtask-btn { color: var(--dm-danger); }
        .add-subtask-btn {
            margin-top: 0.5rem; background: none; border: 1px dashed var(--lm-secondary); color: var(--lm-secondary);
            padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;
        }
        body.dark-mode .add-subtask-btn { border-color: var(--dm-secondary); color: var(--dm-secondary); }
        .add-subtask-btn:hover { background-color: rgba(0,0,0,0.05); color: var(--lm-primary); border-color: var(--lm-primary); }
        body.dark-mode .add-subtask-btn:hover { background-color: rgba(255,255,255,0.1); color: var(--dm-primary); border-color: var(--dm-primary); }

        /* --- Time Tracking --- */
        .time-tracked-display { font-size: 0.75rem; color: var(--lm-info); margin-left: 0.5rem; font-weight: 500; }
        body.dark-mode .time-tracked-display { color: var(--dm-info); }

        /* --- Graph & Insights --- */
        .graph-container { min-height: 350px; display: none; flex-direction: row; gap: 1.5rem; flex-wrap: wrap; justify-content: space-around; margin-top: 1.25rem; }
        .graph-item { flex: 1 1 45%; min-width: 280px; border-radius: var(--border-radius); padding: 1.25rem; display: flex; justify-content: center; align-items: center; }
        .graph-item canvas { max-width: 100%; max-height: 300px; }

        .insights-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .insight-card { border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .insight-title { font-size: 1.1rem; margin-bottom: 1.25rem; text-align: center; width: 100%; font-weight: 600; color: inherit; }
        .chart-container { height: 250px; width: 100%; position: relative; }

        .task-distribution { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; width: 100%; }
        .distribution-item { border-radius: var(--border-radius); padding: 1rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .distribution-item:hover { transform: translateY(-3px); }
        .distribution-title { font-weight: 500; margin-bottom: 0.25rem; font-size: 0.8rem; color: var(--lm-muted-text); }
        body.dark-mode .distribution-title { color: var(--dm-muted-text); }
        .distribution-count { font-size: 1.25rem; font-weight: 700; color: var(--lm-primary); }
        body.dark-mode .distribution-count { color: var(--dm-primary); }

        /* --- General Utilities --- */
        .no-tasks { color: var(--lm-muted-text) !important; text-align: center; padding: 2rem; font-style: italic; }
        body.dark-mode .no-tasks { color: var(--dm-muted-text) !important; }
        #fileUploadContainer { display: flex; flex-direction: column; align-items: center; }
        #fileUpload { width: auto; }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #aaa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        body.dark-mode ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        body.dark-mode ::-webkit-scrollbar-thumb { background: #666; }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) {
             .graph-container { flex-direction: column; align-items: center; }
             .graph-item { flex-basis: 90%; min-width: 0; }
             .insights-container { grid-template-columns: 1fr; }
             .main-container { padding: 1.5rem; }
             header { padding: 0.75rem 1.5rem; }
             .action-buttons { flex-direction: column; align-items: flex-start; } /* Stack action buttons */
             .action-buttons-right { justify-content: flex-start; margin-top: 0.5rem; }
        }

        @media (max-width: 768px) {
            html { font-size: 15px; }
            header { padding: 0.75rem 1rem; }
            .main-container { padding: 1rem; }
            .stats-container, .progress-container, .filters-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
            .task-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; padding-left: 0.75rem; } /* Adjust padding */
            .task-item-main { width: 100%; } /* Ensure main content takes full width */
            .task-checkbox-container { position: absolute; left: 0.75rem; top: 0.75rem; margin-right: 0; } /* Position checkbox absolutely */
            .task-item-main { padding-left: 2rem; } /* Add padding to content to avoid checkbox */
            .task-actions { width: 100%; justify-content: flex-end; margin-top: 0.5rem; padding-left: 2rem; /* Align actions */ }
            .todo-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .view-toggle { width: 100%; justify-content: flex-start; }
            .modal-content { width: 95%; padding: 1.25rem; }
            .login-container { padding: 1.5rem; }
            .filters-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            .filter-actions { flex-direction: column; align-items: stretch; } /* Stack filter actions */
            .sort-group { max-width: none; }
        }

        @media (max-width: 480px) {
            html { font-size: 14px; }
            .logo { font-size: 1.25rem; }
            .header-actions .btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
            .header-actions { gap: 0.5rem; }
            .icon-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            .badge { width: 16px; height: 16px; font-size: 0.6rem; }
            .stat-value { font-size: 1.5rem; }
            .progress-value { font-size: 1.25rem; }
            .stats-container, .progress-container { grid-template-columns: 1fr; }
            .notification-list { width: calc(100% - 2rem); right: 1rem; top: 55px; }
            #notification-popup-container { left: 0.5rem; right: 0.5rem; bottom: 0.5rem; align-items: center; max-width: none; }
            .notification-popup { width: 100%; max-width: 300px; animation: fadeInFadeOutMobile 5s forwards; }
            @keyframes fadeInFadeOutMobile { 0% { opacity: 0; transform: translateY(50px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(50px); } }
            .action-buttons-left .btn, .action-buttons-right .btn { flex-grow: 1; font-size: 0.9rem; }
            .filters-grid { grid-template-columns: 1fr; }
            .task-details { font-size: 0.75rem; }
            .tag { font-size: 0.65rem; padding: 0.2rem 0.5rem; }
            .due-date-alert { font-size: 0.6rem; padding: 0.15rem 0.4rem; }
            .task-actions { padding-left: 0; /* Reset padding for actions on smallest screens */ }
             .task-item-main { padding-left: 2rem; }
        }

        /* --- Flatpickr Theme Adjustments --- */
        .flatpickr-calendar { background: var(--lm-component-bg); border-radius: var(--border-radius); box-shadow: 0 5px 15px var(--lm-shadow-color); border: 1px solid var(--lm-border); width: auto; }
        body.dark-mode .flatpickr-calendar { background: var(--dm-component-bg); box-shadow: 0 5px 15px var(--dm-shadow-color); border-color: var(--dm-border); }
        .flatpickr-months .flatpickr-month, .flatpickr-weekdays { background: var(--lm-input-bg); border-bottom: 1px solid var(--lm-border); }
        body.dark-mode .flatpickr-months .flatpickr-month, body.dark-mode .flatpickr-weekdays { background: var(--dm-input-bg); border-bottom-color: var(--dm-border); }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month, span.flatpickr-weekday { color: var(--lm-muted-text); }
        body.dark-mode .flatpickr-months .flatpickr-prev-month, body.dark-mode .flatpickr-months .flatpickr-next-month, body.dark-mode span.flatpickr-weekday { color: var(--dm-muted-text); }
        .flatpickr-months .flatpickr-prev-month:hover svg, .flatpickr-months .flatpickr-next-month:hover svg { fill: var(--lm-primary); }
        body.dark-mode .flatpickr-months .flatpickr-prev-month:hover svg, body.dark-mode .flatpickr-months .flatpickr-next-month:hover svg { fill: var(--dm-primary); }
        .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month input.cur-year { color: var(--lm-text); font-weight: bold; }
        body.dark-mode .flatpickr-current-month .flatpickr-monthDropdown-months, body.dark-mode .flatpickr-current-month input.cur-year { color: var(--dm-text); }
        .flatpickr-day { color: var(--lm-text); border-color: transparent; }
        body.dark-mode .flatpickr-day { color: var(--dm-text); }
        .flatpickr-day:hover, .flatpickr-day.prevMonthDay:hover, .flatpickr-day.nextMonthDay:hover { background: var(--lm-input-bg); border-color: var(--lm-primary); color: var(--lm-primary); }
        body.dark-mode .flatpickr-day:hover, body.dark-mode .flatpickr-day.prevMonthDay:hover, body.dark-mode .flatpickr-day.nextMonthDay:hover { background: var(--dm-input-bg); border-color: var(--dm-primary); color: var(--dm-primary); }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover { background: var(--lm-primary); border-color: var(--lm-primary); color: white; }
        body.dark-mode .flatpickr-day.selected, body.dark-mode .flatpickr-day.startRange, body.dark-mode .flatpickr-day.endRange, body.dark-mode .flatpickr-day.selected:hover, body.dark-mode .flatpickr-day.startRange:hover, body.dark-mode .flatpickr-day.endRange:hover { background: var(--dm-primary); border-color: var(--dm-primary); color: white; }
        .flatpickr-day.inRange { background: rgba(0, 123, 255, 0.1); box-shadow: -5px 0 0 rgba(0, 123, 255, 0.1), 5px 0 0 rgba(0, 123, 255, 0.1); border-color: transparent; }
        body.dark-mode .flatpickr-day.inRange { background: rgba(88, 166, 255, 0.15); box-shadow: -5px 0 0 rgba(88, 166, 255, 0.15), 5px 0 0 rgba(88, 166, 255, 0.15); }
        .flatpickr-day.flatpickr-disabled, .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: var(--lm-muted-text); opacity: 0.6; }
        body.dark-mode .flatpickr-day.flatpickr-disabled, body.dark-mode .flatpickr-day.prevMonthDay, body.dark-mode .flatpickr-day.nextMonthDay { color: var(--dm-muted-text); }

    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h1 class="login-title">Welcome Back!</h1>
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="input-field" placeholder="Enter your email" value="test@example.com">
        </div>
        <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" placeholder="Enter your password" value="password123">
        </div>
        <button class="btn btn-block" id="loginBtn">Login</button>
        <p class="register-link">Don't have an account? <a id="registerLink">Register</a></p>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title">Create an Account</h2>
            <div class="input-group"> <label for="regName">Full Name</label> <input type="text" id="regName" class="input-field" placeholder="Enter your full name"> </div>
             <div class="input-group"> <label for="regEmail">Email</label> <input type="email" id="regEmail" class="input-field" placeholder="Enter your email"> </div>
             <div class="input-group"> <label for="regEmailConfirm">Confirm Email</label> <input type="email" id="regEmailConfirm" class="input-field" placeholder="Confirm your email"> </div>
             <div class="input-group"> <label for="regPassword">Password</label> <input type="password" id="regPassword" class="input-field" placeholder="Enter your password"> </div>
             <div class="input-group"> <label for="regPasswordConfirm">Confirm Password</label> <input type="password" id="regPasswordConfirm" class="input-field" placeholder="Confirm your password"> </div>
             <div class="input-group"> <label for="regCountry">Country</label> <select id="regCountry" class="input-field"> <option value="">Select country</option> <option value="USA">United States</option> <option value="EG">Egypt</option> </select> </div>
            <div class="modal-footer">
                <button class="btn" id="cancelRegisterBtn">Cancel</button>
                <button class="btn btn-green" id="submitRegisterBtn">Register</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Create a New Task</h2>
            <div class="input-group">
                <label for="taskTitle">Task Title *</label>
                <input type="text" id="taskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="taskDetails">Add More Details</label>
                <textarea id="taskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea>
            </div>
            <div class="subtask-input-area">
                <label>Subtasks / Checklist</label>
                <ul class="subtask-list-editor" id="subtaskListEditorAdd">
                    </ul>
                <button class="add-subtask-btn" id="addSubtaskBtnAdd"><i class="fas fa-plus"></i> Add Subtask</button>
            </div>
            <div class="input-group">
                <label for="taskCategory">Task Category</label>
                 <select id="taskCategory" class="input-field"> <option value="">Select category</option> <option value="Work">Work</option> <option value="Personal">Personal</option> <option value="Shopping">Shopping</option> <option value="Health">Health</option> <option value="Education">Education</option> <option value="Finance">Finance</option> <option value="Home">Home</option> <option value="Other">Other</option> </select>
            </div>
            <div class="input-group">
                <label for="taskPriority">Priority</label>
                 <select id="taskPriority" class="input-field"> <option value="High">High</option> <option value="Medium" selected>Medium</option> <option value="Low">Low</option> </select>
            </div>
            <div class="input-group">
                <label for="taskDueDate">Due Date</label>
                <input type="text" id="taskDueDate" class="input-field flatpickr-input" placeholder="Select date">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelTaskBtn">Cancel</button>
                <button class="btn btn-green" id="createTaskBtn">Create Task</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Edit Task</h2>
             <input type="hidden" id="editTaskId">
            <div class="input-group">
                <label for="editTaskTitle">Task Title *</label>
                <input type="text" id="editTaskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="editTaskDetails">Add More Details</label>
                <textarea id="editTaskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea>
            </div>
            <div class="subtask-input-area">
                <label>Subtasks / Checklist</label>
                <ul class="subtask-list-editor" id="subtaskListEditorEdit">
                    </ul>
                <button class="add-subtask-btn" id="addSubtaskBtnEdit"><i class="fas fa-plus"></i> Add Subtask</button>
            </div>
            <div class="input-group">
                <label for="editTaskCategory">Task Category</label>
                 <select id="editTaskCategory" class="input-field"> <option value="">Select category</option> <option value="Work">Work</option> <option value="Personal">Personal</option> <option value="Shopping">Shopping</option> <option value="Health">Health</option> <option value="Education">Education</option> <option value="Finance">Finance</option> <option value="Home">Home</option> <option value="Other">Other</option> </select>
            </div>
            <div class="input-group">
                <label for="editTaskPriority">Priority</label>
                 <select id="editTaskPriority" class="input-field"> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select>
            </div>
            <div class="input-group">
                <label for="editTaskDueDate">Due Date</label>
                <input type="text" id="editTaskDueDate" class="input-field flatpickr-input" placeholder="Select date">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelEditTaskBtn">Cancel</button>
                <button class="btn btn-green" id="saveTaskBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Deletion</h2>
            <p>Are you sure you want to delete the task: "<strong id="deleteTaskTitle"></strong>"?</p>
            <div class="modal-footer">
                <button class="btn" id="cancelDeleteBtn">No, Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteSelectedConfirmModal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Batch Deletion</h2>
            <p>Are you sure you want to delete the <strong id="deleteSelectedCount"></strong> selected task(s)?</p>
            <div class="modal-footer">
                <button class="btn" id="cancelDeleteSelectedBtn">No, Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteSelectedBtn">Yes, Delete Selected</button>
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal"> <div class="modal-content"> <h2 class="modal-title">Export Tasks</h2> <p>Choose a format to export your tasks:</p> <div class="input-group"> <label for="exportFormat">Export Format</label> <select id="exportFormat" class="input-field"> <option value="csv">CSV</option> <option value="json">JSON</option> </select> </div> <div class="modal-footer"> <button class="btn" id="cancelExportBtn">Cancel</button> <button class="btn btn-green" id="confirmExportBtn">Export</button> </div> </div> </div>
    <div class="modal" id="importModal"> <div class="modal-content"> <h2 class="modal-title">Import Tasks</h2> <div class="input-group"> <label>Import Method</label> <div> <button class="btn" id="importFileBtn" style="margin-right: 10px;">From File (.csv, .json)</button> </div> </div> <div class="input-group" id="fileUploadContainer"> <label for="fileUpload">Select File</label> <input type="file" id="fileUpload" class="input-field" accept=".csv,.json"> </div> <div class="modal-footer"> <button class="btn" id="cancelImportBtn">Cancel</button> <button class="btn btn-green" id="confirmImportBtn">Import</button> </div> </div> </div>

    <div class="app-container" id="appContainer">
        <header>
            <div class="logo" id="refreshLogo" title="Refresh View">ProTask</div>
            <div class="header-actions">
                <button class="icon-btn notification-badge" id="notificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </button>
                <div class="notification-list" id="notificationList">
                    </div>
                <button class="icon-btn" id="themeToggleBtn" title="Toggle Theme">
                    <i class="fas fa-moon"></i> </button>
                <button class="btn" id="logoutBtn">Logout</button>
            </div>
        </header>

        <div class="main-container">
            <div class="action-buttons">
                <div class="action-buttons-left">
                    <button class="btn btn-green" id="addTaskBtn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                     <div id="batchActionContainer" style="display: none;">
                         <button class="btn btn-danger" id="deleteSelectedBtn">
                             <i class="fas fa-trash-alt"></i> Delete Selected
                         </button>
                         </div>
                </div>
                <div class="action-buttons-right">
                    <button class="btn" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="btn" id="importBtn">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card total"> <div class="stat-title">Total Tasks</div> <div class="stat-value" id="totalTasksStat">0</div> </div>
                <div class="stat-card completed"> <div class="stat-title">Completed</div> <div class="stat-value" id="completedTasksStat">0</div> </div>
                <div class="stat-card pending"> <div class="stat-title">Pending</div> <div class="stat-value" id="pendingTasksStat">0</div> </div>
            </div>
            <div class="progress-container">
                <div class="progress-item"> <div class="progress-title">Today</div> <div class="progress-value" id="progressToday">0%</div> </div>
                <div class="progress-item"> <div class="progress-title">This Week</div> <div class="progress-value" id="progressWeek">0%</div> </div>
                <div class="progress-item"> <div class="progress-title">This Month</div> <div class="progress-value" id="progressMonth">0%</div> </div>
                <div class="progress-item"> <div class="progress-title">Overall</div> <div class="progress-value" id="progressOverall">0%</div> </div>
            </div>

            <div class="todo-section">
                <div class="todo-header">
                    <h2>Tasks</h2>
                    <div class="view-toggle">
                        <button class="btn" id="listViewBtn">List View</button>
                        <button class="btn" id="graphViewBtn">Graph View</button>
                    </div>
                </div>

                <div class="filters-container">
                    <div class="filters-grid">
                        <div class="filter-group"> <label class="filter-label" for="statusFilter">Status</label> <select class="filter-select" id="statusFilter"> <option value="all">All</option> <option value="Completed">Completed</option> <option value="Pending">Pending</option> </select> </div>
                        <div class="filter-group"> <label class="filter-label" for="dateFilter">Date Filter</label> <select class="filter-select" id="dateFilter"> <option value="all">All Time</option> <option value="today">Today</option> <option value="week">This Week</option> <option value="month">This Month</option> <option value="custom">Custom Range</option> </select> </div>
                        <div class="filter-group custom-date-filter" id="customDateFilterGroup" style="display: none;"> <label class="filter-label">Custom Date Range</label> <div style="display: flex; gap: 10px;"> <input type="text" id="customStartDate" class="filter-date flatpickr-input" placeholder="Start"> <input type="text" id="customEndDate" class="filter-date flatpickr-input" placeholder="End"> </div> </div>
                        <div class="filter-group"> <label class="filter-label" for="categoryFilter">Categories</label> <select class="filter-select" id="categoryFilter"> <option value="all">All</option> <option value="Work">Work</option> <option value="Personal">Personal</option> <option value="Shopping">Shopping</option> <option value="Health">Health</option> <option value="Education">Education</option> <option value="Finance">Finance</option> <option value="Home">Home</option> <option value="Other">Other</option> </select> </div>
                        <div class="filter-group"> <label class="filter-label" for="priorityFilter">Priority</label> <select class="filter-select" id="priorityFilter"> <option value="all">All</option> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select> </div>
                    </div>
                    <div class="filter-actions">
                         <div class="sort-group">
                             <label class="filter-label" for="sortTasks">Sort By</label>
                             <select class="sort-select" id="sortTasks">
                                 <option value="dateCreated-asc">Date Created (Oldest)</option>
                                 <option value="dateCreated-desc">Date Created (Newest)</option>
                                 <option value="dueDate-asc">Due Date (Soonest)</option>
                                 <option value="dueDate-desc">Due Date (Latest)</option>
                                 <option value="priority-desc">Priority (High First)</option>
                                 <option value="priority-asc">Priority (Low First)</option>
                                 <option value="title-asc">Title (A-Z)</option>
                                 <option value="title-desc">Title (Z-A)</option>
                             </select>
                         </div>
                        <button class="btn" id="resetFiltersBtn">Reset Filters</button>
                    </div>
                </div>

                <div class="tasks-container" id="tasksContainer">
                    <ul class="task-list" id="taskList">
                        <li class="no-tasks">Loading tasks...</li> </ul>
                </div>
                <div class="graph-container" id="graphContainer">
                    <div class="graph-item"> <canvas id="taskStatusChart"></canvas> </div>
                    <div class="graph-item"> <canvas id="taskPriorityChart"></canvas> </div>
                </div>
            </div>

            <div class="insights-container">
                <div class="insight-card"> <h3 class="insight-title">Task Completion Rate</h3> <div class="chart-container"> <canvas id="completionChart"></canvas> </div> </div>
                <div class="insight-card"> <h3 class="insight-title">Task Distribution</h3> <div class="task-distribution"> <div class="distribution-item"> <div class="distribution-title">High Priority</div> <div class="distribution-count" id="highPriorityCount">0</div> </div> <div class="distribution-item"> <div class="distribution-title">Medium Priority</div> <div class="distribution-count" id="mediumPriorityCount">0</div> </div> <div class="distribution-item"> <div class="distribution-title">Low Priority</div> <div class="distribution-count" id="lowPriorityCount">0</div> </div> </div> </div>
            </div>
        </div> </div> <div id="notification-popup-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            // (Keep existing element references)
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const registerLink = document.getElementById('registerLink');
            const registerModal = document.getElementById('registerModal');
            const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
            const submitRegisterBtn = document.getElementById('submitRegisterBtn');
            const loginBtn = document.getElementById('loginBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const logoutBtn = document.getElementById('logoutBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const addTaskModal = document.getElementById('addTaskModal');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            const createTaskBtn = document.getElementById('createTaskBtn');
            const taskDueDateInput = document.getElementById('taskDueDate');
            const editTaskModal = document.getElementById('editTaskModal');
            const cancelEditTaskBtn = document.getElementById('cancelEditTaskBtn');
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            const editTaskDueDateInput = document.getElementById('editTaskDueDate');
            const editTaskIdInput = document.getElementById('editTaskId');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteTaskTitle = document.getElementById('deleteTaskTitle');
            const customStartDateInput = document.getElementById('customStartDate');
            const customEndDateInput = document.getElementById('customEndDate');
            const customDateFilterGroup = document.getElementById('customDateFilterGroup');
            const listViewBtn = document.getElementById('listViewBtn');
            const graphViewBtn = document.getElementById('graphViewBtn');
            const tasksContainer = document.getElementById('tasksContainer');
            const graphContainer = document.getElementById('graphContainer');
            const exportBtn = document.getElementById('exportBtn');
            const exportModal = document.getElementById('exportModal');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('importModal');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const fileUploadInput = document.getElementById('fileUpload');
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationList = document.getElementById('notificationList');
            const notificationCountBadge = document.getElementById('notificationCount');
            const notificationPopupContainer = document.getElementById('notification-popup-container');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const taskList = document.getElementById('taskList');
            const refreshLogo = document.getElementById('refreshLogo');
            const totalTasksStat = document.getElementById('totalTasksStat');
            const completedTasksStat = document.getElementById('completedTasksStat');
            const pendingTasksStat = document.getElementById('pendingTasksStat');
            const progressToday = document.getElementById('progressToday');
            const progressWeek = document.getElementById('progressWeek');
            const progressMonth = document.getElementById('progressMonth');
            const progressOverall = document.getElementById('progressOverall');
            const highPriorityCount = document.getElementById('highPriorityCount');
            const mediumPriorityCount = document.getElementById('mediumPriorityCount');
            const lowPriorityCount = document.getElementById('lowPriorityCount');

            // New Elements
            const sortTasksSelect = document.getElementById('sortTasks');
            const batchActionContainer = document.getElementById('batchActionContainer');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const deleteSelectedConfirmModal = document.getElementById('deleteSelectedConfirmModal');
            const cancelDeleteSelectedBtn = document.getElementById('cancelDeleteSelectedBtn');
            const confirmDeleteSelectedBtn = document.getElementById('confirmDeleteSelectedBtn');
            const deleteSelectedCount = document.getElementById('deleteSelectedCount');
            const subtaskListEditorAdd = document.getElementById('subtaskListEditorAdd');
            const addSubtaskBtnAdd = document.getElementById('addSubtaskBtnAdd');
            const subtaskListEditorEdit = document.getElementById('subtaskListEditorEdit');
            const addSubtaskBtnEdit = document.getElementById('addSubtaskBtnEdit');


            // --- State Variables ---
            let tasks = []; // Structure: { id, title, details, status, category, priority, dueDate, selected, dateCreated, subtasks: [{text, completed}], timeTracked, isTracking }
            let notifications = [];
            let currentTaskIdToDelete = null;
            let flatpickrInstances = {};
            let activeTimers = {}; // { taskId: intervalId }

            // Chart instances
            let taskStatusChart, taskPriorityChart, completionChart;

            // --- Constants ---
            const UPCOMING_THRESHOLD_DAYS = 10; // Days for "Upcoming" alert

            // --- Initialization ---
            loadTasks();
            loadNotifications();
            checkLoginStatus();
            initializeFlatpickr();
            applyInitialTheme();
            registerServiceWorker(); // Attempt PWA registration
            renderAll(); // Initial render after setup

            // --- Functions ---

            // Local Storage Handling (Updated for new structure)
            function saveTasks() {
                // Stop any active timers before saving to avoid saving 'isTracking: true' incorrectly
                tasks.forEach(task => task.isTracking = false);
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }

            function loadTasks() {
                const storedTasks = localStorage.getItem('tasks');
                tasks = storedTasks ? JSON.parse(storedTasks) : getDefaultTasks();
                // Data migration/validation for older formats or missing fields
                tasks = tasks.map(task => ({
                    id: task.id || Date.now() + Math.random(), // Ensure ID
                    title: task.title || 'Untitled Task',
                    details: task.details || '',
                    status: ['Pending', 'Completed'].includes(task.status) ? task.status : 'Pending',
                    category: task.category || '',
                    priority: ['High', 'Medium', 'Low'].includes(task.priority) ? task.priority : 'Medium',
                    dueDate: task.dueDate || '', // Keep empty if not set
                    selected: false, // Always reset selection on load
                    dateCreated: task.dateCreated || new Date().toISOString(), // Add creation date if missing
                    subtasks: Array.isArray(task.subtasks) ? task.subtasks.map(st => ({ text: st.text || '', completed: !!st.completed })) : [], // Ensure subtasks is an array
                    timeTracked: typeof task.timeTracked === 'number' ? task.timeTracked : 0, // In minutes
                    isTracking: false // Always reset tracking state on load
                }));
                // Ensure dueDate is in YYYY-MM-DD format if it exists
                tasks.forEach(task => {
                    if (task.dueDate && !/^\d{4}-\d{2}-\d{2}$/.test(task.dueDate)) {
                        try {
                            task.dueDate = new Date(task.dueDate).toISOString().split('T')[0];
                        } catch (e) { task.dueDate = ''; }
                    }
                });
            }

             function getDefaultTasks() {
                 const now = new Date();
                 const todayStr = now.toISOString().split('T')[0];
                 const tomorrowStr = getFutureDate(1);
                 const nextWeekStr = getFutureDate(7);
                 const tenDaysStr = getFutureDate(10);
                 const expiredStr = getFutureDate(-3);

                 return [
                     { id: 1, title: "Finalize Q2 Report", details: "Incorporate feedback from marketing", status: "Pending", category: "Work", priority: "High", dueDate: tomorrowStr, dateCreated: new Date(now.getTime() - 86400000 * 5).toISOString(), subtasks: [{text: "Review sales data", completed: true}, {text: "Add executive summary", completed: false}], timeTracked: 45 },
                     { id: 2, title: "Grocery Shopping", details: "Milk, Eggs, Bread, Chicken", status: "Pending", category: "Shopping", priority: "Medium", dueDate: todayStr, dateCreated: new Date(now.getTime() - 86400000 * 2).toISOString(), subtasks: [], timeTracked: 0 },
                     { id: 3, title: "Doctor Appointment Prep", details: "List questions for Dr. Anya", status: "Pending", category: "Health", priority: "Low", dueDate: nextWeekStr, dateCreated: new Date(now.getTime() - 86400000 * 1).toISOString(), subtasks: [], timeTracked: 15 },
                     { id: 4, title: "Read Chapter 5 - JS Patterns", details: "Focus on Module Pattern", status: "Completed", category: "Education", priority: "Medium", dueDate: expiredStr, dateCreated: new Date(now.getTime() - 86400000 * 8).toISOString(), subtasks: [], timeTracked: 60 },
                     { id: 5, title: "Pay Credit Card Bill", details: "Check statement for accuracy", status: "Pending", category: "Finance", priority: "High", dueDate: getFutureDate(4), dateCreated: new Date(now.getTime() - 86400000 * 6).toISOString(), subtasks: [], timeTracked: 5 },
                     { id: 6, title: "Plan Weekend Trip", details: "Research destinations and book hotel", status: "Pending", category: "Personal", priority: "Medium", dueDate: tenDaysStr, dateCreated: new Date(now.getTime() - 86400000 * 3).toISOString(), subtasks: [{text: "Check flight prices", completed: false}, {text: "Look up activities", completed: false}], timeTracked: 0 },
                     { id: 7, title: "Clean the Garage", details: "Sort out old boxes", status: "Pending", category: "Home", priority: "Low", dueDate: getFutureDate(14), dateCreated: new Date().toISOString(), subtasks: [], timeTracked: 0 },
                     { id: 8, title: "Submit Expense Report", details: "For last month's travel", status: "Completed", category: "Work", priority: "High", dueDate: getFutureDate(-10), dateCreated: new Date(now.getTime() - 86400000 * 15).toISOString(), subtasks: [], timeTracked: 25 },
                     { id: 9, title: "Call Mom", details: "", status: "Pending", category: "Personal", priority: "Medium", dueDate: "", dateCreated: new Date(now.getTime() - 86400000 * 4).toISOString(), subtasks: [], timeTracked: 0 },
                     { id: 10, title: "Renew Gym Membership", details: "Check for new offers", status: "Pending", category: "Health", priority: "Low", dueDate: getFutureDate(20), dateCreated: new Date(now.getTime() - 86400000 * 9).toISOString(), subtasks: [], timeTracked: 0 },
                 ].map(task => ({ ...task, selected: false, isTracking: false })); // Add default fields
             }

            function getFutureDate(days) {
                const date = new Date();
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            // (Keep saveNotifications, loadNotifications, applyTheme, applyInitialTheme, checkLoginStatus, showAppView, showLoginView)
             function saveNotifications() { localStorage.setItem('notifications', JSON.stringify(notifications)); }
             function loadNotifications() { const storedNotifications = localStorage.getItem('notifications'); notifications = storedNotifications ? JSON.parse(storedNotifications) : []; }
             function applyTheme(isDarkMode) {
                 const icon = themeToggleBtn.querySelector('i');
                 if (isDarkMode) {
                     document.body.classList.add('dark-mode');
                     icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                     localStorage.setItem('theme', 'dark');
                     // Update theme-color meta tag for PWA
                     document.querySelector('meta[name="theme-color"]').setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--dm-page-bg-start').trim());
                 } else {
                     document.body.classList.remove('dark-mode');
                     icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                     localStorage.setItem('theme', 'light');
                     document.querySelector('meta[name="theme-color"]').setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--lm-page-bg-start').trim());
                 }
                 updateAllCharts(); // Update charts whenever theme changes
             }
             function applyInitialTheme() {
                 const savedTheme = localStorage.getItem('theme');
                 const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                 applyTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));
             }
             function checkLoginStatus() { if (localStorage.getItem('loggedIn') === 'true') { showAppView(); } else { showLoginView(); } }
             function showAppView() { loginContainer.style.display = 'none'; document.body.classList.add('app-view'); appContainer.style.display = 'block'; tasksContainer.style.display = 'block'; graphContainer.style.display = 'none'; renderAll(); }
             function showLoginView() { appContainer.style.display = 'none'; document.body.classList.remove('app-view'); loginContainer.style.display = 'block'; localStorage.removeItem('loggedIn'); }

            // Rendering (Major Updates)
            function renderAll() {
                renderTasks(); // Includes filtering and sorting now
                renderNotifications();
                updateStats();
                updateProgress();
                updateAllCharts();
                updateBatchActionVisibility();
            }

            function renderTasks() {
                const filters = getFilters();
                const sortBy = sortTasksSelect.value.split('-');
                const sortField = sortBy[0];
                const sortDirection = sortBy[1]; // 'asc' or 'desc'

                // 1. Filter Tasks
                let filteredTasks = tasks.filter(task => {
                    // (Keep existing filter logic: status, category, priority, date)
                    if (filters.status !== 'all' && task.status !== filters.status) return false;
                    if (filters.category !== 'all' && task.category !== filters.category) return false;
                    if (filters.priority !== 'all' && task.priority !== filters.priority) return false;
                    if (filters.date !== 'all') {
                        if (!task.dueDate) return false; // Tasks without due date don't match specific date filters
                        const taskDueDate = new Date(task.dueDate + 'T00:00:00'); // Ensure comparison at start of day
                        if (isNaN(taskDueDate.getTime())) return false; // Invalid date

                        const today = new Date();
                        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                        const todayEnd = new Date(todayStart); todayEnd.setDate(todayStart.getDate() + 1);

                        if (filters.date === 'today') {
                            if (taskDueDate < todayStart || taskDueDate >= todayEnd) return false;
                        } else if (filters.date === 'week') {
                            const dayOfWeek = todayStart.getDay(); // 0 (Sun) to 6 (Sat)
                            const diff = todayStart.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
                            const weekStart = new Date(todayStart.setDate(diff));
                            const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 7);
                            if (taskDueDate < weekStart || taskDueDate >= weekEnd) return false;
                        } else if (filters.date === 'month') {
                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                            if (taskDueDate < monthStart || taskDueDate >= monthEnd) return false;
                        } else if (filters.date === 'custom' && filters.startDate && filters.endDate) {
                             try {
                                const startDate = new Date(filters.startDate + 'T00:00:00');
                                const endDate = new Date(filters.endDate + 'T00:00:00');
                                // Adjust end date to include the whole day
                                endDate.setDate(endDate.getDate() + 1);
                                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return false;
                                if (taskDueDate < startDate || taskDueDate >= endDate) return false;
                             } catch (e) { return false; } // Invalid custom date input
                        } else if (filters.date === 'custom' && (!filters.startDate || !filters.endDate)) {
                             return false; // Don't show anything if custom range is selected but not filled
                        }
                    }
                    return true;
                });

                // 2. Sort Tasks
                const priorityMap = { 'High': 3, 'Medium': 2, 'Low': 1 };
                filteredTasks.sort((a, b) => {
                    let compareA, compareB;
                    switch (sortField) {
                        case 'dueDate':
                            // Handle empty/invalid dates - push them to the end when sorting asc
                            compareA = a.dueDate ? new Date(a.dueDate) : (sortDirection === 'asc' ? Infinity : -Infinity);
                            compareB = b.dueDate ? new Date(b.dueDate) : (sortDirection === 'asc' ? Infinity : -Infinity);
                             // Handle invalid date parsing
                             if (isNaN(compareA)) compareA = (sortDirection === 'asc' ? Infinity : -Infinity);
                             if (isNaN(compareB)) compareB = (sortDirection === 'asc' ? Infinity : -Infinity);
                            break;
                        case 'priority':
                            compareA = priorityMap[a.priority] || 0;
                            compareB = priorityMap[b.priority] || 0;
                            break;
                        case 'title':
                            compareA = a.title.toLowerCase();
                            compareB = b.title.toLowerCase();
                            break;
                        case 'dateCreated':
                        default: // Default to dateCreated
                            compareA = new Date(a.dateCreated);
                            compareB = new Date(b.dateCreated);
                             if (isNaN(compareA)) compareA = (sortDirection === 'asc' ? Infinity : -Infinity);
                             if (isNaN(compareB)) compareB = (sortDirection === 'asc' ? Infinity : -Infinity);
                            break;
                    }

                    let comparison = 0;
                    if (compareA > compareB) {
                        comparison = 1;
                    } else if (compareA < compareB) {
                        comparison = -1;
                    }
                    return sortDirection === 'desc' ? (comparison * -1) : comparison;
                });

                // 3. Render HTML
                taskList.innerHTML = ''; // Clear previous list
                if (filteredTasks.length === 0) {
                    taskList.innerHTML = '<li class="no-tasks">No tasks match the current filters/sort.</li>';
                } else {
                    const today = new Date(); today.setHours(0, 0, 0, 0); // Start of today
                    const upcomingLimit = new Date(today);
                    upcomingLimit.setDate(today.getDate() + UPCOMING_THRESHOLD_DAYS);

                    filteredTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = `task-item ${task.status.toLowerCase()} ${task.selected ? 'selected' : ''}`;
                        li.dataset.id = task.id;

                        // Due Date Alerts
                        let dueDateAlertHTML = '';
                        if (task.dueDate) {
                            try {
                                const dueDate = new Date(task.dueDate + 'T00:00:00');
                                if (!isNaN(dueDate.getTime())) {
                                    if (dueDate < today) {
                                        dueDateAlertHTML = `<span class="due-date-alert alert-expired"><i class="fas fa-exclamation-circle"></i> Expired</span>`;
                                    } else if (dueDate >= today && dueDate < upcomingLimit) {
                                        const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                                        const upcomingText = daysDiff === 0 ? 'Due Today' : `Due in ${daysDiff}d`;
                                        dueDateAlertHTML = `<span class="due-date-alert alert-upcoming"><i class="fas fa-clock"></i> ${upcomingText}</span>`;
                                    }
                                }
                            } catch (e) { /* Ignore invalid dates for alerts */ }
                        }

                        // Subtasks HTML
                        let subtasksHTML = '';
                        if (task.subtasks && task.subtasks.length > 0) {
                            subtasksHTML = `<div class="subtasks-container">`;
                            task.subtasks.forEach((subtask, index) => {
                                subtasksHTML += `
                                    <div class="subtask-item ${subtask.completed ? 'completed' : ''}" data-subtask-index="${index}">
                                        <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
                                        <span>${escapeHtml(subtask.text)}</span>
                                    </div>
                                `;
                            });
                            subtasksHTML += `</div>`;
                        }

                        // Time Tracking Display
                        const timeTrackedMinutes = task.timeTracked || 0;
                        const hours = Math.floor(timeTrackedMinutes / 60);
                        const minutes = timeTrackedMinutes % 60;
                        const timeDisplay = timeTrackedMinutes > 0 ? `${hours}h ${minutes}m` : '';
                        const timeTrackedHTML = timeDisplay ? `<span class="time-tracked-display"><i class="fas fa-stopwatch"></i> ${timeDisplay}</span>` : '';

                        li.innerHTML = `
                            <div class="task-item-main">
                                <div class="task-checkbox-container">
                                    <input type="checkbox" class="task-checkbox" ${task.selected ? 'checked' : ''} title="Select task">
                                </div>
                                <div class="task-info">
                                    <div class="task-title">${escapeHtml(task.title)}</div>
                                    <div class="task-details">
                                        ${task.dueDate ? `<div class="task-detail"><i class="fas fa-calendar-alt"></i> Due: ${task.dueDate} ${dueDateAlertHTML}</div>` : ''}
                                        ${task.category ? `<div class="task-detail"><i class="fas fa-folder"></i> ${escapeHtml(task.category)}</div>` : ''}
                                        <div class="task-detail">
                                            <span class="tag tag-${task.priority.toLowerCase()}">${escapeHtml(task.priority)}</span>
                                        </div>
                                        ${timeTrackedHTML ? `<div class="task-detail">${timeTrackedHTML}</div>` : ''}
                                    </div>
                                    ${task.details ? `<div class="task-description">${escapeHtml(task.details)}</div>` : ''}
                                    ${subtasksHTML}
                                </div>
                            </div>
                            <div class="task-actions">
                                <label class="toggle-switch" title="Mark as ${task.status === 'Completed' ? 'Pending' : 'Completed'}">
                                    <input type="checkbox" class="status-toggle" ${task.status === 'Completed' ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                                <button class="icon-btn timer-btn ${task.isTracking ? 'active' : ''}" title="${task.isTracking ? 'Stop Timer' : 'Start Timer'}">
                                    <i class="fas ${task.isTracking ? 'fa-pause-circle' : 'fa-play-circle'}"></i>
                                </button>
                                <button class="icon-btn edit-btn" title="Edit Task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete-btn" title="Delete Task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        taskList.appendChild(li);

                        // Add event listeners for new elements
                        li.querySelector('.task-checkbox').addEventListener('change', handleTaskSelectToggle);
                        li.querySelector('.status-toggle').addEventListener('change', handleStatusToggle);
                        li.querySelector('.edit-btn').addEventListener('click', handleEditClick);
                        li.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                        li.querySelector('.timer-btn').addEventListener('click', handleTimerToggle);
                        li.querySelectorAll('.subtask-checkbox').forEach(cb => {
                            cb.addEventListener('change', handleSubtaskToggle);
                        });
                    });
                }
                 updateStats(); // Update stats after rendering filtered/sorted tasks
            }

            function renderNotifications() {
                // (Keep existing renderNotifications logic)
                const unreadCount = notifications.filter(n => !n.read).length;
                notificationCountBadge.textContent = unreadCount;
                notificationCountBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                if (notifications.length === 0) { notificationList.innerHTML = '<div class="notification-list-empty">No notifications</div>'; return; }
                notificationList.innerHTML = '';
                [...notifications].reverse().forEach(note => {
                    const div = document.createElement('div');
                    div.className = `notification-item ${note.read ? '' : 'unread'}`; div.dataset.id = note.id;
                    div.innerHTML = `<div style="font-weight: ${note.read ? 'normal' : 'bold'}; margin-bottom: 3px;">${escapeHtml(note.message)}</div><div style="font-size: 0.7rem; color: #aaa; opacity: 0.8;">${timeAgo(note.timestamp)}</div>`;
                    div.addEventListener('click', function() { const id = parseInt(this.dataset.id); const notification = notifications.find(n => n.id === id); if (notification && !notification.read) { notification.read = true; saveNotifications(); renderNotifications(); } });
                    notificationList.appendChild(div);
                });
            }

            // Stats & Progress Updates (Keep existing logic)
             function updateStats() {
                 const total = tasks.length;
                 const completed = tasks.filter(task => task.status === 'Completed').length;
                 const pending = total - completed;
                 const high = tasks.filter(task => task.priority === 'High').length;
                 const medium = tasks.filter(task => task.priority === 'Medium').length;
                 const low = tasks.filter(task => task.priority === 'Low').length;

                 totalTasksStat.textContent = total;
                 completedTasksStat.textContent = completed;
                 pendingTasksStat.textContent = pending;
                 highPriorityCount.textContent = high;
                 mediumPriorityCount.textContent = medium;
                 lowPriorityCount.textContent = low;
             }
             function updateProgress() {
                 const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                 const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                 const weekStart = new Date(todayStart); const dayOfWeek = todayStart.getDay(); const diff = todayStart.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); weekStart.setDate(diff);
                 const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); weekEnd.setHours(23, 59, 59, 999);
                 const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                 const monthEnd = new Date(todayStart.getFullYear(), todayStart.getMonth() + 1, 0); monthEnd.setHours(23, 59, 59, 999);

                 const calculateRate = (start, end) => {
                     const relevantTasks = tasks.filter(task => { if (!task.dueDate) return false; const dueDate = new Date(task.dueDate + 'T00:00:00'); return !isNaN(dueDate.getTime()) && dueDate >= start && dueDate <= end; });
                     const completed = relevantTasks.filter(t => t.status === 'Completed').length;
                     return relevantTasks.length > 0 ? Math.round((completed / relevantTasks.length) * 100) : 0;
                 };
                 progressToday.textContent = `${calculateRate(todayStart, todayEnd)}%`;
                 progressWeek.textContent = `${calculateRate(weekStart, weekEnd)}%`;
                 progressMonth.textContent = `${calculateRate(monthStart, monthEnd)}%`;
                 const overallCompleted = tasks.filter(t => t.status === 'Completed').length;
                 const overallRate = tasks.length > 0 ? Math.round((overallCompleted / tasks.length) * 100) : 0;
                 progressOverall.textContent = `${overallRate}%`;
             }

            // Charting (Keep existing logic, ensure updateAllCharts is called on theme change)
            function updateAllCharts() { if (taskStatusChart) taskStatusChart.destroy(); if (taskPriorityChart) taskPriorityChart.destroy(); if (completionChart) completionChart.destroy(); taskStatusChart = createTaskStatusChart(); taskPriorityChart = createTaskPriorityChart(); completionChart = createCompletionChart(); }
            function getChartColors() { const isDark = document.body.classList.contains('dark-mode'); const graphColors = { completed: '#28a745', pending: '#6c757d', high: '#0b5ed7', medium: '#58a6ff', low: '#a0c4ff' }; const themeColors = { gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.08)', ticksColor: isDark ? 'var(--dm-muted-text)' : 'var(--lm-muted-text)', legendColor: isDark ? 'var(--dm-text)' : 'var(--lm-text)', titleColor: isDark ? 'var(--dm-text)' : 'var(--lm-text)', primary: isDark ? 'var(--dm-primary)' : 'var(--lm-primary)', componentBg: isDark ? 'var(--dm-component-bg)' : 'var(--lm-component-bg)' }; return { ...graphColors, ...themeColors }; }
            function createTaskStatusChart() { const completed = tasks.filter(task => task.status === 'Completed').length; const pending = tasks.filter(task => task.status === 'Pending').length; const colors = getChartColors(); const data = { labels: ['Completed', 'Pending'], datasets: [{ label: 'Tasks by Status', data: [completed, pending], backgroundColor: [colors.completed, colors.pending], borderColor: colors.componentBg, borderWidth: 2 }] }; const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: colors.legendColor } }, title: { display: true, text: 'Tasks by Status', font: { size: 16 }, color: colors.titleColor } } }; const ctx = document.getElementById('taskStatusChart')?.getContext('2d'); return ctx ? new Chart(ctx, { type: 'doughnut', data, options }) : null; }
            function createTaskPriorityChart() { const high = tasks.filter(task => task.priority === 'High').length; const medium = tasks.filter(task => task.priority === 'Medium').length; const low = tasks.filter(task => task.priority === 'Low').length; const colors = getChartColors(); const data = { labels: ['High', 'Medium', 'Low'], datasets: [{ label: 'Tasks by Priority', data: [high, medium, low], backgroundColor: [colors.high, colors.medium, colors.low], borderColor: [colors.high, colors.medium, colors.low], borderWidth: 1 }] }; const options = { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1, color: colors.ticksColor }, grid: { color: colors.gridColor } }, y: { ticks: { color: colors.ticksColor }, grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Tasks by Priority', font: { size: 16 }, color: colors.titleColor } } }; const ctx = document.getElementById('taskPriorityChart')?.getContext('2d'); return ctx ? new Chart(ctx, { type: 'bar', data, options }) : null; }
            function createCompletionChart() { const rates = []; const labels = []; const today = new Date(); const colors = getChartColors(); for (let i = 6; i >= 0; i--) { const date = new Date(today); date.setDate(today.getDate() - i); const dateStr = date.toISOString().split('T')[0]; labels.push(dateStr.substring(5)); const dayStart = new Date(date); dayStart.setHours(0, 0, 0, 0); const dayEnd = new Date(date); dayEnd.setHours(23, 59, 59, 999); const relevantTasks = tasks.filter(task => task.dueDate === dateStr); const completed = relevantTasks.filter(t => t.status === 'Completed').length; rates.push(relevantTasks.length > 0 ? (completed / relevantTasks.length) * 100 : 0); } const data = { labels: labels, datasets: [{ label: 'Completion Rate (%)', data: rates, fill: true, backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(88, 166, 255, 0.2)' : 'rgba(0, 123, 255, 0.1)', borderColor: colors.primary, tension: 0.3, pointBackgroundColor: colors.primary, pointRadius: 4 }] }; const options = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + "%", color: colors.ticksColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.ticksColor }, grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Daily Task Completion Rate (Last 7 Days)', font: { size: 16 }, color: colors.titleColor } } }; const ctx = document.getElementById('completionChart')?.getContext('2d'); return ctx ? new Chart(ctx, { type: 'line', data, options }) : null; }


            // Date Picker (Flatpickr) Initialization (Keep existing logic)
            function initializeFlatpickr() {
                const commonOptions = { dateFormat: "Y-m-d", allowInput: true, };
                Object.values(flatpickrInstances).forEach(instance => instance.destroy()); flatpickrInstances = {};
                flatpickrInstances.taskDueDate = flatpickr(taskDueDateInput, commonOptions);
                flatpickrInstances.editTaskDueDate = flatpickr(editTaskDueDateInput, commonOptions);
                flatpickrInstances.customStart = flatpickr(customStartDateInput, { ...commonOptions, onChange: function(selectedDates, dateStr, instance) { if (flatpickrInstances.customEnd.selectedDates[0] && selectedDates[0] > flatpickrInstances.customEnd.selectedDates[0]) { flatpickrInstances.customEnd.clear(); } flatpickrInstances.customEnd.set('minDate', selectedDates[0]); renderTasks(); } });
                flatpickrInstances.customEnd = flatpickr(customEndDateInput, { ...commonOptions, onChange: function(selectedDates, dateStr, instance) { renderTasks(); } });
            }

            // Notifications (Keep existing logic)
            function addNotification(message, type = 'info') { const newNotification = { id: Date.now(), message, read: false, timestamp: Date.now(), type }; notifications.push(newNotification); if (notifications.length > 50) { notifications = notifications.slice(notifications.length - 50); } saveNotifications(); renderNotifications(); showNotificationPopup(message, type); }
            function showNotificationPopup(message, type = 'info') { const popup = document.createElement('div'); popup.className = 'notification-popup'; let iconClass = 'fa-info-circle'; if (type === 'success') iconClass = 'fa-check-circle'; else if (type === 'error') iconClass = 'fa-times-circle'; else if (type === 'warning') iconClass = 'fa-exclamation-triangle'; popup.innerHTML = `<i class="fas ${iconClass}"></i> <span>${escapeHtml(message)}</span>`; notificationPopupContainer.appendChild(popup); void popup.offsetWidth; setTimeout(() => popup.remove(), 5000); }

            // Utility Functions (Keep existing logic)
            function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
            function timeAgo(timestamp) { const now = new Date(); const past = new Date(timestamp); const diffInSeconds = Math.floor((now - past) / 1000); const diffInMinutes = Math.floor(diffInSeconds / 60); const diffInHours = Math.floor(diffInMinutes / 60); const diffInDays = Math.floor(diffInHours / 24); if (diffInSeconds < 60) return "just now"; if (diffInMinutes < 60) return `${diffInMinutes}m ago`; if (diffInHours < 24) return `${diffInHours}h ago`; if (diffInDays < 7) return `${diffInDays}d ago`; return past.toLocaleDateString(); }
            function getFilters() { return { status: statusFilter.value, date: dateFilter.value, category: categoryFilter.value, priority: priorityFilter.value, startDate: customStartDateInput.value, endDate: customEndDateInput.value }; }
            function openModal(modalElement) { modalElement.style.display = 'flex'; const firstInput = modalElement.querySelector('input:not([type="hidden"]), select, textarea'); if (firstInput) setTimeout(() => firstInput.focus(), 50); }
            function closeModal(modalElement) { modalElement.style.display = 'none'; }

            // --- Subtask Management ---
            function renderSubtaskEditor(containerElement, subtasks) {
                containerElement.innerHTML = ''; // Clear existing
                subtasks.forEach((subtask, index) => {
                    const li = document.createElement('li');
                    li.className = 'subtask-editor-item';
                    li.dataset.index = index;
                    li.innerHTML = `
                        <input type="text" value="${escapeHtml(subtask.text)}" placeholder="Subtask description">
                        <button class="remove-subtask-btn" title="Remove Subtask"><i class="fas fa-times"></i></button>
                    `;
                    li.querySelector('.remove-subtask-btn').addEventListener('click', handleRemoveSubtaskClick);
                    containerElement.appendChild(li);
                });
            }

            function getSubtasksFromEditor(containerElement) {
                const subtasks = [];
                containerElement.querySelectorAll('.subtask-editor-item').forEach(li => {
                    const input = li.querySelector('input[type="text"]');
                    if (input && input.value.trim()) {
                        // Find original subtask to preserve completion status if possible (crude match by text)
                        // A better approach would involve hidden IDs if editing existing ones.
                        subtasks.push({ text: input.value.trim(), completed: false }); // Reset completion on edit for simplicity here
                    }
                });
                return subtasks;
            }

            function handleAddSubtaskClick(event) {
                const editorId = event.target.id === 'addSubtaskBtnAdd' ? 'subtaskListEditorAdd' : 'subtaskListEditorEdit';
                const container = document.getElementById(editorId);
                const li = document.createElement('li');
                li.className = 'subtask-editor-item';
                li.innerHTML = `
                    <input type="text" placeholder="New subtask description">
                    <button class="remove-subtask-btn" title="Remove Subtask"><i class="fas fa-times"></i></button>
                `;
                li.querySelector('.remove-subtask-btn').addEventListener('click', handleRemoveSubtaskClick);
                container.appendChild(li);
                li.querySelector('input[type="text"]').focus();
            }

            function handleRemoveSubtaskClick(event) {
                event.target.closest('.subtask-editor-item').remove();
            }

            function handleSubtaskToggle(event) {
                const checkbox = event.target;
                const subtaskItem = checkbox.closest('.subtask-item');
                const taskItem = checkbox.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const subtaskIndex = parseInt(subtaskItem.dataset.subtaskIndex);

                const task = tasks.find(t => t.id === taskId);
                if (task && task.subtasks[subtaskIndex]) {
                    task.subtasks[subtaskIndex].completed = checkbox.checked;
                    subtaskItem.classList.toggle('completed', checkbox.checked);
                    saveTasks();
                    // Optionally add notification or update progress if needed
                }
            }

            // --- Time Tracking Management ---
            function handleTimerToggle(event) {
                const button = event.target.closest('.timer-btn');
                const taskItem = button.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);

                if (task) {
                    task.isTracking = !task.isTracking;
                    if (task.isTracking) {
                        startTimer(taskId, button);
                    } else {
                        stopTimer(taskId, button);
                    }
                    // Update button style immediately
                    button.classList.toggle('active', task.isTracking);
                    button.title = task.isTracking ? 'Stop Timer' : 'Start Timer';
                    button.querySelector('i').className = `fas ${task.isTracking ? 'fa-pause-circle' : 'fa-play-circle'}`;
                    // Note: saveTasks() is called when stopping or periodically if needed
                }
            }

            function startTimer(taskId, button) {
                if (activeTimers[taskId]) return; // Already running

                activeTimers[taskId] = setInterval(() => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task && task.isTracking) {
                        task.timeTracked = (task.timeTracked || 0) + 1; // Increment minutes
                        // Update display in real-time
                        const timeTrackedMinutes = task.timeTracked;
                        const hours = Math.floor(timeTrackedMinutes / 60);
                        const minutes = timeTrackedMinutes % 60;
                        const timeDisplay = timeTrackedMinutes > 0 ? `${hours}h ${minutes}m` : '';
                        const displayElement = button.closest('.task-item').querySelector('.time-tracked-display');
                        const detailContainer = button.closest('.task-item').querySelector('.task-details');

                        if (timeDisplay) {
                            if (displayElement) {
                                displayElement.innerHTML = `<i class="fas fa-stopwatch"></i> ${timeDisplay}`;
                            } else {
                                // Create element if it doesn't exist
                                const newDisplay = document.createElement('div');
                                newDisplay.className = 'task-detail'; // Use same class as other details
                                newDisplay.innerHTML = `<span class="time-tracked-display"><i class="fas fa-stopwatch"></i> ${timeDisplay}</span>`;
                                if (detailContainer) detailContainer.appendChild(newDisplay);
                            }
                        }

                        // Optional: Save periodically
                        // if (task.timeTracked % 5 === 0) { saveTasks(); }
                    } else {
                        // Task not found or tracking stopped externally, clear interval
                        stopTimer(taskId, button);
                    }
                }, 60000); // Update every minute (60000 ms)

                addNotification(`Timer started for task "${tasks.find(t => t.id === taskId)?.title}".`, 'info');
            }

            function stopTimer(taskId, button) {
                if (activeTimers[taskId]) {
                    clearInterval(activeTimers[taskId]);
                    delete activeTimers[taskId];
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.isTracking = false; // Ensure state is updated
                        addNotification(`Timer stopped for task "${task.title}". Total time: ${Math.floor(task.timeTracked / 60)}h ${task.timeTracked % 60}m.`, 'info');
                        // Update button style if button reference is available
                        if (button) {
                             button.classList.remove('active');
                             button.title = 'Start Timer';
                             button.querySelector('i').className = 'fas fa-play-circle';
                        }
                        saveTasks(); // Save final time
                    }
                }
            }

            // Stop all timers on page unload/logout
            function stopAllTimers() {
                 Object.keys(activeTimers).forEach(taskId => {
                     stopTimer(parseInt(taskId));
                 });
            }

            // --- Multi-Select & Batch Actions ---
            function handleTaskSelectToggle(event) {
                const checkbox = event.target;
                const taskItem = checkbox.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);

                if (task) {
                    task.selected = checkbox.checked;
                    taskItem.classList.toggle('selected', task.selected);
                    updateBatchActionVisibility();
                }
            }

            function updateBatchActionVisibility() {
                const selectedCount = tasks.filter(t => t.selected).length;
                if (selectedCount > 0) {
                    batchActionContainer.style.display = 'flex';
                    deleteSelectedBtn.disabled = false;
                    // Update count for confirmation modal later
                    deleteSelectedCount.textContent = selectedCount;
                } else {
                    batchActionContainer.style.display = 'none';
                    deleteSelectedBtn.disabled = true;
                }
            }

            function handleDeleteSelected() {
                const selectedTasks = tasks.filter(t => t.selected);
                if (selectedTasks.length === 0) return;

                tasks = tasks.filter(t => !t.selected); // Remove selected tasks
                saveTasks();
                renderAll(); // Re-render the list
                closeModal(deleteSelectedConfirmModal);
                addNotification(`${selectedTasks.length} task(s) deleted successfully.`, 'success');
            }


            // --- PWA Registration ---
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/service-worker.js') // Adjust path if needed
                            .then(registration => {
                                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                            })
                            .catch(error => {
                                console.log('ServiceWorker registration failed: ', error);
                            });
                    });
                }
            }

            // --- Event Handlers ---

            // (Keep existing handlers for login, register, logout, theme toggle)
            loginBtn.addEventListener('click', function() { const email = emailInput.value.trim(); const password = passwordInput.value.trim(); if (email === 'test@example.com' && password === 'password123') { localStorage.setItem('loggedIn', 'true'); showAppView(); addNotification('Login successful!', 'success'); } else { addNotification('Incorrect email or password.', 'error'); } });
            registerLink.addEventListener('click', () => openModal(registerModal));
            cancelRegisterBtn.addEventListener('click', () => closeModal(registerModal));
            submitRegisterBtn.addEventListener('click', () => { closeModal(registerModal); addNotification('Account created! Please login.', 'success'); });
            logoutBtn.addEventListener('click', () => { stopAllTimers(); showLoginView(); addNotification('Logged out.', 'info'); });
            themeToggleBtn.addEventListener('click', () => applyTheme(!document.body.classList.contains('dark-mode')));

            // Add Task Modal
            addTaskBtn.addEventListener('click', () => {
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDetails').value = '';
                renderSubtaskEditor(subtaskListEditorAdd, []); // Clear subtasks
                document.getElementById('taskCategory').value = '';
                document.getElementById('taskPriority').value = 'Medium';
                flatpickrInstances.taskDueDate.clear();
                openModal(addTaskModal);
            });
            cancelTaskBtn.addEventListener('click', () => closeModal(addTaskModal));
            createTaskBtn.addEventListener('click', function() {
                const title = document.getElementById('taskTitle').value.trim();
                if (!title) { addNotification('Task title is required.', 'warning'); return; }
                const newSubtasks = getSubtasksFromEditor(subtaskListEditorAdd);
                const newTask = {
                    id: Date.now() + Math.random(), // More unique ID
                    title,
                    details: document.getElementById('taskDetails').value.trim(),
                    status: "Pending", category: document.getElementById('taskCategory').value,
                    priority: document.getElementById('taskPriority').value, dueDate: taskDueDateInput.value,
                    selected: false, dateCreated: new Date().toISOString(),
                    subtasks: newSubtasks, timeTracked: 0, isTracking: false
                };
                tasks.push(newTask);
                saveTasks();
                renderAll();
                closeModal(addTaskModal);
                addNotification(`Task "${escapeHtml(title)}" created!`, 'success');
            });
            addSubtaskBtnAdd.addEventListener('click', handleAddSubtaskClick); // Add subtask in Add modal

            // Edit Task Modal
            function handleEditClick(event) {
                const taskItem = event.target.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    editTaskIdInput.value = task.id;
                    document.getElementById('editTaskTitle').value = task.title;
                    document.getElementById('editTaskDetails').value = task.details;
                    renderSubtaskEditor(subtaskListEditorEdit, task.subtasks || []); // Load subtasks
                    document.getElementById('editTaskCategory').value = task.category;
                    document.getElementById('editTaskPriority').value = task.priority;
                    flatpickrInstances.editTaskDueDate.setDate(task.dueDate, false);
                    openModal(editTaskModal);
                }
            }
            cancelEditTaskBtn.addEventListener('click', () => closeModal(editTaskModal));
            saveTaskBtn.addEventListener('click', function() {
                const taskId = parseInt(editTaskIdInput.value);
                const title = document.getElementById('editTaskTitle').value.trim();
                if (!title) { addNotification('Task title is required.', 'warning'); return; }
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    const editedSubtasks = getSubtasksFromEditor(subtaskListEditorEdit);
                    // Preserve completion status of existing subtasks if possible (simple text match)
                    const originalSubtasks = tasks[taskIndex].subtasks || [];
                    const updatedSubtasks = editedSubtasks.map(editedSub => {
                        const original = originalSubtasks.find(orig => orig.text === editedSub.text);
                        return { text: editedSub.text, completed: original ? original.completed : false };
                    });

                    tasks[taskIndex] = { ...tasks[taskIndex], title,
                        details: document.getElementById('editTaskDetails').value.trim(),
                        subtasks: updatedSubtasks, // Save updated subtasks
                        category: document.getElementById('editTaskCategory').value,
                        priority: document.getElementById('editTaskPriority').value,
                        dueDate: editTaskDueDateInput.value
                    };
                    saveTasks();
                    renderAll();
                    closeModal(editTaskModal);
                    addNotification(`Task "${escapeHtml(title)}" updated!`, 'success');
                } else { addNotification('Error updating task.', 'error'); }
            });
             addSubtaskBtnEdit.addEventListener('click', handleAddSubtaskClick); // Add subtask in Edit modal


            // Delete Single Task
            function handleDeleteClick(event) {
                const taskItem = event.target.closest('.task-item');
                currentTaskIdToDelete = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === currentTaskIdToDelete);
                if (task) {
                    deleteTaskTitle.textContent = task.title;
                    openModal(deleteConfirmModal);
                }
            }
            cancelDeleteBtn.addEventListener('click', () => { closeModal(deleteConfirmModal); currentTaskIdToDelete = null; });
            confirmDeleteBtn.addEventListener('click', function() {
                if (currentTaskIdToDelete) {
                    const taskIndex = tasks.findIndex(t => t.id === currentTaskIdToDelete);
                    if (taskIndex > -1) {
                        stopTimer(currentTaskIdToDelete); // Stop timer if running
                        const deletedTaskTitle = tasks[taskIndex].title;
                        tasks.splice(taskIndex, 1);
                        saveTasks();
                        renderAll();
                        closeModal(deleteConfirmModal);
                        addNotification(`Task "${escapeHtml(deletedTaskTitle)}" deleted!`, 'success');
                        currentTaskIdToDelete = null;
                    } else { addNotification('Error deleting task.', 'error'); }
                }
            });

            // Delete Selected Tasks
            deleteSelectedBtn.addEventListener('click', () => {
                const selectedCountVal = tasks.filter(t => t.selected).length;
                if (selectedCountVal > 0) {
                    deleteSelectedCount.textContent = selectedCountVal; // Update count just before showing
                    openModal(deleteSelectedConfirmModal);
                }
            });
            cancelDeleteSelectedBtn.addEventListener('click', () => closeModal(deleteSelectedConfirmModal));
            confirmDeleteSelectedBtn.addEventListener('click', handleDeleteSelected);


            // Task Status Toggle
            function handleStatusToggle(event) {
                const taskItem = event.target.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                const isChecked = event.target.checked;
                if (task) {
                    task.status = isChecked ? 'Completed' : 'Pending';
                    if (isChecked && task.isTracking) {
                         stopTimer(taskId, taskItem.querySelector('.timer-btn')); // Stop timer on completion
                    }
                    saveTasks();
                    // Update UI immediately for responsiveness
                    taskItem.classList.toggle('completed', isChecked);
                    taskItem.classList.toggle('pending', !isChecked);
                    const titleElement = taskItem.querySelector('.task-title');
                    if (titleElement) {
                        titleElement.style.textDecoration = isChecked ? 'line-through' : 'none';
                        // Reset color to inherit from CSS rules
                        titleElement.style.color = '';
                    }
                    addNotification(`Task "${escapeHtml(task.title)}" marked as ${task.status.toLowerCase()}.`, 'info');
                    // Re-render might be needed if sorting/filtering depends on status, but stats/progress update is sufficient here
                     setTimeout(() => { updateStats(); updateProgress(); updateAllCharts(); }, 100); // Update stats after slight delay
                }
            }

            // View Toggles (List/Graph)
            listViewBtn.addEventListener('click', () => { tasksContainer.style.display = 'block'; graphContainer.style.display = 'none'; });
            graphViewBtn.addEventListener('click', () => { tasksContainer.style.display = 'none'; graphContainer.style.display = 'flex'; updateAllCharts(); });

            // Filters & Sorting Event Listeners
            [statusFilter, categoryFilter, priorityFilter, sortTasksSelect].forEach(el => el.addEventListener('change', renderTasks));
            dateFilter.addEventListener('change', function() {
                customDateFilterGroup.style.display = (dateFilter.value === 'custom') ? 'block' : 'none';
                if (dateFilter.value !== 'custom') {
                    flatpickrInstances.customStart.clear(); flatpickrInstances.customEnd.clear();
                }
                renderTasks(); // Re-render when date filter type changes
            });
            resetFiltersBtn.addEventListener('click', function() {
                statusFilter.value = 'all'; dateFilter.value = 'all'; categoryFilter.value = 'all'; priorityFilter.value = 'all';
                sortTasksSelect.value = 'dateCreated-desc'; // Reset sort to default
                customDateFilterGroup.style.display = 'none';
                flatpickrInstances.customStart.clear(); flatpickrInstances.customEnd.clear();
                renderTasks();
                addNotification('Filters and sort reset.', 'info');
            });

            // Export/Import (Keep existing logic, ensure it handles new fields if necessary)
            exportBtn.addEventListener('click', () => openModal(exportModal));
            cancelExportBtn.addEventListener('click', () => closeModal(exportModal));
            confirmExportBtn.addEventListener('click', function() {
                const format = document.getElementById('exportFormat').value;
                let content, mimeType, extension;
                // Add new fields to export if desired (e.g., subtasks as JSON string, timeTracked)
                const tasksToExport = tasks.map(t => ({
                    id: t.id, title: t.title, details: t.details, status: t.status, category: t.category,
                    priority: t.priority, dueDate: t.dueDate, dateCreated: t.dateCreated,
                    subtasks: JSON.stringify(t.subtasks), // Export subtasks as JSON string for CSV
                    timeTracked: t.timeTracked
                }));

                if (format === 'csv') {
                    const header = "ID,Title,Details,Status,Category,Priority,DueDate,DateCreated,SubtasksJSON,TimeTrackedMinutes\n";
                    const rows = tasksToExport.map(t => [
                        t.id, `"${(t.title || '').replace(/"/g, '""')}"`, `"${(t.details || '').replace(/"/g, '""')}"`,
                        t.status, t.category, t.priority, t.dueDate, t.dateCreated,
                        `"${(t.subtasks || '[]').replace(/"/g, '""')}"`, // Escape quotes in JSON string
                        t.timeTracked
                    ].join(',')).join('\n');
                    content = header + rows; mimeType = 'text/csv;charset=utf-8;'; extension = 'csv';
                } else if (format === 'json') {
                    // Export full task objects for JSON
                    content = JSON.stringify(tasks, null, 2); // Use original tasks array for full structure
                    mimeType = 'application/json;charset=utf-8;'; extension = 'json';
                } else { addNotification('Invalid export format.', 'warning'); return; }

                const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `tasks_export_${new Date().toISOString().split('T')[0]}.${extension}`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                closeModal(exportModal); addNotification('Tasks exported!', 'success');
            });
            importBtn.addEventListener('click', () => { fileUploadInput.value = ''; openModal(importModal); });
            cancelImportBtn.addEventListener('click', () => closeModal(importModal));
            confirmImportBtn.addEventListener('click', function() {
                const file = fileUploadInput.files[0]; if (!file) { addNotification('Please select a file.', 'warning'); return; }
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        let importedTasksRaw = [];
                        if (file.name.endsWith('.csv')) {
                             // Basic CSV parsing - assumes structure from export
                             const lines = event.target.result.split('\n');
                             if (lines.length < 2) throw new Error("CSV file needs header and at least one data row.");
                             const headers = lines[0].trim().toLowerCase().split(',');
                             const requiredHeaders = ['title', 'status', 'priority'];
                             if (!requiredHeaders.every(h => headers.includes(h))) throw new Error("CSV missing required columns (Title, Status, Priority).");

                             const hIndex = headers.reduce((acc, h, i) => ({ ...acc, [h]: i }), {}); // Map header names to indices

                             for (let i = 1; i < lines.length; i++) {
                                 if (!lines[i].trim()) continue;
                                 // Very basic CSV value extraction - doesn't handle commas within quotes well
                                 const values = lines[i].split(',');
                                 let subtasks = [];
                                 try { subtasks = JSON.parse(values[hIndex['subtasksjson']]?.replace(/^"|"$/g, '').replace(/""/g, '"') || '[]'); } catch (e) { console.warn("Failed to parse subtasks from CSV line:", i); }

                                 importedTasksRaw.push({
                                     id: values[hIndex['id']] ? parseInt(values[hIndex['id']]) : undefined, // Let loadTasks handle ID generation if missing
                                     title: values[hIndex['title']]?.replace(/^"|"$/g, '').replace(/""/g, '"') || `Untitled Task ${i}`,
                                     details: values[hIndex['details']]?.replace(/^"|"$/g, '').replace(/""/g, '"') || '',
                                     status: values[hIndex['status']] || 'Pending',
                                     category: values[hIndex['category']] || '',
                                     priority: values[hIndex['priority']] || 'Medium',
                                     dueDate: values[hIndex['duedate']] || '',
                                     dateCreated: values[hIndex['datecreated']] || new Date().toISOString(),
                                     subtasks: Array.isArray(subtasks) ? subtasks : [],
                                     timeTracked: parseInt(values[hIndex['timetrackedminutes']]) || 0
                                 });
                             }
                        } else if (file.name.endsWith('.json')) {
                            importedTasksRaw = JSON.parse(event.target.result);
                            if (!Array.isArray(importedTasksRaw)) throw new Error("JSON must be an array of task objects.");
                        } else { throw new Error("Unsupported file type."); }

                        // Validate and merge imported tasks
                        const existingIds = new Set(tasks.map(t => t.id));
                        const newTasks = importedTasksRaw.map((t, i) => {
                            // Basic validation and default setting
                            const validatedTask = {
                                id: (t.id && !existingIds.has(t.id)) ? t.id : Date.now() + Math.random() + i,
                                title: t.title || 'Untitled Imported Task',
                                details: t.details || '',
                                status: ['Pending', 'Completed'].includes(t.status) ? t.status : 'Pending',
                                category: t.category || '',
                                priority: ['High', 'Medium', 'Low'].includes(t.priority) ? t.priority : 'Medium',
                                dueDate: t.dueDate && /^\d{4}-\d{2}-\d{2}$/.test(t.dueDate) ? t.dueDate : '',
                                selected: false,
                                dateCreated: t.dateCreated || new Date().toISOString(),
                                subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(st => ({ text: st.text || '', completed: !!st.completed })) : [],
                                timeTracked: typeof t.timeTracked === 'number' ? t.timeTracked : 0,
                                isTracking: false
                            };
                            existingIds.add(validatedTask.id); // Add new ID to set
                            return validatedTask;
                        }).filter(t => t.title); // Ensure at least a title exists

                        tasks = tasks.concat(newTasks); // Append imported tasks
                        saveTasks(); renderAll(); closeModal(importModal);
                        addNotification(`${newTasks.length} tasks imported successfully!`, 'success');
                    } catch (error) { console.error("Import Error:", error); addNotification(`Import failed: ${error.message}`, 'error'); }
                };
                reader.onerror = () => addNotification('Error reading file.', 'error');
                reader.readAsText(file);
            });

            // General UI Handlers
            notificationBtn.addEventListener('click', (e) => { e.stopPropagation(); notificationList.style.display = notificationList.style.display === 'block' ? 'none' : 'block'; });
            refreshLogo.addEventListener('click', () => { renderAll(); addNotification('View refreshed.', 'info'); });
            window.addEventListener('click', (e) => {
                if (!notificationBtn.contains(e.target) && !notificationList.contains(e.target)) notificationList.style.display = 'none';
                // Close modals on overlay click
                if (e.target.classList.contains('modal')) closeModal(e.target);
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(m => { if (m.style.display === 'flex') closeModal(m); });
                    if (notificationList.style.display === 'block') notificationList.style.display = 'none';
                }
            });
            // Stop timers before unloading page
            window.addEventListener('beforeunload', stopAllTimers);

        }); // End DOMContentLoaded
    </script>
</body>
</html>
