<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            /* --- Color Palettes --- */

            /* Light Mode (Dark Red Page BG, White Components) */
            --lm-page-bg-start: #6a040f; /* Dark Red */
            --lm-page-bg-end: #9d0208;   /* Slightly Lighter Red */
            --lm-component-bg: #ffffff; /* WHITE component background */
            --lm-text: #212529;     /* DARK text for contrast on white */
            --lm-border: #dee2e6;   /* Light gray border for components */
            --lm-shadow-color: rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --lm-primary: #007bff;  /* Standard Blue */
            --lm-secondary: #6c757d; /* Gray */
            --lm-success: #28a745;  /* Standard Green */
            --lm-danger: #dc3545;   /* Standard Red */
            --lm-warning: #ffc107;  /* Standard Yellow */
            --lm-info: #17a2b8;     /* Standard Teal */
            --lm-muted-text: #6c757d; /* Grayish text */
            --lm-input-bg: #f8f9fa;  /* Very light gray input bg */
            --lm-input-border: #ced4da; /* Standard input border */
            --lm-header-bg: #ffffff; /* White header */
            --lm-task-bg: #ffffff; /* White task item */
            --lm-task-completed-bg: rgba(40, 167, 69, 0.1); /* Light green completed task */
            --lm-tag-high-bg: rgba(220, 53, 69, 0.1);
            --lm-tag-medium-bg: rgba(0, 123, 255, 0.1);
            --lm-tag-low-bg: rgba(108, 117, 125, 0.1);
            --lm-tag-high-text: var(--lm-danger);
            --lm-tag-medium-text: var(--lm-primary);
            --lm-tag-low-text: var(--lm-secondary);

            /* Dark Mode */
            --dm-page-bg-start: #141414; /* Very dark gray */
            --dm-page-bg-end: #252525;   /* Slightly lighter gray */
            --dm-component-bg: #333; /* Dark component background */
            --dm-text: #e9ecef;     /* Light gray text */
            --dm-border: #555;     /* Gray border */
            --dm-shadow-color: rgba(0, 0, 0, 0.5);
            --dm-primary: #58a6ff; /* Brighter Blue */
            --dm-secondary: #8b949e; /* GitHub Gray */
            --dm-success: #56d364; /* Brighter Green */
            --dm-danger: #f85149;  /* Brighter Red */
            --dm-warning: #e3b341; /* Brighter Yellow */
            --dm-info: #79c0ff;    /* Brighter Teal */
            --dm-muted-text: #8b949e;
            --dm-input-bg: #222;    /* Darker input bg */
            --dm-input-border: #555;
            --dm-header-bg: #2a2a2a; /* Slightly different header bg */
            --dm-task-bg: #3a3a3a;   /* Task item bg */
            --dm-task-completed-bg: rgba(86, 211, 100, 0.15); /* Darker green completed task */
            --dm-tag-high-bg: rgba(248, 81, 73, 0.2);
            --dm-tag-medium-bg: rgba(88, 166, 255, 0.2);
            --dm-tag-low-bg: rgba(139, 148, 158, 0.2);
            --dm-tag-high-text: var(--dm-danger);
            --dm-tag-medium-text: var(--dm-primary);
            --dm-tag-low-text: var(--dm-secondary);

            /* General */
            --border-radius: 8px;
            --notification-bg: rgba(10, 10, 10, 0.9); /* Consistent dark notification */
            --notification-text: white;

            /* --- NEW: Graph Colors (Consistent across modes) --- */
            --graph-completed: #28a745; /* Green */
            --graph-pending: #DAA520;   /* Dark Yellow (GoldenRod) - UPDATED */
            --graph-high: #0b5ed7;      /* Dark Blue */
            --graph-medium: #58a6ff;    /* Brighter Blue */
            --graph-low: #a0c4ff;       /* Light Blue */
        }

        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Smooth transitions for theme changes */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        html {
             font-size: 16px; /* Base font size */
        }

        body {
            background: linear-gradient(135deg, var(--lm-page-bg-start), var(--lm-page-bg-end));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem; /* Use rem for padding */
            color: var(--lm-text); /* Default: Dark text for light mode */
            overflow-x: hidden; /* Prevent accidental horizontal scroll */
        }

        /* Style for when the app view is active */
        body.app-view {
            background: linear-gradient(135deg, var(--lm-page-bg-start), var(--lm-page-bg-end));
            padding: 0; /* Remove padding when app fills screen */
            display: block; /* Change display from flex */
            align-items: normal; /* Reset align-items */
        }

        /* Dark mode body styles */
        body.dark-mode {
            background: linear-gradient(135deg, var(--dm-page-bg-start), var(--dm-page-bg-end));
            color: var(--dm-text); /* Light text for dark mode */
        }
        body.dark-mode.app-view {
            background: linear-gradient(135deg, var(--dm-page-bg-start), var(--dm-page-bg-end));
        }

        /* --- Component Styling (Default: Light Mode - White BG) --- */
        .login-container,
        .modal-content,
        header,
        .stat-card,
        .progress-item,
        .todo-section,
        .graph-item,
        .insight-card,
        .notification-list,
        .distribution-item {
            background-color: var(--lm-component-bg);
            border: 1px solid var(--lm-border);
            box-shadow: 0 4px 12px var(--lm-shadow-color);
            color: var(--lm-text); /* Ensure text inside is dark */
            border-radius: var(--border-radius);
        }

        /* Task item specific styles */
        .task-item {
             background-color: var(--lm-task-bg);
             border: 1px solid var(--lm-border);
             box-shadow: 0 2px 5px var(--lm-shadow-color);
             color: var(--lm-text);
             border-left: 5px solid var(--lm-secondary); /* Default pending border (gray) */
             border-radius: var(--border-radius);
        }
        .task-item.completed {
             background-color: var(--lm-task-completed-bg);
             border-left-color: var(--lm-success); /* Green border for completed */
        }
        .task-item.pending {
             border-left-color: var(--lm-warning); /* Yellow border for pending */
        }

        /* --- Dark Mode Component Overrides --- */
        body.dark-mode .login-container,
        body.dark-mode .modal-content,
        body.dark-mode .stat-card,
        body.dark-mode .progress-item,
        body.dark-mode .todo-section,
        body.dark-mode .graph-item,
        body.dark-mode .insight-card,
        body.dark-mode .notification-list,
        body.dark-mode .distribution-item {
             background-color: var(--dm-component-bg);
             border-color: var(--dm-border);
             box-shadow: 0 4px 12px var(--dm-shadow-color);
             color: var(--dm-text); /* Ensure text inside is light */
        }
        body.dark-mode header {
            background-color: var(--dm-header-bg);
            border-color: var(--dm-border);
            box-shadow: 0 4px 12px var(--dm-shadow-color);
            color: var(--dm-text);
        }
         body.dark-mode .task-item {
             background-color: var(--dm-task-bg);
             border-color: var(--dm-border);
             box-shadow: 0 2px 5px var(--dm-shadow-color);
             color: var(--dm-text);
             border-left-color: var(--dm-secondary); /* Default pending border (gray) */
         }
        body.dark-mode .task-item.completed {
             background-color: var(--dm-task-completed-bg);
             border-left-color: var(--dm-success); /* Green border for completed */
         }
         body.dark-mode .task-item.pending {
             border-left-color: var(--dm-warning); /* Yellow border for pending */
         }

        /* --- Login & Modal Styles --- */
        .login-container {
            padding: 2rem;
            width: 100%;
            max-width: 450px; /* Limit width on larger screens */
            text-align: center;
        }

        .login-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: inherit; /* Inherit color from container */
        }

        .input-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--lm-muted-text);
            font-size: 0.9rem;
        }
        body.dark-mode .input-group label {
             color: var(--dm-muted-text);
        }

        /* Input fields, selects, date inputs */
        .input-field, .filter-select, .filter-date {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--lm-input-border);
            font-size: 1rem;
            outline: none;
            background-color: var(--lm-input-bg);
            color: var(--lm-text);
            line-height: 1.5; /* Ensure consistent height */
        }
        .input-field::placeholder,
        .filter-date::placeholder {
             color: var(--lm-muted-text);
             opacity: 0.7;
        }

        .input-field:focus, .filter-select:focus, .filter-date:focus {
            border-color: var(--lm-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); /* Focus ring */
        }

        /* Dark mode input overrides */
        body.dark-mode .input-field,
        body.dark-mode .filter-select,
        body.dark-mode .filter-date {
            background-color: var(--dm-input-bg);
            color: var(--dm-text);
            border-color: var(--dm-input-border);
        }
         body.dark-mode .input-field::placeholder,
         body.dark-mode .filter-date::placeholder {
             color: var(--dm-muted-text);
             opacity: 0.7;
         }
         body.dark-mode .input-field:focus,
         body.dark-mode .filter-select:focus,
         body.dark-mode .filter-date:focus {
            border-color: var(--dm-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.25);
        }

        .flatpickr-input {
            cursor: pointer; /* Indicate date picker is clickable */
        }

        /* --- Button Styles --- */
        .btn {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.5;
            text-align: center;
        }
        .btn i {
             margin-right: 0.5em; /* Space between icon and text */
        }

        .btn:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
             transform: translateY(0); /* Press down effect */
             box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Light Mode Buttons */
        .btn { background-color: var(--lm-primary); color: white; }
        .btn.btn-green { background-color: var(--lm-success); color: white; }
        .btn.btn-danger { background-color: var(--lm-danger); color: white; }
        #resetFiltersBtn { background-color: var(--lm-secondary); color: white; }
        header #logoutBtn { background-color: var(--lm-danger); color: white; }
        .modal-footer .btn:first-child { background-color: var(--lm-secondary); color: white; } /* Cancel button style */

        /* Dark Mode Buttons */
        body.dark-mode .btn { background-color: var(--dm-primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        body.dark-mode .btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        body.dark-mode .btn:active { box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        body.dark-mode .btn.btn-green { background-color: var(--dm-success); color: white; }
        body.dark-mode .btn.btn-danger { background-color: var(--dm-danger); color: white; }
        body.dark-mode #resetFiltersBtn { background-color: var(--dm-secondary); color: white; }
        body.dark-mode header #logoutBtn { background-color: var(--dm-danger); color: white; }
        body.dark-mode .modal-footer .btn:first-child { background-color: var(--dm-secondary); color: white; }

        .btn-block { display: block; width: 100%; } /* Full width button */

        .register-link { margin-top: 1.25rem; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .register-link { color: var(--dm-muted-text); }
        .register-link a { color: var(--lm-primary); text-decoration: none; font-weight: 500; }
        body.dark-mode .register-link a { color: var(--dm-primary); }
        .register-link a:hover { text-decoration: underline; }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
            justify-content: center; align-items: center;
            backdrop-filter: blur(3px); /* Background blur effect */
            padding: 1rem; /* Padding around the modal content */
        }

        .modal-content {
            border-radius: var(--border-radius); padding: 1.5rem; width: 100%; max-width: 500px;
            max-height: 90vh; /* Limit height and allow scrolling */
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out; /* Fade-in animation */
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .modal-title { font-size: 1.4rem; margin-bottom: 1.5rem; text-align: center; font-weight: 600; color: inherit; }
        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* --- App Container & Header --- */
        .app-container { display: none; width: 100%; min-height: 100vh; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; position: sticky; top: 0; z-index: 10; /* Sticky header */
        }

        .logo { font-size: 1.5rem; font-weight: 700; color: var(--lm-primary); cursor: pointer; }
        body.dark-mode .logo { color: var(--dm-primary); }

        .header-actions { display: flex; align-items: center; gap: 1rem; }

        /* Icon button styles (theme toggle, notifications) */
        .icon-btn {
            background: none; border: none; font-size: 1.25rem; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--lm-muted-text);
        }
        body.dark-mode .icon-btn { color: var(--dm-muted-text); }
        .icon-btn:hover { background-color: rgba(0, 0, 0, 0.05); color: var(--lm-primary); }
        body.dark-mode .icon-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--dm-primary); }

        /* Notification badge styles */
        .notification-badge { position: relative; }
        .badge {
            position: absolute; top: 0px; right: 0px; color: white; font-size: 0.65rem;
            width: 18px; height: 18px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-weight: bold;
            background-color: var(--lm-danger); border: 2px solid var(--lm-header-bg); /* Border matches header bg */
        }
        body.dark-mode .badge { background-color: var(--dm-danger); border-color: var(--dm-header-bg); }

        /* Notification dropdown list */
        .notification-list {
            display: none; position: absolute; top: 60px; right: 10px; /* Position relative to header */
            border-radius: var(--border-radius); width: clamp(280px, 80vw, 320px); /* Responsive width */
            padding: 0.5rem 0;
            z-index: 20; max-height: 400px; overflow-y: auto;
        }

        .notification-item {
            padding: 0.75rem 1rem; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--lm-input-border); color: var(--lm-text);
        }
        .notification-item.unread { background-color: rgba(0, 123, 255, 0.08); font-weight: 500; }
        body.dark-mode .notification-item { border-bottom-color: var(--dm-input-border); color: var(--dm-text); }
        body.dark-mode .notification-item.unread { background-color: rgba(88, 166, 255, 0.15); }
        .notification-item:hover { background-color: rgba(0, 0, 0, 0.03); }
        body.dark-mode .notification-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .notification-item:last-child { border-bottom: none; }
        .notification-list-empty { padding: 1.25rem; text-align: center; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .notification-list-empty { color: var(--dm-muted-text); }

        /* --- Main Content Area --- */
        .main-container { padding: 1.5rem; }
        .action-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; } /* Allow buttons to wrap */

        /* Stats cards (Total, Completed, Pending) */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .stat-card { border-radius: var(--border-radius); padding: 1.25rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }

        /* Specific Stat Card Styles with Gradients */
        .stat-card.total { background: linear-gradient(135deg, var(--lm-primary), #0056b3); color: white; border: none; }
        .stat-card.completed { background: linear-gradient(135deg, var(--lm-success), #1e7e34); color: white; border: none; }
        .stat-card.pending { background: linear-gradient(135deg, var(--lm-warning), #d39e00); color: #212529; border: none; } /* Dark text on yellow */
        body.dark-mode .stat-card.total { background: linear-gradient(135deg, var(--dm-primary), #3c8ce7); color: white; border: none; }
        body.dark-mode .stat-card.completed { background: linear-gradient(135deg, var(--dm-success), #38c172); color: white; border: none; }
        body.dark-mode .stat-card.pending { background: linear-gradient(135deg, var(--dm-warning), #f7c74c); color: #212529; border: none; } /* Dark text on yellow */

        .stat-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; color: inherit; opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: inherit; }

        /* Progress items (Today, Week, Month, Overall) */
        .progress-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .progress-item { border-radius: var(--border-radius); padding: 1.25rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .progress-item:hover { transform: translateY(-5px); }
        .progress-title { margin-bottom: 0.5rem; font-weight: 500; color: var(--lm-muted-text); font-size: 0.9rem; }
        body.dark-mode .progress-title { color: var(--dm-muted-text); }
        .progress-value { font-size: 1.5rem; font-weight: 700; color: var(--lm-primary); }
        body.dark-mode .progress-value { color: var(--dm-primary); }

        /* --- To-Do Section --- */
        .todo-section { border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; }
        .todo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; border-bottom: 1px solid var(--lm-input-border); padding-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; } /* Allow wrapping */
        body.dark-mode .todo-header { border-bottom-color: var(--dm-input-border); }

        /* Tasks Title Color */
        .todo-header h2 { font-size: 1.5rem; font-weight: 600; color: var(--lm-text); margin: 0; } /* Use text variable */
        body.dark-mode .todo-header h2 { color: var(--dm-text); } /* Use dark mode text variable */

        /* List/Graph view toggle buttons */
        .view-toggle { display: flex; gap: 0.5rem; }
        .view-toggle .btn {
             background-color: var(--lm-input-bg); color: var(--lm-secondary);
             padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 500; text-transform: none;
             letter-spacing: 0; box-shadow: none; border: 1px solid var(--lm-border);
        }
        .view-toggle .btn:hover { background-color: #e9ecef; border-color: var(--lm-primary); color: var(--lm-primary); }
        body.dark-mode .view-toggle .btn { background-color: rgba(255, 255, 255, 0.1); color: var(--dm-secondary); border-color: var(--dm-border); }
        body.dark-mode .view-toggle .btn:hover { background-color: rgba(255, 255, 255, 0.15); border-color: var(--dm-primary); color: var(--dm-primary); }

        /* Filters */
        .filters-container { margin-bottom: 1.5rem; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
        .filter-group {}
        .filter-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--lm-muted-text); }
        body.dark-mode .filter-label { color: var(--dm-muted-text); }
        .filter-select, .filter-date { padding: 0.65rem 0.75rem; font-size: 0.95rem; }
        .filter-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }

        /* Tasks & Graph Containers */
        .tasks-container {}
        .graph-container { min-height: 350px; display: none; flex-direction: row; gap: 1.5rem; flex-wrap: wrap; justify-content: space-around; margin-top: 1.25rem; }
        .graph-item { flex: 1 1 45%; min-width: 280px; border-radius: var(--border-radius); padding: 1.25rem; display: flex; justify-content: center; align-items: center; }
        .graph-item canvas { max-width: 100%; max-height: 300px; }

        /* Task List & Items */
        .task-list { list-style-type: none; }
        .task-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; border-radius: var(--border-radius); margin-bottom: 0.75rem;
            transition: background-color 0.3s ease, border-left-color 0.3s ease;
        }

        .task-item.completed .task-title { text-decoration: line-through; color: var(--lm-muted-text); }
        body.dark-mode .task-item.completed .task-title { color: var(--dm-muted-text); }

        .task-info { flex: 1; margin-right: 1rem; overflow: hidden; } /* Prevent text overflow */
        .task-title { font-weight: 600; margin-bottom: 0.25rem; color: inherit; transition: color 0.3s ease, text-decoration 0.3s ease; font-size: 1rem; word-break: break-word; } /* Allow long words to break */
        .task-details { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; font-size: 0.8rem; color: var(--lm-muted-text); }
        body.dark-mode .task-details { color: var(--dm-muted-text); }
        .task-detail { display: flex; align-items: center; gap: 0.25rem; }
        .task-detail i { font-size: 0.75rem; opacity: 0.8; }

        /* Task action buttons (toggle, edit, delete) */
        .task-actions { display: flex; gap: 0.25rem; align-items: center; }
        .task-actions .icon-btn { background-color: rgba(0, 0, 0, 0.03); color: var(--lm-muted-text); width: 36px; height: 36px; font-size: 1rem; } /* Smaller action buttons */
        .task-actions .icon-btn:hover { background-color: rgba(0, 0, 0, 0.06); color: var(--lm-primary); }
        .task-actions .delete-btn:hover { color: var(--lm-danger); } /* Red hover for delete */
        body.dark-mode .task-actions .icon-btn { background-color: rgba(255, 255, 255, 0.08); color: var(--dm-muted-text); }
        body.dark-mode .task-actions .icon-btn:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--dm-primary); }
        body.dark-mode .task-actions .delete-btn:hover { color: var(--dm-danger); }

        /* Status toggle switch */
        .toggle-switch { position: relative; width: 44px; height: 24px; margin-right: 0.5rem; } /* Smaller toggle */
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 24px; }
        body.dark-mode .slider { background-color: #555; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--lm-success); }
        body.dark-mode input:checked + .slider { background-color: var(--dm-success); }
        input:checked + .slider:before { transform: translateX(20px); } /* Adjusted translation for smaller size */

        /* Priority tags */
        .tag { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; border: 1px solid transparent; }
        .tag-high { background-color: var(--lm-tag-high-bg); color: var(--lm-tag-high-text); border-color: var(--lm-danger); }
        .tag-medium { background-color: var(--lm-tag-medium-bg); color: var(--lm-tag-medium-text); border-color: var(--lm-primary); }
        .tag-low { background-color: var(--lm-tag-low-bg); color: var(--lm-tag-low-text); border-color: var(--lm-secondary); }
        body.dark-mode .tag-high { background-color: var(--dm-tag-high-bg); color: var(--dm-tag-high-text); border-color: var(--dm-danger); }
        body.dark-mode .tag-medium { background-color: var(--dm-tag-medium-bg); color: var(--dm-tag-medium-text); border-color: var(--dm-primary); }
        body.dark-mode .tag-low { background-color: var(--dm-tag-low-bg); color: var(--dm-tag-low-text); border-color: var(--dm-secondary); }

        /* --- Insights Section --- */
        .insights-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .insight-card { border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .insight-title { font-size: 1.1rem; margin-bottom: 1.25rem; text-align: center; width: 100%; font-weight: 600; color: inherit; }
        .chart-container { height: 250px; width: 100%; position: relative; } /* Container for line chart */

        /* Task distribution by priority */
        .task-distribution { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; width: 100%; }
        .distribution-item { border-radius: var(--border-radius); padding: 1rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .distribution-item:hover { transform: translateY(-3px); }
        .distribution-title { font-weight: 500; margin-bottom: 0.25rem; font-size: 0.8rem; color: var(--lm-muted-text); }
        body.dark-mode .distribution-title { color: var(--dm-muted-text); }
        .distribution-count { font-size: 1.25rem; font-weight: 700; color: var(--lm-primary); }
        body.dark-mode .distribution-count { color: var(--dm-primary); }

        /* --- Notifications Popup --- */
        #notification-popup-container { position: fixed; bottom: 1rem; left: 1rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem; max-width: 320px; }
        .notification-popup {
            background-color: var(--notification-bg); color: var(--notification-text); padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); font-size: 0.9rem;
            opacity: 0; transform: translateX(-110%); animation: slideInFadeOut 5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .notification-popup i { font-size: 1rem; flex-shrink: 0; }
        @keyframes slideInFadeOut { 0% { opacity: 0; transform: translateX(-110%); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(-110%); } }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #aaa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        body.dark-mode ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        body.dark-mode ::-webkit-scrollbar-thumb { background: #666; }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* --- Import/Export Specific --- */
        #fileUploadContainer { display: flex; flex-direction: column; align-items: center; }
        #fileUpload { width: auto; } /* Don't force full width */

        /* --- Placeholder/Empty State --- */
        .no-tasks {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--lm-muted-text);
            font-style: italic;
        }
        body.dark-mode .no-tasks {
            color: var(--dm-muted-text);
        }

        /* --- Responsive Adjustments --- */

        /* Medium Screens (Tablets, ~992px and below) */
        @media (max-width: 992px) {
             /* Stack graph items vertically */
             .graph-container { flex-direction: column; align-items: center; }
             .graph-item { flex-basis: 90%; min-width: 0; } /* Take more width when stacked */
             /* Stack insight cards vertically */
             .insights-container { grid-template-columns: 1fr; }
             /* Adjust padding */
             .main-container { padding: 1.5rem; }
             header { padding: 0.75rem 1.5rem; }
        }

        /* Small Screens (Portrait Tablets & Large Phones, ~768px and below) */
        @media (max-width: 768px) {
            html { font-size: 15px; } /* Slightly smaller base font */
            header { padding: 0.75rem 1rem; }
            .main-container { padding: 1rem; }
            /* Allow 2 columns for stats/progress/filters if space allows */
            .stats-container, .progress-container, .filters-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
            /* Stack task item content vertically */
            .task-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; }
            .task-info { margin-right: 0; margin-bottom: 0.5rem; } /* Remove right margin when stacked */
            .task-actions { width: 100%; justify-content: flex-end; margin-top: 0.5rem; } /* Align actions to the right */
            /* Align action buttons left */
            .action-buttons { justify-content: flex-start; }
            /* Stack todo header items */
            .todo-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .view-toggle { width: 100%; justify-content: flex-start; } /* Align toggle left */
            /* Adjust modal width and padding */
            .modal-content { width: 95%; padding: 1.25rem; }
            .login-container { padding: 1.5rem; }
            /* Adjust filter grid for smaller screens */
            .filters-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        }

        /* Extra Small Screens (Phones, ~480px and below) */
        @media (max-width: 480px) {
            html { font-size: 14px; } /* Even smaller base font */
            .logo { font-size: 1.25rem; }
            /* Smaller header buttons and gap */
            .header-actions .btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
            .header-actions { gap: 0.5rem; }
            /* Smaller icon buttons */
            .icon-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            .badge { width: 16px; height: 16px; font-size: 0.6rem; }
            /* Smaller stat/progress values */
            .stat-value { font-size: 1.5rem; }
            .progress-value { font-size: 1.25rem; }
            /* Force single column for stats/progress */
            .stats-container, .progress-container { grid-template-columns: 1fr; }
            /* Adjust notification list position/width */
            .notification-list { width: calc(100% - 2rem); right: 1rem; top: 55px; }
            /* Adjust notification popup position */
            #notification-popup-container { left: 0.5rem; right: 0.5rem; bottom: 0.5rem; align-items: center; max-width: none; }
            .notification-popup { width: 100%; max-width: 300px; animation: fadeInFadeOutMobile 5s forwards; }
            /* Mobile-specific notification animation */
            @keyframes fadeInFadeOutMobile { 0% { opacity: 0; transform: translateY(50px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(50px); } }
            /* Make action buttons take more space */
            .action-buttons .btn { flex-grow: 1; font-size: 0.9rem; }
            /* Force single column for filters */
            .filters-grid { grid-template-columns: 1fr; }
            /* Smaller task details and tags */
            .task-details { font-size: 0.75rem; }
            .tag { font-size: 0.65rem; padding: 0.2rem 0.5rem; }
        }

        /* --- Flatpickr Theme Adjustments --- */
        /* Apply component background/border/shadow to calendar */
        .flatpickr-calendar { background: var(--lm-component-bg); border-radius: var(--border-radius); box-shadow: 0 5px 15px var(--lm-shadow-color); border: 1px solid var(--lm-border); width: auto; }
        body.dark-mode .flatpickr-calendar { background: var(--dm-component-bg); box-shadow: 0 5px 15px var(--dm-shadow-color); border-color: var(--dm-border); }
        /* Month/weekday header background */
        .flatpickr-months .flatpickr-month, .flatpickr-weekdays { background: var(--lm-input-bg); border-bottom: 1px solid var(--lm-border); }
        body.dark-mode .flatpickr-months .flatpickr-month, body.dark-mode .flatpickr-weekdays { background: var(--dm-input-bg); border-bottom-color: var(--dm-border); }
        /* Navigation/weekday text color */
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month, span.flatpickr-weekday { color: var(--lm-muted-text); }
        body.dark-mode .flatpickr-months .flatpickr-prev-month, body.dark-mode .flatpickr-months .flatpickr-next-month, body.dark-mode span.flatpickr-weekday { color: var(--dm-muted-text); }
        /* Navigation hover color */
        .flatpickr-months .flatpickr-prev-month:hover svg, .flatpickr-months .flatpickr-next-month:hover svg { fill: var(--lm-primary); }
        body.dark-mode .flatpickr-months .flatpickr-prev-month:hover svg, body.dark-mode .flatpickr-months .flatpickr-next-month:hover svg { fill: var(--dm-primary); }
        /* Current month/year text color */
        .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month input.cur-year { color: var(--lm-text); font-weight: bold; }
        body.dark-mode .flatpickr-current-month .flatpickr-monthDropdown-months, body.dark-mode .flatpickr-current-month input.cur-year { color: var(--dm-text); }
        /* Day text color */
        .flatpickr-day { color: var(--lm-text); border-color: transparent; }
        body.dark-mode .flatpickr-day { color: var(--dm-text); }
        /* Day hover state */
        .flatpickr-day:hover, .flatpickr-day.prevMonthDay:hover, .flatpickr-day.nextMonthDay:hover { background: var(--lm-input-bg); border-color: var(--lm-primary); color: var(--lm-primary); }
        body.dark-mode .flatpickr-day:hover, body.dark-mode .flatpickr-day.prevMonthDay:hover, body.dark-mode .flatpickr-day.nextMonthDay:hover { background: var(--dm-input-bg); border-color: var(--dm-primary); color: var(--dm-primary); }
        /* Selected/range day state */
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover { background: var(--lm-primary); border-color: var(--lm-primary); color: white; }
        body.dark-mode .flatpickr-day.selected, body.dark-mode .flatpickr-day.startRange, body.dark-mode .flatpickr-day.endRange, body.dark-mode .flatpickr-day.selected:hover, body.dark-mode .flatpickr-day.startRange:hover, body.dark-mode .flatpickr-day.endRange:hover { background: var(--dm-primary); border-color: var(--dm-primary); color: white; }
        /* In range day state */
        .flatpickr-day.inRange { background: rgba(0, 123, 255, 0.1); box-shadow: -5px 0 0 rgba(0, 123, 255, 0.1), 5px 0 0 rgba(0, 123, 255, 0.1); border-color: transparent; }
        body.dark-mode .flatpickr-day.inRange { background: rgba(88, 166, 255, 0.15); box-shadow: -5px 0 0 rgba(88, 166, 255, 0.15), 5px 0 0 rgba(88, 166, 255, 0.15); }
        /* Disabled/out-of-month day state */
        .flatpickr-day.flatpickr-disabled, .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: var(--lm-muted-text); opacity: 0.6; }
        body.dark-mode .flatpickr-day.flatpickr-disabled, body.dark-mode .flatpickr-day.prevMonthDay, body.dark-mode .flatpickr-day.nextMonthDay { color: var(--dm-muted-text); }

    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h1 class="login-title">Welcome to Todo App</h1>
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="input-field" placeholder="Enter your email">
        </div>
        <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" placeholder="Enter your password">
        </div>
        <button class="btn btn-block" id="loginBtn">Login</button>
        <p class="register-link">Don't have an account? <a id="registerLink">Register</a></p>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title">Create an Account</h2>
            <div class="input-group">
                <label for="regName">Full Name</label>
                <input type="text" id="regName" class="input-field" placeholder="Enter your full name">
            </div>
            <div class="input-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" class="input-field" placeholder="Enter your email">
            </div>
            <div class="input-group">
                <label for="regEmailConfirm">Confirm Email</label>
                <input type="email" id="regEmailConfirm" class="input-field" placeholder="Confirm your email">
            </div>
            <div class="input-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword" class="input-field" placeholder="Enter your password">
            </div>
            <div class="input-group">
                <label for="regPasswordConfirm">Confirm Password</label>
                <input type="password" id="regPasswordConfirm" class="input-field" placeholder="Confirm your password">
            </div>
            <div class="input-group">
                <label for="regCountry">Country</label>
                <select id="regCountry" class="input-field">
                    <option value="">Select your country</option>
                    <option value="USA">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="CA">Canada</option>
                    <option value="AU">Australia</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="JP">Japan</option>
                    <option value="IN">India</option>
                    <option value="BR">Brazil</option>
                    <option value="ZA">South Africa</option>
                    <option value="EG">Egypt</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelRegisterBtn">Cancel</button>
                <button class="btn btn-green" id="submitRegisterBtn">Register</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Create a New Task</h2>
            <div class="input-group">
                <label for="taskTitle">Task Title *</label>
                <input type="text" id="taskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="taskDetails">Add More Details</label>
                <textarea id="taskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea>
            </div>
            <div class="input-group">
                <label for="taskCategory">Task Category</label>
                <select id="taskCategory" class="input-field">
                    <option value="">Select category</option>
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Health">Health</option>
                    <option value="Education">Education</option>
                    <option value="Finance">Finance</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="taskPriority">Priority</label>
                <select id="taskPriority" class="input-field">
                    <option value="High">High</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="taskDueDate">Due Date</label>
                <input type="text" id="taskDueDate" class="input-field flatpickr-input" placeholder="YYYY-MM-DD or select date">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelTaskBtn">Cancel</button>
                <button class="btn btn-green" id="createTaskBtn">Create Task</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Edit Task</h2>
             <input type="hidden" id="editTaskId"> <div class="input-group">
                <label for="editTaskTitle">Task Title *</label>
                <input type="text" id="editTaskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="editTaskDetails">Add More Details</label>
                <textarea id="editTaskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea>
            </div>
            <div class="input-group">
                <label for="editTaskCategory">Task Category</label>
                <select id="editTaskCategory" class="input-field">
                     <option value="">Select category</option>
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Health">Health</option>
                    <option value="Education">Education</option>
                    <option value="Finance">Finance</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskPriority">Priority</label>
                <select id="editTaskPriority" class="input-field">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskDueDate">Due Date</label>
                <input type="text" id="editTaskDueDate" class="input-field flatpickr-input" placeholder="YYYY-MM-DD or select date">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelEditTaskBtn">Cancel</button>
                <button class="btn btn-green" id="saveTaskBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Deletion</h2>
            <p>Are you sure you want to delete the task: "<strong id="deleteTaskTitle"></strong>"?</p>
            <div class="modal-footer">
                <button class="btn" id="cancelDeleteBtn">No, Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2 class="modal-title">Export Tasks</h2>
            <p>Choose a format to export your tasks:</p>
            <div class="input-group">
                <label for="exportFormat">Export Format</label>
                <select id="exportFormat" class="input-field">
                    <option value="csv">CSV (Comma Separated Values)</option>
                    <option value="json">JSON (JavaScript Object Notation)</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-green" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2 class="modal-title">Import Tasks</h2>
            <div class="input-group">
                <label for="fileUpload">Select File (.csv, .json)</label>
                <input type="file" id="fileUpload" class="input-field" accept=".csv,.json">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-green" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <header>
            <div class="logo" id="refreshLogo" title="Refresh View">To-Do App</div>
            <div class="header-actions">
                <button class="icon-btn notification-badge" id="notificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </button>
                <div class="notification-list" id="notificationList">
                    <div class="notification-list-empty">No new notifications</div>
                    </div>
                <button class="icon-btn" id="themeToggleBtn" title="Toggle Theme">
                    <i class="fas fa-moon"></i> </button>
                <button class="btn" id="logoutBtn">Logout</button>
            </div>
        </header>

        <div class="main-container">
            <div class="action-buttons">
                <button class="btn btn-green" id="addTaskBtn">
                    <i class="fas fa-plus"></i> Add Task
                </button>
                <button class="btn" id="exportBtn">
                    <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn" id="importBtn">
                    <i class="fas fa-file-import"></i> Import
                </button>
            </div>

            <div class="stats-container">
                <div class="stat-card total">
                    <div class="stat-title">Total Tasks</div>
                    <div class="stat-value" id="totalTasksStat">0</div>
                </div>
                <div class="stat-card completed">
                    <div class="stat-title">Completed Tasks</div>
                    <div class="stat-value" id="completedTasksStat">0</div>
                </div>
                <div class="stat-card pending">
                    <div class="stat-title">Pending Tasks</div>
                    <div class="stat-value" id="pendingTasksStat">0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-item">
                    <div class="progress-title">Today</div>
                    <div class="progress-value" id="progressToday">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">This Week</div>
                    <div class="progress-value" id="progressWeek">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">This Month</div>
                    <div class="progress-value" id="progressMonth">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">Overall</div>
                    <div class="progress-value" id="progressOverall">0%</div>
                </div>
            </div>

            <div class="todo-section">
                <div class="todo-header">
                    <h2>Tasks</h2>
                    <div class="view-toggle">
                        <button class="btn" id="listViewBtn">List View</button>
                        <button class="btn" id="graphViewBtn">Graph View</button>
                    </div>
                </div>

                <div class="filters-container">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label" for="statusFilter">Status</label>
                            <select class="filter-select" id="statusFilter">
                                <option value="all">All</option>
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="dateFilter">Date Filter</label>
                            <select class="filter-select" id="dateFilter">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="filter-group custom-date-filter" id="customDateFilterGroup" style="display: none;">
                             <label class="filter-label">Custom Date Range</label>
                             <div style="display: flex; gap: 10px;">
                                <input type="text" id="customStartDate" class="filter-date flatpickr-input" placeholder="Start Date">
                                <input type="text" id="customEndDate" class="filter-date flatpickr-input" placeholder="End Date">
                             </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="categoryFilter">Categories</label>
                            <select class="filter-select" id="categoryFilter">
                                <option value="all">All</option>
                                <option value="Work">Work</option>
                                <option value="Personal">Personal</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Health">Health</option>
                                <option value="Education">Education</option>
                                <option value="Finance">Finance</option>
                                <option value="Home">Home</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="priorityFilter">Priority</label>
                            <select class="filter-select" id="priorityFilter">
                                <option value="all">All</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn" id="resetFiltersBtn">Reset Filters</button>
                    </div>
                </div>

                <div class="tasks-container" id="tasksContainer">
                    <ul class="task-list" id="taskList">
                        <li class="no-tasks">Loading tasks...</li>
                    </ul>
                </div>

                <div class="graph-container" id="graphContainer">
                    <div class="graph-item">
                        <canvas id="taskStatusChart"></canvas>
                    </div>
                    <div class="graph-item">
                        <canvas id="taskPriorityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="insights-container">
                <div class="insight-card">
                    <h3 class="insight-title">Task Completion Rate</h3>
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                <div class="insight-card">
                    <h3 class="insight-title">Task Distribution by Priority</h3>
                    <div class="task-distribution">
                        <div class="distribution-item">
                            <div class="distribution-title">High Priority</div>
                            <div class="distribution-count" id="highPriorityCount">0</div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-title">Medium Priority</div>
                            <div class="distribution-count" id="mediumPriorityCount">0</div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-title">Low Priority</div>
                            <div class="distribution-count" id="lowPriorityCount">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-popup-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const registerLink = document.getElementById('registerLink');
            const registerModal = document.getElementById('registerModal');
            const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
            const submitRegisterBtn = document.getElementById('submitRegisterBtn');
            const loginBtn = document.getElementById('loginBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const logoutBtn = document.getElementById('logoutBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const addTaskModal = document.getElementById('addTaskModal');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            const createTaskBtn = document.getElementById('createTaskBtn');
            const taskDueDateInput = document.getElementById('taskDueDate');
            const editTaskModal = document.getElementById('editTaskModal');
            const cancelEditTaskBtn = document.getElementById('cancelEditTaskBtn');
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            const editTaskDueDateInput = document.getElementById('editTaskDueDate');
            const editTaskIdInput = document.getElementById('editTaskId');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteTaskTitle = document.getElementById('deleteTaskTitle');
            const customStartDateInput = document.getElementById('customStartDate');
            const customEndDateInput = document.getElementById('customEndDate');
            const customDateFilterGroup = document.getElementById('customDateFilterGroup');
            const listViewBtn = document.getElementById('listViewBtn');
            const graphViewBtn = document.getElementById('graphViewBtn');
            const tasksContainer = document.getElementById('tasksContainer');
            const graphContainer = document.getElementById('graphContainer');
            const exportBtn = document.getElementById('exportBtn');
            const exportModal = document.getElementById('exportModal');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('importModal');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const fileUploadInput = document.getElementById('fileUpload');
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationList = document.getElementById('notificationList');
            const notificationCountBadge = document.getElementById('notificationCount');
            const notificationPopupContainer = document.getElementById('notification-popup-container');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const taskList = document.getElementById('taskList');
            const refreshLogo = document.getElementById('refreshLogo');

            // Stat & Progress Elements
            const totalTasksStat = document.getElementById('totalTasksStat');
            const completedTasksStat = document.getElementById('completedTasksStat');
            const pendingTasksStat = document.getElementById('pendingTasksStat');
            const progressToday = document.getElementById('progressToday');
            const progressWeek = document.getElementById('progressWeek');
            const progressMonth = document.getElementById('progressMonth');
            const progressOverall = document.getElementById('progressOverall');
            const highPriorityCount = document.getElementById('highPriorityCount');
            const mediumPriorityCount = document.getElementById('mediumPriorityCount');
            const lowPriorityCount = document.getElementById('lowPriorityCount');

            // --- State Variables ---
            let tasks = []; // Array to hold all task objects
            let notifications = []; // Array to hold notification objects
            let currentTaskIdToDelete = null; // ID of task pending deletion confirmation
            let flatpickrInstances = {}; // Object to hold Flatpickr instances

            // Chart instances (will be initialized later)
            let taskStatusChart, taskPriorityChart, completionChart;

            // --- Initialization ---
            loadTasks(); // Load tasks from localStorage or defaults
            loadNotifications(); // Load notifications from localStorage
            checkLoginStatus(); // Check if user is logged in
            initializeFlatpickr(); // Initialize date pickers
            applyInitialTheme(); // Apply saved theme or system preference
            renderAll(); // Initial render of UI elements

            // --- Functions ---

            // Local Storage Handling
            function saveTasks() {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }

            function loadTasks() {
                const storedTasks = localStorage.getItem('tasks');
                tasks = storedTasks ? JSON.parse(storedTasks) : getDefaultTasks();
                // Ensure dueDate format is consistent (YYYY-MM-DD)
                tasks.forEach(task => {
                    if (task.dueDate && !/^\d{4}-\d{2}-\d{2}$/.test(task.dueDate)) {
                        try {
                            // Attempt to parse and format potentially different date strings
                            task.dueDate = new Date(task.dueDate).toISOString().split('T')[0];
                        } catch (e) {
                            // If parsing fails, clear the due date
                            task.dueDate = '';
                            console.warn(`Invalid date format for task ID ${task.id}: ${task.dueDate}`);
                        }
                    }
                });
            }

             // Provides default tasks if none are in localStorage
             function getDefaultTasks() {
                return [
                    { id: 1, title: "Review Project Proposal", details: "Check feedback and finalize", status: "Pending", category: "Work", priority: "High", dueDate: getFutureDate(2) },
                    { id: 2, title: "Buy Groceries", details: "Milk, Eggs, Bread", status: "Pending", category: "Shopping", priority: "Medium", dueDate: getFutureDate(0) },
                    { id: 3, title: "Schedule Annual Checkup", details: "Call Dr. Smith's office", status: "Pending", category: "Health", priority: "Low", dueDate: getFutureDate(7) },
                    { id: 4, title: "Complete Chapter 3 Reading", details: "For online course", status: "Completed", category: "Education", priority: "Medium", dueDate: getFutureDate(-1) },
                    { id: 5, title: "Pay Rent", details: "Due by the 5th", status: "Completed", category: "Finance", priority: "High", dueDate: getFutureDate(-5) },
                ];
            }

            // Helper to get a date string (YYYY-MM-DD) 'days' from now
            function getFutureDate(days) {
                const date = new Date();
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            function saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }

            function loadNotifications() {
                const storedNotifications = localStorage.getItem('notifications');
                notifications = storedNotifications ? JSON.parse(storedNotifications) : [];
            }

            // Theme Handling
            function applyTheme(isDarkMode) {
                const icon = themeToggleBtn.querySelector('i');
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun'); // Change icon to sun
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon'); // Change icon to moon
                    localStorage.setItem('theme', 'light');
                }
                updateAllCharts(); // Update charts whenever theme changes to apply new colors
            }

            // Sets the theme on initial page load
            function applyInitialTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                // Use saved theme, or system preference if no theme saved, default to light
                applyTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));
            }

            // Login/Logout
            function checkLoginStatus() {
                if (localStorage.getItem('loggedIn') === 'true') {
                    showAppView(); // Show main app if logged in
                } else {
                    showLoginView(); // Show login screen if not logged in
                }
            }

            // Switches view to the main application
            function showAppView() {
                loginContainer.style.display = 'none';
                document.body.classList.add('app-view'); // Add class for app-specific body styles
                appContainer.style.display = 'block';
                tasksContainer.style.display = 'block'; // Show task list by default
                graphContainer.style.display = 'none'; // Hide graph view by default
                renderAll(); // Render content for the app view
            }

            // Switches view to the login screen
            function showLoginView() {
                appContainer.style.display = 'none';
                document.body.classList.remove('app-view'); // Remove app-specific body styles
                loginContainer.style.display = 'block';
                localStorage.removeItem('loggedIn'); // Clear logged-in flag
            }

            // Rendering - Main function to update UI elements
            function renderAll() {
                renderTasks(); // Update the task list based on filters
                renderNotifications(); // Update the notification dropdown
                updateStats(); // Update the stat cards
                updateProgress(); // Update the progress cards
                updateAllCharts(); // Update all charts (or create if first time)
            }

            // Renders the filtered list of tasks
            function renderTasks() {
                const filters = getFilters(); // Get current filter values
                // Filter the tasks array based on selected filters
                let filteredTasks = tasks.filter(task => {
                    // Status filter
                    if (filters.status !== 'all' && task.status !== filters.status) return false;
                    // Category filter
                    if (filters.category !== 'all' && task.category !== filters.category) return false;
                    // Priority filter
                    if (filters.priority !== 'all' && task.priority !== filters.priority) return false;
                    // Date filter
                    if (filters.date !== 'all') {
                        if (!task.dueDate) return false; // Skip tasks without due dates if filtering by date
                        const taskDueDate = new Date(task.dueDate + 'T00:00:00'); // Ensure time is start of day for comparison

                        if (filters.date === 'today') {
                            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                            if (taskDueDate < todayStart || taskDueDate > todayEnd) return false;
                        } else if (filters.date === 'week') {
                            const today = new Date();
                            const dayOfWeek = today.getDay(); // 0 (Sun) to 6 (Sat)
                            // Adjust to get Monday (1) as the start of the week
                            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                            const weekStart = new Date(today.setDate(diff)); weekStart.setHours(0, 0, 0, 0);
                            const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); weekEnd.setHours(23, 59, 59, 999);
                            if (taskDueDate < weekStart || taskDueDate > weekEnd) return false;
                        } else if (filters.date === 'month') {
                            const today = new Date();
                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1); monthStart.setHours(0, 0, 0, 0);
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0); monthEnd.setHours(23, 59, 59, 999); // Last day of month
                            if (taskDueDate < monthStart || taskDueDate > monthEnd) return false;
                        } else if (filters.date === 'custom' && filters.startDate && filters.endDate) {
                             const startDate = new Date(filters.startDate + 'T00:00:00');
                             const endDate = new Date(filters.endDate + 'T23:59:59'); // Include the whole end day
                             if (taskDueDate < startDate || taskDueDate > endDate) return false;
                        } else if (filters.date === 'custom' && (!filters.startDate || !filters.endDate)) {
                             // If custom range is selected but dates are missing, show no tasks
                             return false;
                        }
                    }
                    return true; // Task passes all filters
                });

                taskList.innerHTML = ''; // Clear previous list items

                if (filteredTasks.length === 0) {
                    // Display a message if no tasks match filters
                    taskList.innerHTML = '<li class="no-tasks">No tasks match the current filters.</li>';
                } else {
                    // Create and append list items for each filtered task
                    filteredTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = `task-item ${task.status.toLowerCase()}`; // Add 'completed' or 'pending' class
                        li.dataset.id = task.id; // Store task ID for event handling

                        // Use template literal for cleaner HTML structure
                        li.innerHTML = `
                            <div class="task-info">
                                <div class="task-title">${escapeHtml(task.title)}</div>
                                <div class="task-details">
                                    ${task.dueDate ? `<div class="task-detail"><i class="fas fa-calendar-alt"></i> Due: ${task.dueDate}</div>` : ''}
                                    ${task.category ? `<div class="task-detail"><i class="fas fa-folder"></i> ${escapeHtml(task.category)}</div>` : ''}
                                    <div class="task-detail">
                                        <span class="tag tag-${task.priority.toLowerCase()}">${escapeHtml(task.priority)}</span>
                                    </div>
                                </div>
                                ${task.details ? `<div style="font-size: 0.8rem; color: var(--lm-muted-text); margin-top: 0.25rem; opacity: 0.8;">${escapeHtml(task.details)}</div>` : ''}
                            </div>
                            <div class="task-actions">
                                <label class="toggle-switch" title="Mark as ${task.status === 'Completed' ? 'Pending' : 'Completed'}">
                                    <input type="checkbox" class="status-toggle" ${task.status === 'Completed' ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                                <button class="icon-btn edit-btn" title="Edit Task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete-btn" title="Delete Task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        taskList.appendChild(li);

                        // Add event listeners to the new task item's controls
                        li.querySelector('.status-toggle').addEventListener('change', handleStatusToggle);
                        li.querySelector('.edit-btn').addEventListener('click', handleEditClick);
                        li.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                    });
                }
                 updateStats(); // Update stats after rendering tasks
            }

            // Renders the notification dropdown list
            function renderNotifications() {
                const unreadCount = notifications.filter(n => !n.read).length;
                notificationCountBadge.textContent = unreadCount;
                notificationCountBadge.style.display = unreadCount > 0 ? 'flex' : 'none'; // Show badge only if unread > 0

                if (notifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-list-empty">No notifications</div>';
                    return;
                }

                notificationList.innerHTML = ''; // Clear previous notifications
                // Render notifications in reverse chronological order (newest first)
                [...notifications].reverse().forEach(note => {
                    const div = document.createElement('div');
                    div.className = `notification-item ${note.read ? '' : 'unread'}`; // Add 'unread' class if applicable
                    div.dataset.id = note.id; // Store notification ID
                    div.innerHTML = `
                        <div style="font-weight: ${note.read ? 'normal' : 'bold'}; margin-bottom: 3px;">${escapeHtml(note.message)}</div>
                        <div style="font-size: 0.7rem; color: var(--lm-muted-text); opacity: 0.8;">${timeAgo(note.timestamp)}</div>
                    `;

                    // Add click listener to mark notification as read
                    div.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        const notification = notifications.find(n => n.id === id);
                        if (notification && !notification.read) {
                            notification.read = true;
                            saveNotifications(); // Save the updated read status
                            renderNotifications(); // Re-render to update UI
                        }
                        // Optional: Could add navigation logic here if notifications link somewhere
                    });
                    notificationList.appendChild(div);
                });
            }

            // Stats & Progress Updates
             function updateStats() {
                const total = tasks.length;
                const completed = tasks.filter(task => task.status === 'Completed').length;
                const pending = total - completed;
                const high = tasks.filter(task => task.priority === 'High').length;
                const medium = tasks.filter(task => task.priority === 'Medium').length;
                const low = tasks.filter(task => task.priority === 'Low').length;

                // Update the text content of the stat elements
                totalTasksStat.textContent = total;
                completedTasksStat.textContent = completed;
                pendingTasksStat.textContent = pending;
                highPriorityCount.textContent = high;
                mediumPriorityCount.textContent = medium;
                lowPriorityCount.textContent = low;
            }

            // Updates the progress cards (Today, Week, Month, Overall)
            function updateProgress() {
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);

                const weekStart = new Date(todayStart);
                const dayOfWeek = todayStart.getDay();
                const diff = todayStart.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Monday start
                weekStart.setDate(diff);
                const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); weekEnd.setHours(23, 59, 59, 999);

                const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                const monthEnd = new Date(todayStart.getFullYear(), todayStart.getMonth() + 1, 0); monthEnd.setHours(23, 59, 59, 999);

                // Helper function to calculate completion rate for a given period
                const calculateRate = (start, end) => {
                    const relevantTasks = tasks.filter(task => {
                        if (!task.dueDate) return false; // Only consider tasks with due dates
                        const dueDate = new Date(task.dueDate + 'T00:00:00');
                        return dueDate >= start && dueDate <= end;
                    });
                    const completed = relevantTasks.filter(t => t.status === 'Completed').length;
                    // Avoid division by zero
                    return relevantTasks.length > 0 ? Math.round((completed / relevantTasks.length) * 100) : 0;
                };

                // Update progress text content
                progressToday.textContent = `${calculateRate(todayStart, todayEnd)}%`;
                progressWeek.textContent = `${calculateRate(weekStart, weekEnd)}%`;
                progressMonth.textContent = `${calculateRate(monthStart, monthEnd)}%`;

                // Calculate overall completion rate
                const overallCompleted = tasks.filter(t => t.status === 'Completed').length;
                const overallRate = tasks.length > 0 ? Math.round((overallCompleted / tasks.length) * 100) : 0;
                progressOverall.textContent = `${overallRate}%`;
            }

            // Charting
            // Destroys existing charts (if any) and recreates them
            function updateAllCharts() {
                 // Destroy charts before recreating to prevent memory leaks and rendering issues
                 if (taskStatusChart) taskStatusChart.destroy();
                 if (taskPriorityChart) taskPriorityChart.destroy();
                 if (completionChart) completionChart.destroy();

                 // Recreate charts with current data and theme colors
                 taskStatusChart = createTaskStatusChart();
                 taskPriorityChart = createTaskPriorityChart();
                 completionChart = createCompletionChart();
            }

            // Gets colors for charts based on current theme mode
            function getChartColors() {
                const isDark = document.body.classList.contains('dark-mode');

                // Define colors that change with mode
                const themeColors = {
                    gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.08)',
                    ticksColor: isDark ? 'var(--dm-muted-text)' : 'var(--lm-muted-text)',
                    legendColor: isDark ? 'var(--dm-text)' : 'var(--lm-text)', // Use main text color for legend
                    titleColor: isDark ? 'var(--dm-text)' : 'var(--lm-text)', // Use main text color for titles (white in dark mode) - UPDATED
                    primary: isDark ? 'var(--dm-primary)' : 'var(--lm-primary)',
                    componentBg: isDark ? 'var(--dm-component-bg)' : 'var(--lm-component-bg)'
                };

                // Combine theme-dependent colors with fixed graph colors defined in CSS variables
                return {
                    completed: getComputedStyle(document.documentElement).getPropertyValue('--graph-completed').trim(),
                    pending: getComputedStyle(document.documentElement).getPropertyValue('--graph-pending').trim(), // Use CSS var - UPDATED
                    high: getComputedStyle(document.documentElement).getPropertyValue('--graph-high').trim(),
                    medium: getComputedStyle(document.documentElement).getPropertyValue('--graph-medium').trim(),
                    low: getComputedStyle(document.documentElement).getPropertyValue('--graph-low').trim(),
                    ...themeColors // Merge theme colors
                };
            }

             // Creates the Task Status Doughnut Chart
             function createTaskStatusChart() {
                const completed = tasks.filter(task => task.status === 'Completed').length;
                const pending = tasks.filter(task => task.status === 'Pending').length;
                const colors = getChartColors(); // Get current theme/graph colors

                const data = {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        label: 'Tasks by Status',
                        data: [completed, pending],
                        // Use colors fetched from getChartColors
                        backgroundColor: [colors.completed, colors.pending], // UPDATED to use dark yellow for pending
                        borderColor: colors.componentBg, // Use component background for border separation
                        borderWidth: 2
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: colors.legendColor } // Use theme-dependent legend color
                        },
                        title: {
                            display: true,
                            text: 'Tasks by Status',
                            font: { size: 16 },
                            color: colors.titleColor // Use theme-dependent title color (white in dark mode) - CHECKED
                        }
                    }
                };

                 const ctx = document.getElementById('taskStatusChart')?.getContext('2d');
                 // Return the new Chart instance or null if context not found
                 return ctx ? new Chart(ctx, { type: 'doughnut', data, options }) : null;
            }

            // Creates the Task Priority Bar Chart
            function createTaskPriorityChart() {
                const high = tasks.filter(task => task.priority === 'High').length;
                const medium = tasks.filter(task => task.priority === 'Medium').length;
                const low = tasks.filter(task => task.priority === 'Low').length;
                const colors = getChartColors(); // Get current theme/graph colors

                const data = {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Tasks by Priority',
                        data: [high, medium, low],
                        // Use colors fetched from getChartColors
                        backgroundColor: [colors.high, colors.medium, colors.low],
                        borderColor: [colors.high, colors.medium, colors.low],
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Make it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: colors.ticksColor }, // Theme-dependent ticks
                            grid: { color: colors.gridColor } // Theme-dependent grid
                        },
                        y: {
                            ticks: { color: colors.ticksColor }, // Theme-dependent ticks
                            grid: { display: false } // Hide y-axis grid lines
                         }
                    },
                    plugins: {
                        legend: { display: false }, // Hide legend for bar chart
                        title: {
                            display: true,
                            text: 'Tasks by Priority',
                            font: { size: 16 },
                            color: colors.titleColor // Use theme-dependent title color (white in dark mode) - CHECKED
                        }
                    }
                };

                 const ctx = document.getElementById('taskPriorityChart')?.getContext('2d');
                 // Return the new Chart instance or null if context not found
                 return ctx ? new Chart(ctx, { type: 'bar', data, options }) : null;
            }

             // Creates the Completion Rate Line Chart
             function createCompletionChart() {
                 const rates = []; // Array to hold daily completion rates
                 const labels = []; // Array to hold date labels (MM-DD)
                 const today = new Date();
                 const colors = getChartColors(); // Get current theme/graph colors

                 // Calculate completion rate for the last 7 days
                 for (let i = 6; i >= 0; i--) {
                     const date = new Date(today);
                     date.setDate(today.getDate() - i);
                     const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                     labels.push(dateStr.substring(5)); // Add 'MM-DD' to labels

                     const dayStart = new Date(date); dayStart.setHours(0, 0, 0, 0);
                     const dayEnd = new Date(date); dayEnd.setHours(23, 59, 59, 999);

                     // Find tasks due on this specific day
                     const relevantTasks = tasks.filter(task => task.dueDate === dateStr);
                     const completed = relevantTasks.filter(t => t.status === 'Completed').length;
                     // Calculate rate, push 0 if no tasks were due that day
                     rates.push(relevantTasks.length > 0 ? (completed / relevantTasks.length) * 100 : 0);
                 }

                 const data = {
                     labels: labels,
                     datasets: [{
                         label: 'Completion Rate (%)',
                         data: rates,
                         fill: true, // Fill area under the line
                         // Use theme-dependent primary color with alpha for background
                         backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(88, 166, 255, 0.2)' : 'rgba(0, 123, 255, 0.1)',
                         borderColor: colors.primary, // Theme-dependent primary color for line
                         tension: 0.3, // Smooth the line curve
                         pointBackgroundColor: colors.primary, // Theme-dependent primary color for points
                         pointRadius: 4 // Size of points on the line
                     }]
                 };

                 const options = {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         y: {
                             beginAtZero: true, max: 100, // Y-axis from 0 to 100%
                             ticks: { callback: value => value + "%", color: colors.ticksColor }, // Add '%' suffix, theme-dependent color
                             grid: { color: colors.gridColor } // Theme-dependent grid
                         },
                         x: {
                             ticks: { color: colors.ticksColor }, // Theme-dependent ticks
                             grid: { display: false } // Hide x-axis grid lines
                         }
                     },
                     plugins: {
                         legend: { display: false }, // Hide legend
                         title: {
                             display: true,
                             text: 'Daily Task Completion Rate (Last 7 Days)',
                             font: { size: 16 },
                             color: colors.titleColor // Theme-dependent title color
                         }
                     }
                 };

                 const ctx = document.getElementById('completionChart')?.getContext('2d');
                 // Return the new Chart instance or null if context not found
                 return ctx ? new Chart(ctx, { type: 'line', data, options }) : null;
             }

            // Date Picker (Flatpickr) Initialization
            function initializeFlatpickr() {
                // Common options for all date pickers
                const commonOptions = {
                    dateFormat: "Y-m-d", // Set date format
                    allowInput: true, // Allow manual date input
                    // You can add more common options here
                };

                // Destroy existing instances before recreating (important for theme changes or re-renders)
                Object.values(flatpickrInstances).forEach(instance => instance.destroy());
                flatpickrInstances = {}; // Reset the instances object

                // Initialize pickers for Add Task and Edit Task modals
                flatpickrInstances.taskDueDate = flatpickr(taskDueDateInput, commonOptions);
                flatpickrInstances.editTaskDueDate = flatpickr(editTaskDueDateInput, commonOptions);

                // Initialize pickers for Custom Date Range filter
                flatpickrInstances.customStart = flatpickr(customStartDateInput, {
                    ...commonOptions,
                    onChange: function(selectedDates, dateStr, instance) {
                        // Set the minimum date for the end date picker
                        if (flatpickrInstances.customEnd) {
                             flatpickrInstances.customEnd.set('minDate', selectedDates[0]);
                             // Clear end date if it's before the new start date
                             if (flatpickrInstances.customEnd.selectedDates[0] && selectedDates[0] > flatpickrInstances.customEnd.selectedDates[0]) {
                                flatpickrInstances.customEnd.clear();
                             }
                        }
                         renderTasks(); // Re-render tasks when start date changes
                    }
                });
                flatpickrInstances.customEnd = flatpickr(customEndDateInput, {
                    ...commonOptions,
                     onChange: function(selectedDates, dateStr, instance) {
                         // Set the maximum date for the start date picker (optional)
                         // if (flatpickrInstances.customStart) {
                         //     flatpickrInstances.customStart.set('maxDate', selectedDates[0]);
                         // }
                         renderTasks(); // Re-render tasks when end date changes
                     }
                });
            }

            // Notifications
            // Adds a notification to the list and shows a popup
            function addNotification(message, type = 'info') {
                const newNotification = {
                    id: Date.now(), // Use timestamp as unique ID
                    message,
                    read: false, // New notifications are unread
                    timestamp: Date.now(),
                    type // 'info', 'success', 'warning', 'error'
                };
                notifications.push(newNotification);
                // Limit the number of stored notifications (optional)
                if (notifications.length > 50) {
                    notifications = notifications.slice(notifications.length - 50);
                }
                saveNotifications(); // Save updated list to localStorage
                renderNotifications(); // Update the notification dropdown UI
                showNotificationPopup(message, type); // Show the temporary popup
            }

            // Displays a short-lived notification popup at the bottom-left
            function showNotificationPopup(message, type = 'info') {
                const popup = document.createElement('div');
                popup.className = 'notification-popup';

                // Set icon based on notification type
                let iconClass = 'fa-info-circle'; // Default icon
                if (type === 'success') iconClass = 'fa-check-circle';
                else if (type === 'error') iconClass = 'fa-times-circle';
                else if (type === 'warning') iconClass = 'fa-exclamation-triangle';

                popup.innerHTML = `<i class="fas ${iconClass}"></i> <span>${escapeHtml(message)}</span>`;

                notificationPopupContainer.appendChild(popup);
                // Trigger reflow to enable animation (necessary after appending)
                void popup.offsetWidth;

                // Remove the popup after the animation duration (5 seconds)
                setTimeout(() => popup.remove(), 5000);
            }

            // Utility Functions
            // Basic HTML escaping to prevent XSS
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe; // Return non-strings as is
                return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
            }

             // Converts a timestamp to a user-friendly relative time string (e.g., "5m ago")
             function timeAgo(timestamp) {
                const now = new Date();
                const past = new Date(timestamp);
                const diffInSeconds = Math.floor((now - past) / 1000);
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                const diffInHours = Math.floor(diffInMinutes / 60);
                const diffInDays = Math.floor(diffInHours / 24);

                if (diffInSeconds < 60) return "just now";
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                if (diffInHours < 24) return `${diffInHours}h ago`;
                if (diffInDays < 7) return `${diffInDays}d ago`;
                // For older notifications, show the date
                return past.toLocaleDateString();
            }

            // Retrieves current filter values from the UI controls
            function getFilters() {
                return {
                    status: statusFilter.value,
                    date: dateFilter.value,
                    category: categoryFilter.value,
                    priority: priorityFilter.value,
                    startDate: customStartDateInput.value, // Get custom start date
                    endDate: customEndDateInput.value     // Get custom end date
                };
            }

            // Opens a modal dialog
            function openModal(modalElement) {
                 modalElement.style.display = 'flex'; // Show the modal overlay
                 // Focus the first input element in the modal for accessibility
                 const firstInput = modalElement.querySelector('input:not([type="hidden"]), select, textarea');
                 if (firstInput) setTimeout(() => firstInput.focus(), 50); // Delay focus slightly
            }

            // Closes a modal dialog
            function closeModal(modalElement) {
                modalElement.style.display = 'none'; // Hide the modal overlay
            }

            // --- Event Handlers ---

            // Login Button Click
            loginBtn.addEventListener('click', function() {
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                // --- !!! ---
                // WARNING: Basic, insecure login check. Replace with real authentication!
                // --- !!! ---
                if (email === 'test@example.com' && password === 'password123') {
                    localStorage.setItem('loggedIn', 'true'); // Set flag in localStorage
                    showAppView(); // Switch to the app view
                    addNotification('Login successful!', 'success');
                } else {
                    addNotification('Incorrect email or password.', 'error');
                }
            });

            // Register Link Click (opens registration modal)
            registerLink.addEventListener('click', () => openModal(registerModal));
            // Cancel Registration Button Click
            cancelRegisterBtn.addEventListener('click', () => closeModal(registerModal));
            // Submit Registration Button Click
            submitRegisterBtn.addEventListener('click', () => {
                // --- TODO: Add actual registration logic here ---
                // - Validate inputs (name, email format, password match, country)
                // - Send data to a server/backend
                // - Handle success/error responses
                // --- Placeholder ---
                closeModal(registerModal);
                addNotification('Account created successfully! Please login.', 'success');
            });

            // Logout Button Click
            logoutBtn.addEventListener('click', () => {
                showLoginView(); // Switch back to login view
                addNotification('Logged out successfully.', 'info');
            });

            // Theme Toggle Button Click
            themeToggleBtn.addEventListener('click', () => {
                // Toggle theme based on current body class
                applyTheme(!document.body.classList.contains('dark-mode'));
            });

            // Add Task Button Click (opens Add Task modal)
            addTaskBtn.addEventListener('click', () => {
                // Clear the form fields before opening
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDetails').value = '';
                document.getElementById('taskCategory').value = '';
                document.getElementById('taskPriority').value = 'Medium'; // Default priority
                flatpickrInstances.taskDueDate.clear(); // Clear date picker
                openModal(addTaskModal);
            });

            // Cancel Add Task Button Click
            cancelTaskBtn.addEventListener('click', () => closeModal(addTaskModal));

            // Create Task Button Click (in Add Task modal)
            createTaskBtn.addEventListener('click', function() {
                const title = document.getElementById('taskTitle').value.trim();
                if (!title) {
                    addNotification('Task title is required.', 'warning');
                    return; // Prevent creating task without a title
                }
                // Create new task object
                const newTask = {
                    id: Date.now(), // Use timestamp as unique ID
                    title,
                    details: document.getElementById('taskDetails').value.trim(),
                    status: "Pending", // New tasks are always pending
                    category: document.getElementById('taskCategory').value,
                    priority: document.getElementById('taskPriority').value,
                    dueDate: taskDueDateInput.value // Get date from Flatpickr input
                };
                tasks.push(newTask); // Add to the tasks array
                saveTasks(); // Save updated array to localStorage
                renderAll(); // Re-render the UI
                closeModal(addTaskModal); // Close the modal
                addNotification(`Task "${escapeHtml(title)}" created!`, 'success');
            });

            // Handler for Edit Button clicks on task items (delegated from taskList)
            function handleEditClick(event) {
                const taskItem = event.target.closest('.task-item'); // Find the parent task item
                const taskId = parseInt(taskItem.dataset.id); // Get task ID from data attribute
                const task = tasks.find(t => t.id === taskId); // Find the task object in the array
                if (task) {
                    // Populate the Edit Task modal with the task's data
                    editTaskIdInput.value = task.id; // Store ID in hidden input
                    document.getElementById('editTaskTitle').value = task.title;
                    document.getElementById('editTaskDetails').value = task.details;
                    document.getElementById('editTaskCategory').value = task.category;
                    document.getElementById('editTaskPriority').value = task.priority;
                    // Set the date in the Flatpickr instance for the edit modal
                    flatpickrInstances.editTaskDueDate.setDate(task.dueDate, false); // 'false' prevents triggering onChange
                    openModal(editTaskModal); // Open the modal
                }
            }

            // Cancel Edit Task Button Click
            cancelEditTaskBtn.addEventListener('click', () => closeModal(editTaskModal));

            // Save Task Button Click (in Edit Task modal)
            saveTaskBtn.addEventListener('click', function() {
                const taskId = parseInt(editTaskIdInput.value); // Get ID from hidden input
                const title = document.getElementById('editTaskTitle').value.trim();
                if (!title) {
                    addNotification('Task title is required.', 'warning');
                    return; // Prevent saving without a title
                }
                const taskIndex = tasks.findIndex(t => t.id === taskId); // Find the index of the task
                if (taskIndex > -1) {
                    // Update the task object in the array
                    tasks[taskIndex] = {
                        ...tasks[taskIndex], // Keep existing properties (like ID, status)
                        title,
                        details: document.getElementById('editTaskDetails').value.trim(),
                        category: document.getElementById('editTaskCategory').value,
                        priority: document.getElementById('editTaskPriority').value,
                        dueDate: editTaskDueDateInput.value // Get updated date
                    };
                    saveTasks(); // Save changes to localStorage
                    renderAll(); // Re-render the UI
                    closeModal(editTaskModal); // Close the modal
                    addNotification(`Task "${escapeHtml(title)}" updated!`, 'success');
                } else {
                    addNotification('Error updating task. Task not found.', 'error');
                }
            });

            // Handler for Delete Button clicks on task items (delegated from taskList)
            function handleDeleteClick(event) {
                const taskItem = event.target.closest('.task-item');
                currentTaskIdToDelete = parseInt(taskItem.dataset.id); // Store the ID to delete
                const task = tasks.find(t => t.id === currentTaskIdToDelete);
                if (task) {
                    // Show the task title in the confirmation modal
                    deleteTaskTitle.textContent = task.title;
                    openModal(deleteConfirmModal); // Open the confirmation modal
                }
            }

            // Cancel Delete Button Click (in confirmation modal)
            cancelDeleteBtn.addEventListener('click', () => {
                closeModal(deleteConfirmModal);
                currentTaskIdToDelete = null; // Clear the stored ID
            });

            // Confirm Delete Button Click (in confirmation modal)
            confirmDeleteBtn.addEventListener('click', function() {
                if (currentTaskIdToDelete) {
                    const taskIndex = tasks.findIndex(t => t.id === currentTaskIdToDelete);
                    if (taskIndex > -1) {
                        const deletedTaskTitle = tasks[taskIndex].title; // Get title for notification
                        tasks.splice(taskIndex, 1); // Remove the task from the array
                        saveTasks(); // Save changes to localStorage
                        renderAll(); // Re-render the UI
                        closeModal(deleteConfirmModal); // Close the modal
                        addNotification(`Task "${escapeHtml(deletedTaskTitle)}" deleted!`, 'success');
                        currentTaskIdToDelete = null; // Clear the stored ID
                    } else {
                        addNotification('Error deleting task. Task not found.', 'error');
                        closeModal(deleteConfirmModal);
                        currentTaskIdToDelete = null;
                    }
                }
            });

            // Handler for Status Toggle changes on task items (delegated from taskList)
            function handleStatusToggle(event) {
                const taskItem = event.target.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                const isChecked = event.target.checked; // Check if the toggle is now checked (Completed)
                if (task) {
                    task.status = isChecked ? 'Completed' : 'Pending'; // Update the task status
                    saveTasks(); // Save changes

                    // Update the task item's appearance directly for immediate feedback
                    taskItem.classList.toggle('completed', isChecked);
                    taskItem.classList.toggle('pending', !isChecked);
                    const titleElement = taskItem.querySelector('.task-title');
                    if (titleElement) {
                        titleElement.style.textDecoration = isChecked ? 'line-through' : 'none';
                        // Reset color to inherit from CSS (handles dark/light mode automatically)
                        titleElement.style.color = '';
                    }

                    addNotification(`Task "${escapeHtml(task.title)}" marked as ${task.status.toLowerCase()}.`, 'info');
                    // Update stats, progress, and charts after a short delay to allow UI to settle
                    setTimeout(() => {
                        updateStats();
                        updateProgress();
                        updateAllCharts();
                    }, 100); // 100ms delay
                }
            }

            // View Toggle Button Clicks
            listViewBtn.addEventListener('click', () => {
                tasksContainer.style.display = 'block'; // Show task list
                graphContainer.style.display = 'none'; // Hide graphs
            });
            graphViewBtn.addEventListener('click', () => {
                tasksContainer.style.display = 'none'; // Hide task list
                graphContainer.style.display = 'flex'; // Show graphs
                updateAllCharts(); // Ensure charts are up-to-date when switching
            });

            // Filter Change Listeners
            [statusFilter, categoryFilter, priorityFilter].forEach(el => el.addEventListener('change', renderTasks));
            // Special handling for date filter to show/hide custom range inputs
            dateFilter.addEventListener('change', function() {
                customDateFilterGroup.style.display = (dateFilter.value === 'custom') ? 'block' : 'none';
                // Clear custom dates if a non-custom option is selected
                if (dateFilter.value !== 'custom') {
                    flatpickrInstances.customStart.clear();
                    flatpickrInstances.customEnd.clear();
                }
                renderTasks(); // Re-render tasks when date filter changes
            });

            // Reset Filters Button Click
            resetFiltersBtn.addEventListener('click', function() {
                // Reset all filter dropdowns to 'all'
                statusFilter.value = 'all';
                dateFilter.value = 'all';
                categoryFilter.value = 'all';
                priorityFilter.value = 'all';
                // Hide custom date range and clear its inputs
                customDateFilterGroup.style.display = 'none';
                flatpickrInstances.customStart.clear();
                flatpickrInstances.customEnd.clear();
                renderTasks(); // Re-render with default filters
                addNotification('Filters reset.', 'info');
            });

            // Export Button Click (opens Export modal)
            exportBtn.addEventListener('click', () => openModal(exportModal));
            // Cancel Export Button Click
            cancelExportBtn.addEventListener('click', () => closeModal(exportModal));
            // Confirm Export Button Click
            confirmExportBtn.addEventListener('click', function() {
                const format = document.getElementById('exportFormat').value;
                let content, mimeType, extension;

                try {
                    if (format === 'csv') {
                        // Basic CSV escaping (handles commas and quotes within fields)
                        const escapeCsvField = (field) => {
                            const str = String(field == null ? '' : field); // Handle null/undefined
                            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                                return `"${str.replace(/"/g, '""')}"`; // Quote field and double internal quotes
                            }
                            return str;
                        };
                        const header = "ID,Title,Details,Status,Category,Priority,DueDate\n";
                        const rows = tasks.map(t =>
                            [t.id, t.title, t.details, t.status, t.category, t.priority, t.dueDate]
                            .map(escapeCsvField).join(',') // Escape each field
                        ).join('\n');
                        content = header + rows;
                        mimeType = 'text/csv;charset=utf-8;';
                        extension = 'csv';
                    } else if (format === 'json') {
                        content = JSON.stringify(tasks, null, 2); // Pretty-print JSON
                        mimeType = 'application/json;charset=utf-8;';
                        extension = 'json';
                    } else {
                        addNotification('Invalid export format selected.', 'warning');
                        return;
                    }

                    // Create a Blob and trigger download
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tasks_export_${new Date().toISOString().split('T')[0]}.${extension}`; // Filename with date
                    document.body.appendChild(a); // Append link to body
                    a.click(); // Simulate click to trigger download
                    document.body.removeChild(a); // Remove link
                    URL.revokeObjectURL(url); // Release object URL
                    closeModal(exportModal);
                    addNotification('Tasks exported successfully!', 'success');

                } catch (error) {
                    console.error("Export Error:", error);
                    addNotification(`Export failed: ${error.message}`, 'error');
                    closeModal(exportModal);
                }
            });

            // Import Button Click (opens Import modal)
            importBtn.addEventListener('click', () => {
                fileUploadInput.value = ''; // Clear previous file selection
                openModal(importModal);
            });
            // Cancel Import Button Click
            cancelImportBtn.addEventListener('click', () => closeModal(importModal));
            // Confirm Import Button Click
            confirmImportBtn.addEventListener('click', function() {
                const file = fileUploadInput.files[0];
                if (!file) {
                    addNotification('Please select a file to import.', 'warning');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        let importedTasks = [];
                        const fileContent = event.target.result;

                        if (file.name.toLowerCase().endsWith('.csv')) {
                            // --- Basic CSV Parsing (Assumes comma delimiter) ---
                            const lines = fileContent.split(/\r?\n/); // Split lines (handle Windows/Unix endings)
                            if (lines.length < 2) throw new Error("CSV file needs a header and at least one data row.");

                            // Extract headers (convert to lowercase for case-insensitive matching)
                            const headers = lines[0].trim().toLowerCase().split(',');
                            const requiredHeaders = ['title', 'status', 'priority'];
                            if (!requiredHeaders.every(h => headers.includes(h))) {
                                throw new Error(`CSV missing required headers: ${requiredHeaders.join(', ')}.`);
                            }

                            // Find indices of relevant columns
                            const indices = {
                                title: headers.indexOf('title'),
                                status: headers.indexOf('status'),
                                priority: headers.indexOf('priority'),
                                details: headers.indexOf('details'),
                                category: headers.indexOf('category'),
                                duedate: headers.indexOf('duedate'), // Note: lowercase header
                                id: headers.indexOf('id')
                            };

                            const existingIds = new Set(tasks.map(t => t.id)); // Keep track of existing IDs

                            for (let i = 1; i < lines.length; i++) {
                                if (!lines[i].trim()) continue; // Skip empty lines

                                // Very basic CSV value splitting - won't handle quoted commas correctly
                                const values = lines[i].split(',');

                                // Validate and sanitize imported data
                                const status = ['Completed', 'Pending'].includes(values[indices.status]) ? values[indices.status] : 'Pending';
                                const priority = ['High', 'Medium', 'Low'].includes(values[indices.priority]) ? values[indices.priority] : 'Medium';
                                const dueDate = (indices.duedate !== -1 && values[indices.duedate] && /^\d{4}-\d{2}-\d{2}$/.test(values[indices.duedate])) ? values[indices.duedate] : '';
                                let id = (indices.id !== -1 && values[indices.id] && !isNaN(parseInt(values[indices.id]))) ? parseInt(values[indices.id]) : Date.now() + i;

                                // Ensure unique ID
                                while (existingIds.has(id)) {
                                    id = Date.now() + i + Math.random(); // Add randomness if collision
                                }
                                existingIds.add(id);

                                const newTask = {
                                    id: id,
                                    title: values[indices.title] || `Untitled Task ${i}`,
                                    details: indices.details !== -1 ? values[indices.details] || '' : '',
                                    status: status,
                                    category: indices.category !== -1 ? values[indices.category] || '' : '',
                                    priority: priority,
                                    dueDate: dueDate
                                };
                                importedTasks.push(newTask);
                            }
                        } else if (file.name.toLowerCase().endsWith('.json')) {
                            // --- JSON Parsing ---
                            const parsedData = JSON.parse(fileContent);
                            if (!Array.isArray(parsedData)) throw new Error("JSON file must contain an array of tasks.");

                            const existingIds = new Set(tasks.map(t => t.id)); // Keep track of existing IDs

                            // Validate and sanitize each task object from JSON
                            importedTasks = parsedData.map((t, i) => {
                                // Basic validation
                                if (!t || typeof t !== 'object' || !t.title || !t.status || !t.priority) {
                                    console.warn(`Skipping invalid task object at index ${i} in JSON.`);
                                    return null; // Mark for removal
                                }

                                // Sanitize fields
                                const status = ['Completed', 'Pending'].includes(t.status) ? t.status : 'Pending';
                                const priority = ['High', 'Medium', 'Low'].includes(t.priority) ? t.priority : 'Medium';
                                const dueDate = (t.dueDate && /^\d{4}-\d{2}-\d{2}$/.test(t.dueDate)) ? t.dueDate : '';
                                let id = (t.id && !isNaN(parseInt(t.id))) ? parseInt(t.id) : Date.now() + i;

                                // Ensure unique ID
                                while (existingIds.has(id)) {
                                    id = Date.now() + i + Math.random();
                                }
                                existingIds.add(id);

                                return {
                                    id: id,
                                    title: String(t.title),
                                    details: String(t.details || ''),
                                    status: status,
                                    category: String(t.category || ''),
                                    priority: priority,
                                    dueDate: dueDate
                                };
                            }).filter(task => task !== null); // Remove invalid tasks marked as null

                        } else {
                            throw new Error("Unsupported file type. Please use .csv or .json.");
                        }

                        // Append imported tasks to the existing list
                        tasks = tasks.concat(importedTasks);
                        saveTasks(); // Save the combined list
                        renderAll(); // Re-render UI
                        closeModal(importModal); // Close the modal
                        addNotification(`${importedTasks.length} tasks imported successfully!`, 'success');

                    } catch (error) {
                        console.error("Import Error:", error);
                        addNotification(`Import failed: ${error.message}`, 'error');
                        // Keep modal open on error? Optional.
                        // closeModal(importModal);
                    }
                };
                reader.onerror = () => {
                    addNotification('Error reading the selected file.', 'error');
                    closeModal(importModal);
                };
                reader.readAsText(file); // Read the file content as text
            });

            // Notification Button Click (toggles dropdown visibility)
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent window click listener from closing it immediately
                notificationList.style.display = notificationList.style.display === 'block' ? 'none' : 'block';
            });

            // Logo Click (refreshes the view)
            refreshLogo.addEventListener('click', () => {
                renderAll(); // Re-render everything
                addNotification('View refreshed.', 'info');
            });

            // Global Click Listener (closes modals/dropdowns if clicked outside)
            window.addEventListener('click', (e) => {
                // Close notification list if clicked outside
                if (!notificationBtn.contains(e.target) && !notificationList.contains(e.target)) {
                    notificationList.style.display = 'none';
                }
                // Close any open modal if the click is on the modal background overlay
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // Global Keydown Listener (closes modals/dropdowns on Escape key)
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close any open modal
                    document.querySelectorAll('.modal').forEach(m => {
                        if (m.style.display === 'flex') closeModal(m);
                    });
                    // Close notification list
                    if (notificationList.style.display === 'block') {
                        notificationList.style.display = 'none';
                    }
                }
            });

        }); // End DOMContentLoaded
    </script>
</body>
</html>
