<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced To-Do App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a040f">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* --- Root Variables (Keep Existing Colors) --- */
        :root {
            /* --- Light Mode --- */
            --lm-page-bg-start: #6a040f; /* Dark Red */
            --lm-page-bg-end: #9d0208;   /* Slightly Lighter Red */
            --lm-component-bg: #ffffff; /* WHITE component background */
            --lm-text: #212529;     /* DARK text */
            --lm-muted-text: #6c757d; /* Grayish text */
            --lm-border: #dee2e6;   /* Light gray border */
            --lm-input-bg: #f8f9fa;  /* Very light gray input bg */
            --lm-input-border: #ced4da; /* Standard input border */
            --lm-shadow-color: rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --lm-btn-primary-bg: #9d0208; /* Red button */
            --lm-btn-primary-text: #ffffff;
            --lm-btn-secondary-bg: #6c757d; /* Gray button */
            --lm-btn-secondary-text: #ffffff;
            --lm-success: #198754;  /* Green */
            --lm-info: #0dcaf0;     /* Cyan */
            --lm-warning: #ffc107;  /* Yellow */
            --lm-danger: #dc3545;   /* Red */
            --lm-hover-bg: #e9ecef; /* Light gray hover */
            --lm-active-filter: #e9ecef; /* Active filter background */

            /* --- Dark Mode --- */
            --dm-page-bg-start: #1a1a1a; /* Very Dark Gray */
            --dm-page-bg-end: #2a2a2a;   /* Dark Gray */
            --dm-component-bg: #343a40; /* Dark component background */
            --dm-text: #f8f9fa;     /* LIGHT text */
            --dm-muted-text: #adb5bd; /* Light grayish text */
            --dm-border: #495057;   /* Gray border */
            --dm-input-bg: #495057;  /* Gray input bg */
            --dm-input-border: #6c757d; /* Darker input border */
            --dm-shadow-color: rgba(255, 255, 255, 0.05); /* Lighter shadow */
            --dm-btn-primary-bg: #ca6702; /* Orange button */
            --dm-btn-primary-text: #ffffff;
            --dm-btn-secondary-bg: #6c757d; /* Gray button */
            --dm-btn-secondary-text: #ffffff;
            --dm-success: #20c997;  /* Lighter Green */
            --dm-info: #66d9e8;     /* Lighter Cyan */
            --dm-warning: #ffdd57;  /* Lighter Yellow */
            --dm-danger: #ff6b6b;   /* Lighter Red */
            --dm-hover-bg: #495057; /* Gray hover */
            --dm-active-filter: #495057; /* Active filter background */
        }

        /* --- Apply Theme --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--lm-page-bg-start), var(--lm-page-bg-end));
            color: var(--lm-text);
            transition: background 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            box-sizing: border-box;
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dm-page-bg-start), var(--dm-page-bg-end));
            color: var(--dm-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--lm-component-bg);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--lm-shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        body.dark-mode .container {
            background-color: var(--dm-component-bg);
            box-shadow: 0 10px 30px var(--dm-shadow-color);
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--lm-border);
            padding-bottom: 15px;
            transition: border-color 0.3s ease;
        }
        body.dark-mode .header { border-color: var(--dm-border); }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--lm-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark-mode .header h1 { color: var(--dm-text); }
        .header h1 .fa-check-double { color: var(--lm-btn-primary-bg); }
        body.dark-mode .header h1 .fa-check-double { color: var(--dm-btn-primary-bg); }

        .header-controls { display: flex; align-items: center; gap: 15px; }

        .theme-switch-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .theme-switch { display: inline-block; height: 20px; position: relative; width: 40px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 20px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 16px; left: 2px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--lm-btn-primary-bg); }
        body.dark-mode input:checked + .slider { background-color: var(--dm-btn-primary-bg); }
        input:checked + .slider:before { transform: translateX(20px); }

        .notification-bell { position: relative; cursor: pointer; font-size: 1.2em; color: var(--lm-muted-text); }
        body.dark-mode .notification-bell { color: var(--dm-muted-text); }
        #notification-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: var(--lm-danger);
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 0.7em;
            font-weight: bold;
            display: none; /* Initially hidden */
        }
        body.dark-mode #notification-count { background-color: var(--dm-danger); }

        #notification-list {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            background-color: var(--lm-component-bg);
            border: 1px solid var(--lm-border);
            border-radius: 5px;
            box-shadow: 0 4px 15px var(--lm-shadow-color);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            font-size: 0.9em;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        body.dark-mode #notification-list {
            background-color: var(--dm-component-bg);
            border-color: var(--dm-border);
            box-shadow: 0 4px 15px var(--dm-shadow-color);
        }
        #notification-list li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--lm-border);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        body.dark-mode #notification-list li { border-bottom-color: var(--dm-border); }
        #notification-list li:last-child { border-bottom: none; }
        #notification-list li:hover { background-color: var(--lm-hover-bg); }
        body.dark-mode #notification-list li:hover { background-color: var(--dm-hover-bg); }
        #notification-list .notification-time { font-size: 0.8em; color: var(--lm-muted-text); display: block; margin-top: 3px; }
        body.dark-mode #notification-list .notification-time { color: var(--dm-muted-text); }
        #notification-list .notification-clear-all {
            display: block;
            text-align: center;
            padding: 8px;
            background-color: var(--lm-hover-bg);
            color: var(--lm-muted-text);
            font-weight: bold;
            cursor: pointer;
        }
        body.dark-mode #notification-list .notification-clear-all {
            background-color: var(--dm-hover-bg);
            color: var(--dm-muted-text);
        }
        #notification-list .notification-clear-all:hover { text-decoration: underline; }

        /* Refresh Logo */
        .refresh-logo {
            cursor: pointer;
            font-size: 1.2em;
            color: var(--lm-muted-text);
            transition: transform 0.5s ease;
        }
        body.dark-mode .refresh-logo { color: var(--dm-muted-text); }
        .refresh-logo:hover { transform: rotate(180deg); }

        /* --- Input Area (Keep existing, maybe hide initially) --- */
        .input-area { display: none; /* Hide initial input, use modal instead */ }

        /* --- Task Controls (New Section for Add/Import/Export) --- */
        .task-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px; /* Add some space */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .task-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            background-color: var(--lm-btn-secondary-bg);
            color: var(--lm-btn-secondary-text);
        }
        body.dark-mode .task-controls button {
            background-color: var(--dm-btn-secondary-bg);
            color: var(--dm-btn-secondary-text);
        }
        .task-controls button#add-task-btn {
            background-color: var(--lm-btn-primary-bg);
            color: var(--lm-btn-primary-text);
        }
        body.dark-mode .task-controls button#add-task-btn {
            background-color: var(--dm-btn-primary-bg);
            color: var(--dm-btn-primary-text);
        }
        .task-controls button:hover { opacity: 0.9; }
        .task-controls button:active { transform: scale(0.98); }
        /* Hide file input visually but keep accessible */
        #import-file-input { display: none; }

        /* --- Filters (Keep existing) --- */
        .filters {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .filters button {
            padding: 8px 15px;
            border: 1px solid var(--lm-border);
            background-color: transparent;
            color: var(--lm-muted-text);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        body.dark-mode .filters button {
            border-color: var(--dm-border);
            color: var(--dm-muted-text);
        }
        .filters button.active {
            background-color: var(--lm-active-filter);
            color: var(--lm-text);
            font-weight: bold;
            border-color: var(--lm-active-filter);
        }
        body.dark-mode .filters button.active {
            background-color: var(--dm-active-filter);
            color: var(--dm-text);
            border-color: var(--dm-active-filter);
        }
        .filters button:hover:not(.active) {
            background-color: var(--lm-hover-bg);
        }
        body.dark-mode .filters button:hover:not(.active) {
            background-color: var(--dm-hover-bg);
        }

        /* --- Tasks Layout Switcher (Keep existing) --- */
        .tasks-layout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px; /* Reduced bottom margin */
            border-bottom: 1px solid var(--lm-border);
            padding-bottom: 10px;
        }
        body.dark-mode .tasks-layout { border-color: var(--dm-border); }

        .tasks-layout h2 { margin: 0; font-size: 1.3em; color: var(--lm-text); }
        body.dark-mode .tasks-layout h2 { color: var(--dm-text); }
        .view-switch { display: flex; gap: 5px; }
        .view-switch button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            color: var(--lm-muted-text);
            border-radius: 4px;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        body.dark-mode .view-switch button { color: var(--dm-muted-text); }
        .view-switch button.active {
            color: var(--lm-btn-primary-bg);
            background-color: var(--lm-hover-bg);
        }
        body.dark-mode .view-switch button.active {
            color: var(--dm-btn-primary-bg);
            background-color: var(--dm-hover-bg);
        }

        /* --- Tasks Area --- */
        .tasks-area {
            margin-top: 5px; /* Reduced margin */
            position: relative; /* For positioning views */
            overflow: hidden; /* Contain views for animation */
            min-height: 300px; /* Ensure space during transitions */
        }

        /* Base view style */
        .view {
            position: absolute; /* Position views on top of each other */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 1;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(0);
        }

        /* Styles for inactive views (during transition) */
        .view.inactive.slide-left {
            opacity: 0;
            transform: translateX(-50px);
        }
        .view.inactive.slide-right {
            opacity: 0;
            transform: translateX(50px);
        }

        /* Ensure only the active view is interactive */
        .view.inactive {
            pointer-events: none;
            visibility: hidden; /* Hide completely when inactive */
            position: absolute; /* Keep it absolute */
            opacity: 0; /* Ensure it stays hidden */
        }
         .view.active {
            position: relative; /* Make active view flow normally */
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
            z-index: 1; /* Ensure active view is on top */
        }


        /* List View Specific Styles */
        #tasks-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border: 1px solid var(--lm-border);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--lm-component-bg);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.2s ease, transform 0.2s ease;
            position: relative; /* For selection overlay */
            cursor: pointer; /* Indicate clickable */
        }
        body.dark-mode .task-item {
            background-color: var(--dm-component-bg);
            border-color: var(--dm-border);
        }
        .task-item:hover {
             box-shadow: 0 2px 8px var(--lm-shadow-color);
             transform: translateY(-2px);
        }
         body.dark-mode .task-item:hover {
             box-shadow: 0 2px 8px var(--dm-shadow-color);
         }

        /* Multi-select checkbox */
        .task-item .task-select-checkbox {
            margin-right: 15px;
            cursor: pointer;
            transform: scale(1.2); /* Make checkbox slightly larger */
        }

        /* Task content */
        .task-item .task-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            overflow: hidden; /* Prevent long text overflow */
        }
        .task-item .task-text {
            font-size: 1em;
            word-break: break-word; /* Wrap long task names */
            color: var(--lm-text);
            transition: color 0.3s ease;
        }
         body.dark-mode .task-item .task-text { color: var(--dm-text); }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: var(--lm-muted-text);
        }
        body.dark-mode .task-item.completed .task-text { color: var(--dm-muted-text); }

        /* Task details (Priority, Category, Due Date) */
        .task-details {
            font-size: 0.8em;
            color: var(--lm-muted-text);
            margin-top: 5px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
         body.dark-mode .task-details { color: var(--dm-muted-text); }

        .task-details span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--lm-hover-bg);
        }
         body.dark-mode .task-details span { background-color: var(--dm-hover-bg); }

        .task-details .priority-low { color: #198754; } /* Green */
        .task-details .priority-medium { color: #ffc107; } /* Yellow */
        .task-details .priority-high { color: #dc3545; } /* Red */
         body.dark-mode .task-details .priority-low { color: #20c997; }
         body.dark-mode .task-details .priority-medium { color: #ffdd57; }
         body.dark-mode .task-details .priority-high { color: #ff6b6b; }

        .task-details .due-date-expired { color: var(--lm-danger); font-weight: bold; }
        .task-details .due-date-today { color: var(--lm-warning); font-weight: bold; }
         body.dark-mode .task-details .due-date-expired { color: var(--dm-danger); }
         body.dark-mode .task-details .due-date-today { color: var(--dm-warning); }
        .task-details .due-date-soon { color: var(--lm-info); }
        body.dark-mode .task-details .due-date-soon { color: var(--dm-info); }

        .task-item .task-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .task-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: var(--lm-muted-text);
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        body.dark-mode .task-actions button { color: var(--dm-muted-text); }
        .task-actions button:hover { color: var(--lm-text); background-color: var(--lm-hover-bg); }
        body.dark-mode .task-actions button:hover { color: var(--dm-text); background-color: var(--dm-hover-bg); }

        .task-actions .complete-btn { color: var(--lm-success); }
        body.dark-mode .task-actions .complete-btn { color: var(--dm-success); }
        .task-actions .complete-btn:hover { color: var(--lm-success); opacity: 0.8; }
        body.dark-mode .task-actions .complete-btn:hover { color: var(--dm-success); opacity: 0.8; }
        .task-item.completed .complete-btn .fa-check-circle { display: none; } /* Hide check when completed */
        .task-item.completed .complete-btn .fa-times-circle { display: inline-block; } /* Show uncheck when completed */
        .task-item:not(.completed) .complete-btn .fa-times-circle { display: none; } /* Hide uncheck when not completed */

        .task-actions .edit-btn { color: var(--lm-info); }
        body.dark-mode .task-actions .edit-btn { color: var(--dm-info); }
        .task-actions .delete-btn { color: var(--lm-danger); }
        body.dark-mode .task-actions .delete-btn { color: var(--dm-danger); }

        /* Task Item Selection Styling */
        .task-item.selected {
             border-color: var(--lm-btn-primary-bg);
             background-color: #fdf4f4; /* Slightly tinted background */
             box-shadow: 0 0 0 2px var(--lm-btn-primary-bg); /* Outline */
        }
        body.dark-mode .task-item.selected {
            border-color: var(--dm-btn-primary-bg);
            background-color: #4d3e3e; /* Darker tinted background */
            box-shadow: 0 0 0 2px var(--dm-btn-primary-bg);
        }

        /* Graph View Specific Styles */
        #tasks-graph {
            display: flex; /* Or grid, depending on graph type */
            justify-content: center;
            align-items: center;
            min-height: 300px; /* Ensure it takes space */
            border: 1px dashed var(--lm-border);
            border-radius: 8px;
            padding: 20px;
            color: var(--lm-muted-text);
        }
        body.dark-mode #tasks-graph {
            border-color: var(--dm-border);
            color: var(--dm-muted-text);
        }

        /* --- Modals (Add/Edit Task) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1050; /* High z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5); /* Dim background */
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
        }
        .modal-content {
            background-color: var(--lm-component-bg);
            margin: auto;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px; /* Limit max width */
            position: relative;
            transition: background-color 0.3s ease;
            animation: slideDown 0.3s ease-out;
        }
        body.dark-mode .modal-content { background-color: var(--dm-component-bg); }

        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--lm-border);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .modal-header { border-color: var(--dm-border); }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .close-btn {
            color: var(--lm-muted-text);
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0 5px;
        }
        body.dark-mode .close-btn { color: var(--dm-muted-text); }
        .close-btn:hover, .close-btn:focus { color: var(--lm-text); text-decoration: none; }
        body.dark-mode .close-btn:hover, body.dark-mode .close-btn:focus { color: var(--dm-text); }

        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: var(--lm-text);
        }
        body.dark-mode .modal-body label { color: var(--dm-text); }
        .modal-body input[type="text"],
        .modal-body input[type="date"], /* For flatpickr */
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--lm-input-border);
            border-radius: 5px;
            background-color: var(--lm-input-bg);
            color: var(--lm-text);
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .modal-body input[type="text"],
        body.dark-mode .modal-body input[type="date"],
        body.dark-mode .modal-body select,
        body.dark-mode .modal-body textarea {
            border-color: var(--dm-input-border);
            background-color: var(--dm-input-bg);
            color: var(--dm-text);
        }
         .modal-body input[type="date"] { cursor: pointer; } /* Indicate date field is clickable */

        .modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus {
            outline: none;
            border-color: var(--lm-btn-primary-bg);
            box-shadow: 0 0 0 2px rgba(157, 2, 8, 0.2); /* Match primary button */
        }
         body.dark-mode .modal-body input:focus,
         body.dark-mode .modal-body select:focus,
         body.dark-mode .modal-body textarea:focus {
            border-color: var(--dm-btn-primary-bg);
            box-shadow: 0 0 0 2px rgba(202, 103, 2, 0.2);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--lm-border);
        }
        body.dark-mode .modal-footer { border-color: var(--dm-border); }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .modal-footer .btn-primary { background-color: var(--lm-btn-primary-bg); color: var(--lm-btn-primary-text); }
        body.dark-mode .modal-footer .btn-primary { background-color: var(--dm-btn-primary-bg); color: var(--dm-btn-primary-text); }
        .modal-footer .btn-secondary { background-color: var(--lm-btn-secondary-bg); color: var(--lm-btn-secondary-text); }
        body.dark-mode .modal-footer .btn-secondary { background-color: var(--dm-btn-secondary-bg); color: var(--dm-btn-secondary-text); }
        .modal-footer button:hover { opacity: 0.9; }
        .modal-footer button:active { transform: scale(0.98); }

        /* --- Batch Actions Popup --- */
        #batch-actions-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--lm-component-bg);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px var(--lm-shadow-color);
            z-index: 1000;
            display: none; /* Hidden initially */
            align-items: center;
            gap: 15px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translate(-50%, 20px); /* Start position for animation */
        }
        body.dark-mode #batch-actions-popup {
            background-color: var(--dm-component-bg);
            box-shadow: 0 5px 20px var(--dm-shadow-color);
        }
        #batch-actions-popup.visible {
            display: flex;
            opacity: 1;
            transform: translateX(-50%);
        }
        #batch-actions-popup span { font-weight: bold; color: var(--lm-text); }
        body.dark-mode #batch-actions-popup span { color: var(--dm-text); }

        #batch-actions-popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #batch-actions-popup .batch-complete-btn { background-color: var(--lm-success); color: white; }
        body.dark-mode #batch-actions-popup .batch-complete-btn { background-color: var(--dm-success); color: var(--dm-text); }
        #batch-actions-popup .batch-delete-btn { background-color: var(--lm-danger); color: white; }
        body.dark-mode #batch-actions-popup .batch-delete-btn { background-color: var(--dm-danger); color: white; }
        #batch-actions-popup button:hover { opacity: 0.9; }
        #batch-actions-popup button:active { transform: scale(0.98); }

        /* --- General Purpose Notification --- */
        #general-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--lm-shadow-color);
            z-index: 2000;
            font-size: 0.95em;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(20px);
        }
         body.dark-mode #general-notification { box-shadow: 0 4px 15px var(--dm-shadow-color); }
        #general-notification.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        #general-notification.info { background-color: var(--lm-info); color: var(--lm-text); }
        #general-notification.success { background-color: var(--lm-success); color: white; }
        #general-notification.warning { background-color: var(--lm-warning); color: var(--lm-text); }
        #general-notification.error { background-color: var(--lm-danger); color: white; }
         body.dark-mode #general-notification.info { background-color: var(--dm-info); color: var(--dm-text); }
         body.dark-mode #general-notification.success { background-color: var(--dm-success); color: var(--dm-text); }
         body.dark-mode #general-notification.warning { background-color: var(--dm-warning); color: var(--dm-text); }
         body.dark-mode #general-notification.error { background-color: var(--dm-danger); color: white; }

         /* Subtle animation for task add/remove (optional) */
        .task-item-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .task-item-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .task-item-exit {
            opacity: 1;
        }
        .task-item-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header h1 { font-size: 1.5em; }
            .header-controls { align-self: flex-end; }
            .filters { gap: 5px; }
            .filters button { padding: 6px 10px; font-size: 0.8em; }
            .task-controls { gap: 5px; }
            .task-controls button { padding: 6px 10px; font-size: 0.8em; }
            .task-item { flex-direction: column; align-items: flex-start; gap: 8px; padding: 10px; }
            .task-item .task-select-checkbox { position: absolute; top: 10px; right: 10px; margin-right: 0; } /* Move checkbox */
            .task-item .task-content { margin-right: 0; width: 100%; } /* Take full width */
            .task-details { font-size: 0.75em; gap: 6px; }
            .task-item .task-actions { align-self: flex-end; /* Move actions to bottom right */ }
            .modal-content { width: 95%; padding: 20px; }
            .modal-header h2 { font-size: 1.3em; }
            .modal-footer { justify-content: space-between; } /* Space out buttons on mobile */
            #batch-actions-popup { width: 90%; bottom: 10px; left: 5%; transform: none; padding: 10px 15px; }
            #batch-actions-popup span { font-size: 0.9em; }
            #batch-actions-popup button { font-size: 0.8em; padding: 6px 10px; }
            .tasks-layout { flex-direction: column; align-items: flex-start; gap: 5px; }
            .view-switch { align-self: flex-end; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.3em; }
            .task-details span { padding: 1px 4px; font-size: 0.7em; }
            .task-actions button { font-size: 1em; }
            #general-notification { width: calc(100% - 40px); right: 10px; bottom: 10px; }
            #notification-list { width: calc(100% - 20px); right: 10px; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-check-double"></i> Enhanced To-Do</h1>
            <div class="header-controls">
                <i class="fas fa-sync-alt refresh-logo" title="Refresh View"></i>
                <div class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span id="notification-count">0</span>
                    <ul id="notification-list">
                        <li class="notification-clear-all">Clear All</li>
                    </ul>
                </div>
                <div class="theme-switch-wrapper">
                    <i class="fas fa-sun"></i>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </div>
        </div>

        <div class="tasks-layout">
             <h2>Tasks</h2>
             <div class="view-switch">
                <button id="list-view-btn" class="active" title="List View"><i class="fas fa-list"></i></button>
                <button id="graph-view-btn" title="Graph View (Placeholder)"><i class="fas fa-chart-pie"></i></button>
            </div>
        </div>

         <div class="task-controls">
            <button id="add-task-btn"><i class="fas fa-plus"></i> Add Task</button>
            <button id="export-tasks-btn"><i class="fas fa-file-export"></i> Export Tasks</button>
            <button id="import-tasks-btn"><i class="fas fa-file-import"></i> Import Tasks</button>
            <input type="file" id="import-file-input" accept=".json">
        </div>

        <div class="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="today">Today</button>
            <button data-filter="this_week">This Week</button>
            <button data-filter="this_month">This Month</button>
            <button data-filter="expired">Expired</button>
            <button data-filter="completed">Completed</button>
            <button data-filter="active">Active</button>
        </div>

        <div class="tasks-area">
            <ul id="tasks-list" class="view active">
                </ul>
            <div id="tasks-graph" class="view inactive">
                 Graph View Placeholder - Needs implementation (e.g., using Chart.js or D3.js) based on task data (priorities, completion status, etc.).
            </div>
        </div>

    </div> <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Task</h2>
                <button class="close-btn" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <input type="hidden" id="task-id"> <div class="form-group">
                        <label for="task-text">Task Description:</label>
                        <input type="text" id="task-text" placeholder="What needs to be done?" required>
                    </div>
                    <div class="form-group">
                        <label for="task-priority">Priority:</label>
                        <select id="task-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-category">Category:</label>
                        <input type="text" id="task-category" placeholder="e.g., Work, Personal, Shopping">
                    </div>
                    <div class="form-group">
                        <label for="task-due-date">Due Date:</label>
                        <input type="date" id="task-due-date" placeholder="Select date..."> </div>
                    <div class="form-group">
                         <label for="task-recurrence">Recurrence:</label>
                         <select id="task-recurrence">
                            <option value="none" selected>None</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn-primary" form="task-form" id="save-task-btn">Save Task</button>
            </div>
        </div>
    </div>

     <div id="batch-actions-popup">
        <span id="selected-count">0 tasks selected</span>
        <button class="batch-complete-btn" title="Mark Selected as Complete"><i class="fas fa-check-circle"></i> Complete</button>
        <button class="batch-delete-btn" title="Delete Selected Tasks"><i class="fas fa-trash-alt"></i> Delete</button>
    </div>

    <div id="general-notification">Notification message</div>


    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const taskList = document.getElementById('tasks-list');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const modalTitle = document.getElementById('modal-title');
            const saveTaskBtn = document.getElementById('save-task-btn');
            const taskTextInput = document.getElementById('task-text');
            const taskIdInput = document.getElementById('task-id');
            const taskPriorityInput = document.getElementById('task-priority');
            const taskCategoryInput = document.getElementById('task-category');
            const taskDueDateInput = document.getElementById('task-due-date');
            const taskRecurrenceInput = document.getElementById('task-recurrence');
            const filterButtons = document.querySelectorAll('.filters button');
            const listViewBtn = document.getElementById('list-view-btn');
            const graphViewBtn = document.getElementById('graph-view-btn');
            const tasksListView = document.getElementById('tasks-list');
            const tasksGraphView = document.getElementById('tasks-graph');
            const exportTasksBtn = document.getElementById('export-tasks-btn');
            const importTasksBtn = document.getElementById('import-tasks-btn');
            const importFileInput = document.getElementById('import-file-input');
            const notificationBtn = document.querySelector('.notification-bell');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const notificationClearAll = notificationList.querySelector('.notification-clear-all');
            const refreshLogo = document.querySelector('.refresh-logo');
            const generalNotification = document.getElementById('general-notification');
            const batchActionsPopup = document.getElementById('batch-actions-popup');
            const selectedCountSpan = document.getElementById('selected-count');
            const batchCompleteBtn = batchActionsPopup.querySelector('.batch-complete-btn');
            const batchDeleteBtn = batchActionsPopup.querySelector('.batch-delete-btn');

            // --- State Variables ---
            let tasks = [];
            let currentFilter = 'all';
            let currentView = 'list'; // 'list' or 'graph'
            let editingTaskId = null;
            let notifications = [];
            let notificationTimeout;
            let selectedTaskIds = new Set();

            // --- Initialize Flatpickr ---
            const datePicker = flatpickr(taskDueDateInput, {
                dateFormat: "Y-m-d",
                altInput: true, // Human-readable format
                altFormat: "F j, Y", // Display format
                allowInput: true, // Allow manual input
            });

            // --- Utility Functions ---
            const generateId = () => `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const formatDate = (dateString) => {
                if (!dateString) return 'No due date';
                const date = new Date(dateString + 'T00:00:00'); // Ensure parsing as local date
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            };
            const getRelativeDateClass = (dateString) => {
                 if (!dateString) return '';
                 const today = new Date();
                 today.setHours(0, 0, 0, 0); // Normalize today's date
                 const dueDate = new Date(dateString + 'T00:00:00'); // Normalize due date

                 if (dueDate < today) return 'due-date-expired';
                 if (dueDate.getTime() === today.getTime()) return 'due-date-today';

                 const tomorrow = new Date(today);
                 tomorrow.setDate(today.getDate() + 1);
                  if (dueDate.getTime() === tomorrow.getTime()) return 'due-date-soon'; // Highlight tomorrow

                 const nextWeek = new Date(today);
                 nextWeek.setDate(today.getDate() + 7);
                  if (dueDate < nextWeek) return 'due-date-soon'; // Highlight within a week

                 return '';
            };

            // --- Local Storage ---
            const saveTasks = () => {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            };

            const loadTasks = () => {
                const storedTasks = localStorage.getItem('tasks');
                if (storedTasks) {
                    try {
                        tasks = JSON.parse(storedTasks);
                        // Ensure date formats are consistent if needed (optional validation)
                         tasks.forEach(task => {
                             if (task.createdAt && typeof task.createdAt === 'string') {
                                 task.createdAt = new Date(task.createdAt); // Convert back to Date objects if stored as string
                             }
                              // Add missing properties for older data structures
                             if (task.priority === undefined) task.priority = 'medium';
                             if (task.category === undefined) task.category = '';
                             if (task.dueDate === undefined) task.dueDate = null;
                             if (task.isRecurring === undefined) task.isRecurring = false;
                             if (task.recurrenceRule === undefined) task.recurrenceRule = 'none';
                             if (task.id === undefined) task.id = generateId(); // Assign IDs if missing
                         });
                    } catch (e) {
                        console.error("Error loading tasks from localStorage:", e);
                        tasks = []; // Reset if invalid data
                        addNotification("Could not load tasks. Data might be corrupted.", "error");
                    }
                } else {
                    // Add sample tasks if storage is empty
                    addSampleTasks();
                }
            };

             // --- Sample Tasks ---
             const addSampleTasks = () => {
                const today = new Date();
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);

                const formatDateForInput = (date) => date.toISOString().split('T')[0];

                tasks = [
                    { id: generateId(), text: "Review project proposal", completed: false, createdAt: new Date(), priority: 'high', category: 'Work', dueDate: formatDateForInput(today), isRecurring: false, recurrenceRule: 'none' },
                    { id: generateId(), text: "Grocery shopping", completed: false, createdAt: new Date(), priority: 'medium', category: 'Personal', dueDate: null, isRecurring: false, recurrenceRule: 'none' },
                    { id: generateId(), text: "Pay monthly bills", completed: true, createdAt: new Date(), priority: 'high', category: 'Finance', dueDate: formatDateForInput(yesterday), isRecurring: false, recurrenceRule: 'none' },
                    { id: generateId(), text: "Prepare presentation slides", completed: false, createdAt: new Date(), priority: 'medium', category: 'Work', dueDate: formatDateForInput(tomorrow), isRecurring: false, recurrenceRule: 'none' },
                    { id: generateId(), text: "Plan weekend trip", completed: false, createdAt: new Date(), priority: 'low', category: 'Personal', dueDate: formatDateForInput(nextWeek), isRecurring: false, recurrenceRule: 'none' },
                    { id: generateId(), text: "Submit weekly report", completed: false, createdAt: new Date(), priority: 'high', category: 'Work', dueDate: formatDateForInput(yesterday), isRecurring: false, recurrenceRule: 'none' }, // Expired
                    { id: generateId(), text: "Daily Standup Meeting", completed: false, createdAt: new Date(), priority: 'medium', category: 'Work', dueDate: formatDateForInput(today), isRecurring: true, recurrenceRule: 'daily' }, // Recurring Daily
                ];
                saveTasks();
            };

            // --- General Purpose Notification ---
            const showGeneralNotification = (message, type = 'info', duration = 3000) => {
                generalNotification.textContent = message;
                generalNotification.className = `show ${type}`; // Reset classes and add new ones

                // Clear previous timeout if any
                clearTimeout(notificationTimeout);

                notificationTimeout = setTimeout(() => {
                    generalNotification.classList.remove('show');
                }, duration);
            };

            // --- In-App Notification System ---
            const addNotification = (message, type = 'info', isPersistent = false) => {
                const notification = { id: Date.now(), message, type, timestamp: new Date(), isPersistent };
                notifications.unshift(notification); // Add to the beginning
                renderNotifications();
                if (!isPersistent && type !== 'error' && type !== 'warning') {
                     // Optionally show a temporary popup for non-persistent, non-error/warning messages
                     // showGeneralNotification(message, type);
                }
                // Auto-remove non-persistent notifications after a while (e.g., 1 minute)
                if (!isPersistent) {
                    setTimeout(() => {
                        notifications = notifications.filter(n => n.id !== notification.id);
                        renderNotifications();
                    }, 60000); // 1 minute
                }
            };

            const renderNotifications = () => {
                notificationList.innerHTML = ''; // Clear existing
                const persistentNotifications = notifications.filter(n => n.isPersistent);
                const nonPersistentNotifications = notifications.filter(n => !n.isPersistent).slice(0, 10); // Limit non-persistent history

                const notificationsToDisplay = [...persistentNotifications, ...nonPersistentNotifications];

                notificationsToDisplay.forEach(n => {
                    const li = document.createElement('li');
                    li.dataset.id = n.id;
                    li.classList.add(`notification-${n.type}`); // Add class for potential styling
                    li.innerHTML = `
                        ${n.message}
                        <span class="notification-time">${n.timestamp.toLocaleTimeString()}</span>
                    `;
                    notificationList.appendChild(li);
                });

                // Add Clear All button if there are notifications
                 const clearBtnLi = document.createElement('li');
                 clearBtnLi.className = 'notification-clear-all';
                 clearBtnLi.textContent = 'Clear All Non-Persistent';
                 clearBtnLi.addEventListener('click', clearNonPersistentNotifications);
                 notificationList.appendChild(clearBtnLi);


                // Update badge count (only for persistent/important ones like due dates?)
                const importantNotificationCount = persistentNotifications.length;
                notificationCount.textContent = importantNotificationCount;
                notificationCount.style.display = importantNotificationCount > 0 ? 'inline-block' : 'none';
            };

             const clearNonPersistentNotifications = () => {
                 notifications = notifications.filter(n => n.isPersistent);
                 renderNotifications();
             };

            // --- Due Date Notifications ---
            const checkDueDates = () => {
                 const today = new Date(); today.setHours(0, 0, 0, 0);
                 const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                 const todayStr = today.toISOString().split('T')[0];
                 const tomorrowStr = tomorrow.toISOString().split('T')[0];

                 // Clear previous due date notifications
                 notifications = notifications.filter(n => !n.message.includes('Due today') && !n.message.includes('Due tomorrow'));

                 let upcomingCount = 0;

                 tasks.forEach(task => {
                     if (!task.completed && task.dueDate) {
                         if (task.dueDate === todayStr) {
                             addNotification(`Task "${task.text.substring(0, 20)}..." is due today!`, 'warning', true);
                             upcomingCount++;
                         } else if (task.dueDate === tomorrowStr) {
                             addNotification(`Task "${task.text.substring(0, 20)}..." is due tomorrow.`, 'info', true);
                             upcomingCount++;
                         }
                     }
                 });

                 renderNotifications(); // Re-render with new/cleared notifications
            };

            // --- Task Rendering ---
            const renderTasks = () => {
                taskList.innerHTML = ''; // Clear existing list

                const filteredTasks = filterTasks(tasks, currentFilter);

                if (filteredTasks.length === 0) {
                    taskList.innerHTML = '<li class="no-tasks-message" style="text-align: center; color: var(--lm-muted-text); padding: 20px;">No tasks match the current filter.</li>';
                     if (body.classList.contains('dark-mode')) {
                         taskList.querySelector('.no-tasks-message').style.color = 'var(--dm-muted-text)';
                     }
                    return;
                }

                filteredTasks.forEach(task => {
                    const li = document.createElement('li');
                    li.classList.add('task-item');
                    if (task.completed) li.classList.add('completed');
                    if (selectedTaskIds.has(task.id)) li.classList.add('selected'); // Add selected class
                    li.dataset.taskId = task.id;

                    const dueDateClass = getRelativeDateClass(task.dueDate);

                    li.innerHTML = `
                        <input type="checkbox" class="task-select-checkbox" ${selectedTaskIds.has(task.id) ? 'checked' : ''} title="Select Task">
                        <div class="task-content" title="Click to Edit">
                            <span class="task-text">${task.text}</span>
                            <div class="task-details">
                                <span class="priority priority-${task.priority}" title="Priority: ${task.priority}">
                                    <i class="fas ${task.priority === 'high' ? 'fa-exclamation-circle' : task.priority === 'medium' ? 'fa-minus-circle' : 'fa-info-circle'}"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                </span>
                                ${task.category ? `<span title="Category: ${task.category}"><i class="fas fa-tag"></i> ${task.category}</span>` : ''}
                                ${task.dueDate ? `<span class="${dueDateClass}" title="Due: ${formatDate(task.dueDate)}"><i class="fas fa-calendar-alt"></i> ${formatDate(task.dueDate)}</span>` : ''}
                                ${task.isRecurring && task.recurrenceRule !== 'none' ? `<span title="Recurring: ${task.recurrenceRule}"><i class="fas fa-redo"></i> ${task.recurrenceRule.charAt(0).toUpperCase() + task.recurrenceRule.slice(1)}</span>` : ''}
                             </div>
                        </div>
                        <div class="task-actions">
                            <button class="complete-btn" title="${task.completed ? 'Mark as Incomplete' : 'Mark as Complete'}">
                                <i class="fas fa-check-circle"></i> <i class="fas fa-times-circle"></i> </button>
                             <button class="edit-btn" title="Edit Task"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" title="Delete Task"><i class="fas fa-trash-alt"></i></button>
                         </div>
                    `;

                    // Add subtle enter animation (optional)
                    li.classList.add('task-item-enter');
                    requestAnimationFrame(() => {
                       requestAnimationFrame(() => { // Double requestAnimationFrame for better transition trigger
                         li.classList.add('task-item-enter-active');
                         li.classList.remove('task-item-enter');
                      });
                    });

                    taskList.appendChild(li);

                     // --- Event Listeners for Task Item ---
                     const checkbox = li.querySelector('.task-select-checkbox');
                     const contentDiv = li.querySelector('.task-content');

                     // Checkbox click handler
                     checkbox.addEventListener('change', (e) => {
                         toggleTaskSelection(task.id, e.target.checked);
                         e.stopPropagation(); // Prevent li click event when clicking checkbox
                     });

                     // Task item click handler (for editing or selecting if Ctrl/Cmd is pressed)
                     li.addEventListener('click', (e) => {
                         // Don't trigger if clicking on buttons or checkbox inside
                         if (e.target.closest('button') || e.target.closest('.task-select-checkbox')) {
                             return;
                         }

                         if (e.ctrlKey || e.metaKey) { // Cmd key on Mac
                             toggleTaskSelection(task.id, !selectedTaskIds.has(task.id));
                         } else {
                             // If not multi-selecting, open edit modal
                             openEditModal(task.id);
                         }
                     });

                    // Button listeners within the task item
                    li.querySelector('.complete-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleComplete(task.id); });
                    li.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditModal(task.id); });
                    li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); });

                }); // End forEach task

                updateBatchActionsPopup();
            };


            // --- Task Filtering ---
            const filterTasks = (tasksToFilter, filter) => {
                const now = new Date();
                now.setHours(0, 0, 0, 0); // Normalize today's date

                return tasksToFilter.filter(task => {
                    switch (filter) {
                        case 'completed':
                            return task.completed;
                        case 'active':
                            return !task.completed;
                        case 'today':
                            if (!task.dueDate) return false;
                            const dueDateToday = new Date(task.dueDate + 'T00:00:00');
                            return !task.completed && dueDateToday.getTime() === now.getTime();
                        case 'this_week':
                            if (!task.dueDate) return false;
                            const dueDateWeek = new Date(task.dueDate + 'T00:00:00');
                            const endOfWeek = new Date(now);
                            endOfWeek.setDate(now.getDate() + (6 - now.getDay()) + 1); // End of Sunday
                             endOfWeek.setHours(0, 0, 0, 0);
                            return !task.completed && dueDateWeek >= now && dueDateWeek < endOfWeek;
                        case 'this_month':
                             if (!task.dueDate) return false;
                             const dueDateMonth = new Date(task.dueDate + 'T00:00:00');
                             const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1); // First day of next month
                             endOfMonth.setHours(0, 0, 0, 0);
                            return !task.completed && dueDateMonth >= now && dueDateMonth < endOfMonth;
                         case 'expired':
                            if (!task.dueDate) return false;
                            const dueDateExpired = new Date(task.dueDate + 'T00:00:00');
                            return !task.completed && dueDateExpired < now;
                        case 'all':
                        default:
                            return true;
                    }
                });
            };

            // --- Task Actions ---
             const addTask = (text, priority, category, dueDate, recurrenceRule) => {
                if (text.trim() === '') {
                    showGeneralNotification('Task description cannot be empty.', 'warning');
                    return;
                }
                const newTask = {
                    id: generateId(),
                    text: text.trim(),
                    completed: false,
                    createdAt: new Date(),
                    priority: priority || 'medium',
                    category: category.trim() || '',
                    dueDate: dueDate || null,
                    isRecurring: recurrenceRule !== 'none',
                    recurrenceRule: recurrenceRule || 'none',
                };
                tasks.push(newTask);
                saveTasks();
                renderAll();
                showGeneralNotification('Task added successfully.', 'success');
             };

            const editTask = (id, newText, newPriority, newCategory, newDueDate, newRecurrenceRule) => {
                 if (newText.trim() === '') {
                    showGeneralNotification('Task description cannot be empty.', 'warning');
                    return;
                }
                 const taskIndex = tasks.findIndex(t => t.id === id);
                 if (taskIndex > -1) {
                     tasks[taskIndex] = {
                         ...tasks[taskIndex], // Keep existing properties like completed, createdAt
                         text: newText.trim(),
                         priority: newPriority,
                         category: newCategory.trim(),
                         dueDate: newDueDate || null,
                         isRecurring: newRecurrenceRule !== 'none',
                         recurrenceRule: newRecurrenceRule
                     };
                     saveTasks();
                     renderAll();
                     showGeneralNotification('Task updated successfully.', 'success');
                 } else {
                    showGeneralNotification('Task not found for editing.', 'error');
                 }
             };

            const deleteTask = (id) => {
                const taskText = tasks.find(t => t.id === id)?.text || 'Task';
                // Optional: Add a confirmation dialog here
                 if (confirm(`Are you sure you want to delete "${taskText.substring(0, 30)}..."?`)) {
                    tasks = tasks.filter(t => t.id !== id);
                    selectedTaskIds.delete(id); // Remove from selection if deleted
                    saveTasks();
                    renderAll(); // Re-render everything
                    showGeneralNotification('Task deleted.', 'info');
                 }
            };

            const getNextDueDate = (currentDueDate, rule) => {
                if (!currentDueDate || rule === 'none') return null;

                const date = new Date(currentDueDate + 'T00:00:00'); // Parse as local date
                if (isNaN(date)) return null; // Invalid date

                switch (rule) {
                    case 'daily':
                        date.setDate(date.getDate() + 1);
                        break;
                    case 'weekly':
                        date.setDate(date.getDate() + 7);
                        break;
                    case 'monthly':
                        date.setMonth(date.getMonth() + 1);
                        // Handle month rollovers carefully (e.g., Jan 31 + 1 month = Feb 28/29)
                         const originalDay = new Date(currentDueDate + 'T00:00:00').getDate();
                         if (date.getDate() !== originalDay) {
                             // If the day changed (e.g., Jan 31 -> Mar 3), go back to the last day of the correct month
                            date.setDate(0); // Sets to last day of previous month (which is the target month)
                         }
                        break;
                    default:
                        return currentDueDate; // No change if rule is unknown
                }
                 // Format back to YYYY-MM-DD string
                return date.toISOString().split('T')[0];
            };


            const toggleComplete = (id) => {
                 const taskIndex = tasks.findIndex(t => t.id === id);
                 if (taskIndex > -1) {
                     const task = tasks[taskIndex];
                     task.completed = !task.completed;

                     // Handle recurrence
                     if (task.completed && task.isRecurring && task.recurrenceRule !== 'none') {
                         // When completing a recurring task, calculate next due date and mark as incomplete
                         const nextDue = getNextDueDate(task.dueDate, task.recurrenceRule);
                         if (nextDue) {
                              // Option 1: Create a new task instance (keeps history) - More complex
                              // Option 2: Reschedule the current task (simpler)
                              task.dueDate = nextDue;
                              task.completed = false; // Reschedule it as active
                              showGeneralNotification(`Task "${task.text.substring(0,20)}..." rescheduled to ${formatDate(nextDue)}.`, 'info');
                         } else {
                             // Couldn't calculate next date, just mark as non-recurring completed
                              task.isRecurring = false;
                              task.recurrenceRule = 'none';
                              showGeneralNotification(`Task "${task.text.substring(0,20)}..." completed. Recurrence stopped.`, 'info');
                         }
                     } else if (!task.completed && task.isRecurring) {
                         // If un-completing a recurring task that was somehow marked completed without rescheduling
                         // (shouldn't happen with current logic, but good practice)
                         // Maybe just mark as incomplete without changing due date? Or reset to original logic?
                         // For now, just mark as incomplete.
                         showGeneralNotification(`Task "${task.text.substring(0,20)}..." marked as active.`, 'info');
                     } else {
                         // Standard non-recurring task completion toggle
                         showGeneralNotification(`Task ${task.completed ? 'completed' : 'marked as active'}.`, 'info');
                     }

                     saveTasks();
                     renderAll(); // Re-render tasks and potentially notifications
                 }
             };

            // --- Multi-Select Actions ---
             const toggleTaskSelection = (id, isSelected) => {
                 const taskItem = taskList.querySelector(`.task-item[data-task-id="${id}"]`);
                 if (!taskItem) return;

                 const checkbox = taskItem.querySelector('.task-select-checkbox');

                 if (isSelected) {
                     selectedTaskIds.add(id);
                     taskItem.classList.add('selected');
                     if (checkbox) checkbox.checked = true;
                 } else {
                     selectedTaskIds.delete(id);
                     taskItem.classList.remove('selected');
                     if (checkbox) checkbox.checked = false;
                 }
                 updateBatchActionsPopup();
             };

            const updateBatchActionsPopup = () => {
                 const count = selectedTaskIds.size;
                 if (count > 0) {
                     selectedCountSpan.textContent = `${count} task${count > 1 ? 's' : ''} selected`;
                     batchActionsPopup.classList.add('visible');
                 } else {
                     batchActionsPopup.classList.remove('visible');
                 }
             };

            const clearSelection = () => {
                selectedTaskIds.clear();
                 // Remove 'selected' class from all items
                 document.querySelectorAll('.task-item.selected').forEach(item => {
                     item.classList.remove('selected');
                     const checkbox = item.querySelector('.task-select-checkbox');
                     if (checkbox) checkbox.checked = false;
                 });
                 updateBatchActionsPopup();
            };

             const batchDelete = () => {
                 const count = selectedTaskIds.size;
                 if (count === 0) return;
                 if (confirm(`Are you sure you want to delete ${count} selected task${count > 1 ? 's' : ''}?`)) {
                     tasks = tasks.filter(task => !selectedTaskIds.has(task.id));
                     clearSelection(); // Clear selection after deleting
                     saveTasks();
                     renderAll();
                     showGeneralNotification(`${count} task${count > 1 ? 's' : ''} deleted.`, 'info');
                 }
             };

            const batchComplete = () => {
                 const count = selectedTaskIds.size;
                 if (count === 0) return;
                 let rescheduledCount = 0;
                 tasks.forEach(task => {
                     if (selectedTaskIds.has(task.id)) {
                         if (!task.completed) { // Only complete if not already completed
                             task.completed = true;
                              // Handle recurrence - reschedule if needed
                             if (task.isRecurring && task.recurrenceRule !== 'none') {
                                 const nextDue = getNextDueDate(task.dueDate, task.recurrenceRule);
                                 if (nextDue) {
                                      task.dueDate = nextDue;
                                      task.completed = false; // Reschedule active
                                      rescheduledCount++;
                                 } else {
                                     task.isRecurring = false; // Stop recurrence if next date fails
                                     task.recurrenceRule = 'none';
                                 }
                             }
                         }
                     }
                 });
                 const completedCount = count - rescheduledCount;
                 clearSelection(); // Clear selection after action
                 saveTasks();
                 renderAll();
                 let message = '';
                 if (completedCount > 0) {
                    message += `${completedCount} task${completedCount > 1 ? 's' : ''} marked as complete. `;
                 }
                  if (rescheduledCount > 0) {
                    message += `${rescheduledCount} recurring task${rescheduledCount > 1 ? 's' : ''} rescheduled.`;
                 }
                 showGeneralNotification(message.trim(), 'success');
             };

            // --- Modal Handling ---
            const openModal = (title = 'Add New Task') => {
                modalTitle.textContent = title;
                taskForm.reset(); // Clear form fields
                datePicker.clear(); // Clear flatpickr date
                taskIdInput.value = ''; // Clear hidden ID
                editingTaskId = null;
                taskModal.style.display = 'flex'; // Show modal
                taskTextInput.focus(); // Focus first field
            };

            const closeModal = (modalElement) => {
                if (modalElement) {
                    modalElement.style.display = 'none';
                }
                editingTaskId = null; // Clear editing state
            };

            const openEditModal = (id) => {
                const task = tasks.find(t => t.id === id);
                if (task) {
                    editingTaskId = id;
                    openModal('Edit Task'); // Open modal with 'Edit Task' title
                    taskIdInput.value = task.id;
                    taskTextInput.value = task.text;
                    taskPriorityInput.value = task.priority || 'medium';
                    taskCategoryInput.value = task.category || '';
                    datePicker.setDate(task.dueDate, false); // Set date without triggering change events initially
                    taskRecurrenceInput.value = task.recurrenceRule || 'none';
                 } else {
                     showGeneralNotification('Task not found.', 'error');
                 }
            };

            // --- Theme Toggling ---
            const applyTheme = (isDark) => {
                if (isDark) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
                 // Update elements that don't automatically inherit colors (e.g., specific messages)
                 const noTasksMsg = taskList.querySelector('.no-tasks-message');
                 if (noTasksMsg) {
                     noTasksMsg.style.color = isDark ? 'var(--dm-muted-text)' : 'var(--lm-muted-text)';
                 }
            };

            // --- View Switching ---
            const switchView = (view) => {
                if (view === currentView) return;

                const oldViewElement = currentView === 'list' ? tasksListView : tasksGraphView;
                const newViewElement = view === 'list' ? tasksListView : tasksGraphView;
                const oldBtn = currentView === 'list' ? listViewBtn : graphViewBtn;
                const newBtn = view === 'list' ? listViewBtn : graphViewBtn;

                const slideDirection = view === 'list' ? 'slide-right' : 'slide-left'; // List slides in from right, Graph from left

                // 1. Add inactive class and slide direction to the outgoing view
                oldViewElement.classList.add('inactive');
                 oldViewElement.classList.add(view === 'list' ? 'slide-right' : 'slide-left'); // Set direction for outgoing
                 oldViewElement.classList.remove('active');


                 // 2. Prepare the incoming view (remove inactive, set opposite slide direction initially, then remove)
                 newViewElement.classList.remove('inactive');
                 newViewElement.classList.remove('slide-left', 'slide-right'); // Clear any previous slide classes
                 newViewElement.classList.add(view === 'list' ? 'slide-left' : 'slide-right'); // Position it off-screen initially


                 // Force reflow before adding active class to trigger transition
                 void newViewElement.offsetWidth;

                 // 3. Make incoming view active and slide it in
                 newViewElement.classList.add('active');
                 newViewElement.classList.remove('slide-left', 'slide-right'); // Remove positioning class to slide in


                // Update button states
                oldBtn.classList.remove('active');
                newBtn.classList.add('active');

                currentView = view;
                localStorage.setItem('view', currentView); // Persist view preference

                 // Set timeout matching the transition duration to remove animation classes from inactive element
                 setTimeout(() => {
                    oldViewElement.classList.remove('slide-left', 'slide-right');
                 }, 500); // Match CSS transition duration
            };

             // --- Import / Export ---
             const exportTasks = () => {
                 if (tasks.length === 0) {
                    showGeneralNotification("No tasks to export.", "warning");
                    return;
                 }
                 try {
                     const dataStr = JSON.stringify(tasks, null, 2); // Pretty print JSON
                     const dataBlob = new Blob([dataStr], { type: 'application/json' });
                     const url = URL.createObjectURL(dataBlob);
                     const link = document.createElement('a');
                     link.href = url;
                     const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                     link.download = `tasks-export-${timestamp}.json`;
                     document.body.appendChild(link); // Required for Firefox
                     link.click();
                     document.body.removeChild(link);
                     URL.revokeObjectURL(url); // Clean up
                     showGeneralNotification("Tasks exported successfully.", "success");
                 } catch (error) {
                    console.error("Export Error:", error);
                    showGeneralNotification(`Export failed: ${error.message}`, "error");
                 }
             };

            const importTasks = (file) => {
                 if (!file) {
                     showGeneralNotification("No file selected for import.", "warning");
                     return;
                 }
                 if (file.type !== 'application/json') {
                     showGeneralNotification("Import failed: File must be a JSON file.", "error");
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = (event) => {
                     try {
                         const importedData = JSON.parse(event.target.result);
                         if (!Array.isArray(importedData)) {
                             throw new Error("Invalid format: Imported data is not an array.");
                         }

                         // Basic validation of imported tasks (can be extended)
                         const validTasks = [];
                         const invalidTasks = [];
                         importedData.forEach(item => {
                             if (item && typeof item.text === 'string' && typeof item.completed === 'boolean') {
                                 // Add default/missing fields if necessary
                                 validTasks.push({
                                     id: item.id || generateId(),
                                     text: item.text,
                                     completed: item.completed,
                                     createdAt: item.createdAt ? new Date(item.createdAt) : new Date(), // Ensure Date object
                                     priority: item.priority || 'medium',
                                     category: item.category || '',
                                     dueDate: item.dueDate || null,
                                     isRecurring: item.isRecurring !== undefined ? item.isRecurring : (item.recurrenceRule && item.recurrenceRule !== 'none'),
                                     recurrenceRule: item.recurrenceRule || 'none',
                                 });
                             } else {
                                 invalidTasks.push(item);
                             }
                         });

                         if (validTasks.length > 0) {
                             // Option: Replace existing tasks or merge? Let's merge for now.
                             tasks = tasks.concat(validTasks); // Append imported tasks
                             saveTasks();
                             renderAll();
                             let message = `${validTasks.length} task${validTasks.length > 1 ? 's' : ''} imported successfully.`;
                             if (invalidTasks.length > 0) {
                                 message += ` ${invalidTasks.length} invalid item(s) skipped.`;
                                 showGeneralNotification(message, "warning");
                             } else {
                                 showGeneralNotification(message, "success");
                             }
                         } else {
                              throw new Error("No valid tasks found in the imported file.");
                         }

                     } catch (error) {
                         console.error("Import Error:", error);
                         showGeneralNotification(`Import failed: ${error.message}`, "error");
                     } finally {
                          importFileInput.value = ''; // Reset file input
                     }
                 };
                 reader.onerror = () => {
                    showGeneralNotification('Error reading file.', 'error');
                     importFileInput.value = ''; // Reset file input
                 };
                 reader.readAsText(file);
             };


            // --- Render All (Tasks, Notifications, Popups) ---
            const renderAll = () => {
                renderTasks();
                renderNotifications();
                updateBatchActionsPopup(); // Ensure batch popup reflects current state
                checkDueDates(); // Check dates whenever rendering
            };

            // --- Event Listeners ---

            // Theme Toggle
            themeToggle.addEventListener('change', () => {
                applyTheme(themeToggle.checked);
            });

             // Modal Open/Close
             addTaskBtn.addEventListener('click', () => openModal());
             taskModal.addEventListener('click', (e) => {
                 // Close if clicked on background overlay
                 if (e.target === taskModal) {
                     closeModal(taskModal);
                 }
                 // Close if clicked on a button with data-dismiss="modal"
                 if (e.target.matches('[data-dismiss="modal"]')) {
                     closeModal(taskModal);
                 }
             });

             // Form Submission (Add/Edit)
            taskForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const id = taskIdInput.value;
                 const text = taskTextInput.value;
                 const priority = taskPriorityInput.value;
                 const category = taskCategoryInput.value;
                 const dueDate = taskDueDateInput.value; // Already in YYYY-MM-DD format from flatpickr
                 const recurrence = taskRecurrenceInput.value;

                 if (editingTaskId) {
                     editTask(editingTaskId, text, priority, category, dueDate, recurrence);
                 } else {
                     addTask(text, priority, category, dueDate, recurrence);
                 }
                 closeModal(taskModal);
            });

             // Filter Buttons
             filterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     filterButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     currentFilter = button.dataset.filter;
                     clearSelection(); // Clear selection when changing filter
                     renderTasks(); // Re-render tasks with the new filter
                 });
             });

            // View Switch Buttons
            listViewBtn.addEventListener('click', () => switchView('list'));
            graphViewBtn.addEventListener('click', () => switchView('graph'));

            // Import/Export Buttons
            exportTasksBtn.addEventListener('click', exportTasks);
            importTasksBtn.addEventListener('click', () => importFileInput.click()); // Trigger hidden file input
            importFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importTasks(e.target.files[0]);
                }
            });

             // Notifications Popup
             notificationBtn.addEventListener('click', (e) => {
                 e.stopPropagation(); // Prevent window click listener from closing it immediately
                 notificationList.style.display = notificationList.style.display === 'block' ? 'none' : 'block';
             });
             notificationClearAll.addEventListener('click', clearNonPersistentNotifications);


             // Refresh Button
             refreshLogo.addEventListener('click', () => {
                 renderAll();
                 showGeneralNotification('View refreshed.', 'info');
             });

             // Batch Action Buttons
             batchDeleteBtn.addEventListener('click', batchDelete);
             batchCompleteBtn.addEventListener('click', batchComplete);

            // Global Click Listener (for closing popups)
             window.addEventListener('click', (e) => {
                 // Close notification list if clicked outside
                 if (!notificationBtn.contains(e.target) && !notificationList.contains(e.target)) {
                     notificationList.style.display = 'none';
                 }
                 // Close modals on overlay click (already handled in modal listener, but keep as fallback)
                 if (e.target.classList.contains('modal')) {
                     closeModal(e.target);
                 }
                 // Deselect tasks if clicking outside the tasks list or batch popup
                if (!e.target.closest('.tasks-area') && !e.target.closest('#batch-actions-popup')) {
                   // Optional: Clear selection when clicking elsewhere
                   // clearSelection();
                }
             });

             // --- Keyboard Shortcuts ---
             window.addEventListener('keydown', (e) => {
                // Close modals/popups with Escape key
                 if (e.key === 'Escape') {
                     if (taskModal.style.display === 'flex') {
                         closeModal(taskModal);
                     } else if (notificationList.style.display === 'block') {
                         notificationList.style.display = 'none';
                     } else if (selectedTaskIds.size > 0) {
                         clearSelection(); // Clear selection on Escape if no modal is open
                     }
                     return; // Prevent other shortcuts if Escape was handled
                 }

                 // Add Task: Ctrl + N or Alt + N
                 if ((e.ctrlKey || e.altKey) && e.key.toLowerCase() === 'n') {
                     e.preventDefault();
                     if (taskModal.style.display !== 'flex') { // Don't open if already open
                         openModal();
                     }
                 }

                 // Delete Selected Task(s): Delete key
                 if (e.key === 'Delete' && selectedTaskIds.size > 0) {
                     // Ensure focus is not in an input field where Delete is needed for text editing
                     if (document.activeElement?.tagName !== 'INPUT' && document.activeElement?.tagName !== 'TEXTAREA') {
                         e.preventDefault();
                         batchDelete();
                     }
                 }

                  // Mark Selected Task(s) as Complete: Ctrl + Enter or Cmd + Enter
                  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && selectedTaskIds.size > 0) {
                     // Ensure focus is not in an input field/modal button
                     if (document.activeElement?.tagName !== 'INPUT' && document.activeElement?.tagName !== 'TEXTAREA' && !document.activeElement?.closest('.modal')) {
                        e.preventDefault();
                        batchComplete();
                     }
                 }

                  // Toggle Theme: Ctrl + T or Alt + T
                 if ((e.ctrlKey || e.altKey) && e.key.toLowerCase() === 't') {
                      e.preventDefault();
                      themeToggle.checked = !themeToggle.checked;
                      applyTheme(themeToggle.checked);
                  }

             });


            // --- Initialization ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                applyTheme(true);
            } else {
                applyTheme(false); // Default to light
            }

            const savedView = localStorage.getItem('view');
             if (savedView === 'graph') {
                 switchView('graph'); // Apply saved view preference
             }

            loadTasks(); // Load tasks from localStorage or add samples
            renderAll(); // Initial render

            // Check due dates periodically (e.g., every 5 minutes)
            setInterval(checkDueDates, 5 * 60 * 1000);

        }); // End DOMContentLoaded
    </script>
</body>
</html>
