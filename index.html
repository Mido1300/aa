<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/Babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .task-enter {
      opacity: 0;
      transform: translateY(-10px);
    }
    .task-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 300ms, transform 300ms;
    }
    .task-exit {
      opacity: 1;
    }
    .task-exit-active {
      opacity: 0;
      transition: opacity 300ms;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useContext, createContext, useRef } = React;

    // Task Context
    const TaskContext = createContext();

    // Utility Functions
    const generateId = () => crypto.randomUUID();
    const saveToLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const loadFromLocalStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];

    // Custom Hook for Tasks
    const useTasks = () => {
      const [tasks, setTasks] = useState(loadFromLocalStorage('tasks'));
      const [lastAction, setLastAction] = useState(null);

      useEffect(() => {
        saveToLocalStorage('tasks', tasks);
      }, [tasks]);

      const addTask = (task) => {
        const newTask = { ...task, id: generateId(), completed: false, createdAt: new Date().toISOString() };
        setTasks([...tasks, newTask]);
        setLastAction({ type: 'add', task: newTask });
      };

      const updateTask = (id, updates) => {
        const oldTask = tasks.find((t) => t.id === id);
        setTasks(tasks.map((t) => (t.id === id ? { ...t, ...updates } : t)));
        setLastAction({ type: 'update', task: oldTask, id });
      };

      const deleteTask = (id) => {
        const task = tasks.find((t) => t.id === id);
        setTasks(tasks.filter((t) => t.id !== id));
        setLastAction({ type: 'delete', task, id });
      };

      const undoLastAction = () => {
        if (!lastAction) return;
        if (lastAction.type === 'add') {
          setTasks(tasks.filter((t) => t.id !== lastAction.task.id));
        } else if (lastAction.type === 'delete') {
          setTasks([...tasks, lastAction.task]);
        } else if (lastAction.type === 'update') {
          setTasks(tasks.map((t) => (t.id === lastAction.id ? lastAction.task : t)));
        }
        setLastAction(null);
      };

      const batchDelete = (ids) => {
        const deletedTasks = tasks.filter((t) => ids.includes(t.id));
        setTasks(tasks.filter((t) => !ids.includes(t.id)));
        setLastAction({ type: 'batchDelete', tasks: deletedTasks });
      };

      const batchComplete = (ids) => {
        const updatedTasks = tasks.map((t) => (ids.includes(t.id) ? { ...t, completed: true } : t));
        setTasks(updatedTasks);
        setLastAction({ type: 'batchComplete', ids });
      };

      const reorderTasks = (reorderedTasks) => {
        setTasks(reorderedTasks);
      };

      return { tasks, addTask, updateTask, deleteTask, undoLastAction, batchDelete, batchComplete, reorderTasks };
    };

    // Task Provider
    const TaskProvider = ({ children }) => {
      const taskMethods = useTasks();
      return <TaskContext.Provider value={taskMethods}>{children}</TaskContext.Provider>;
    };

    // Auth Context
    const AuthContext = createContext();

    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);

      const login = (email, password) => {
        if (email && password) {
          setUser({ email });
          saveToLocalStorage('user', { email });
        }
      };

      const logout = () => {
        setUser(null);
        localStorage.removeItem('user');
      };

      useEffect(() => {
        const savedUser = loadFromLocalStorage('user');
        if (savedUser.email) setUser(savedUser);
      }, []);

      return <AuthContext.Provider value={{ user, login, logout }}>{children}</AuthContext.Provider>;
    };

    // Task Form Component
    const TaskForm = () => {
      const { addTask } = useContext(TaskContext);
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [dueDate, setDueDate] = useState('');
      const [category, setCategory] = useState('Work');
      const [priority, setPriority] = useState('Medium');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!title.trim()) return;
        addTask({ title, description, dueDate, category, priority });
        setTitle('');
        setDescription('');
        setDueDate('');
        setCategory('Work');
        setPriority('Medium');
      };

      return (
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-6">
          <h2 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Add Task</h2>
          <div className="space-y-4">
            <input
              type="text"
              placeholder="Task Title"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            />
            <textarea
              placeholder="Description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            />
            <input
              type="date"
              value={dueDate}
              onChange={(e) => setDueDate(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            />
            <select
              value={category}
              onChange={(e) => setCategory(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            >
              <option>Work</option>
              <option>Personal</option>
              <option>Other</option>
            </select>
            <select
              value={priority}
              onChange={(e) => setPriority(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            >
              <option>High</option>
              <option>Medium</option>
              <option>Low</option>
            </select>
            <button
              onClick={handleSubmit}
              className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
              Add Task
            </button>
          </div>
        </div>
      );
    };

    // Task List Component
    const TaskList = () => {
      const { tasks, updateTask, deleteTask, reorderTasks } = useContext(TaskContext);
      const [filter, setFilter] = useState('All');
      const [sort, setSort] = useState('Due Date');
      const [search, setSearch] = useState('');
      const [selectedTasks, setSelectedTasks] = useState([]);
      const [draggedTask, setDraggedTask] = useState(null);

      const filteredTasks = tasks
        .filter((task) => {
          if (filter === 'Active') return !task.completed;
          if (filter === 'Completed') return task.completed;
          return true;
        })
        .filter((task) => task.title.toLowerCase().includes(search.toLowerCase()) || task.description.toLowerCase().includes(search.toLowerCase()))
        .sort((a, b) => {
          if (sort === 'Due Date') return new Date(a.dueDate) - new Date(b.dueDate);
          if (sort === 'Priority') {
            const priorityOrder = { High: 3, Medium: 2, Low: 1 };
            return priorityOrder[b.priority] - priorityOrder[a.priority];
          }
          return 0;
        });

      const handleDragStart = (task) => {
        setDraggedTask(task);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (targetTask) => {
        if (!draggedTask || draggedTask.id === targetTask.id) return;
        const reordered = [...tasks];
        const draggedIndex = tasks.findIndex((t) => t.id === draggedTask.id);
        const targetIndex = tasks.findIndex((t) => t.id === targetTask.id);
        reordered.splice(draggedIndex, 1);
        reordered.splice(targetIndex, 0, draggedTask);
        reorderTasks(reordered);
        setDraggedTask(null);
      };

      return (
        <div>
          <div className="flex flex-col sm:flex-row gap-4 mb-6">
            <input
              type="text"
              placeholder="Search tasks..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="p-2 border rounded dark:bg-gray-700 dark:text-white flex-1"
            />
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="p-2 border rounded dark:bg-gray-700 dark:text-white"
            >
              <option>All</option>
              <option>Active</option>
              <option>Completed</option>
            </select>
            <select
              value={sort}
              onChange={(e) => setSort(e.target.value)}
              className="p-2 border rounded dark:bg-gray-700 dark:text-white"
            >
              <option>Due Date</option>
              <option>Priority</option>
            </select>
          </div>
          <div className="space-y-4">
            {filteredTasks.map((task) => (
              <div
                key={task.id}
                draggable
                onDragStart={() => handleDragStart(task)}
                onDragOver={handleDragOver}
                onDrop={() => handleDrop(task)}
                className="task-enter task-enter-active bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center gap-4"
              >
                <input
                  type="checkbox"
                  checked={selectedTasks.includes(task.id)}
                  onChange={() => setSelectedTasks((prev) => prev.includes(task.id) ? prev.filter((id) => id !== task.id) : [...prev, task.id])}
                  className="h-5 w-5"
                />
                <input
                  type="checkbox"
                  checked={task.completed}
                  onChange={() => updateTask(task.id, { completed: !task.completed })}
                  className="h-5 w-5"
                />
                <div className="flex-1">
                  <h3 className={`text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-900 dark:text-white'}`}>
                    {task.title}
                  </h3>
                  <p className="text-sm text-gray-600 dark:text-gray-300">{task.description}</p>
                  <p className="text-sm text-gray-500">Due: {task.dueDate || 'No due date'}</p>
                  <p className="text-sm text-gray-500">Category: {task.category}</p>
                  <p className="text-sm text-gray-500">Priority: {task.priority}</p>
                </div>
                <button
                  onClick={() => deleteTask(task.id)}
                  className="text-red-500 hover:text-red-700"
                >
                  Delete
                </button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Login Component
    const Login = () => {
      const { login } = useContext(AuthContext);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');

      const handleLogin = () => {
        login(email, password);
      };

      return (
        <div className="max-w-md mx-auto mt-10 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
          <h2 className="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">Login</h2>
          <div className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
            />
            <button
              onClick={handleLogin}
              className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
              Login
            </button>
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const { user, logout } = useContext(AuthContext);
      const { undoLastAction, batchDelete, batchComplete } = useContext(TaskContext);
      const [theme, setTheme] = useState('light');

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }, [theme]);

      const handleExport = () => {
        const data = JSON.stringify(loadFromLocalStorage('tasks'));
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tasks.json';
        a.click();
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          const tasks = JSON.parse(event.target.result);
          saveToLocalStorage('tasks', tasks);
          window.location.reload();
        };
        reader.readAsText(file);
      };

      if (!user) return <Login />;

      return (
        <div className="max-w-4xl mx-auto p-6">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Todo App</h1>
            <div className="flex gap-4">
              <button
                onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                className="p-2 rounded bg-gray-200 dark:bg-gray-700"
              >
                {theme === 'light' ? '🌙' : '☀️'}
              </button>
              <button onClick={handleExport} className="p-2 rounded bg-blue-500 text-white">
                Export
              </button>
              <label className="p-2 rounded bg-blue-500 text-white cursor-pointer">
                Import
                <input type="file" accept=".json" onChange={handleImport} className="hidden" />
              </label>
              <button onClick={logout} className="p-2 rounded bg-red-500 text-white">
                Logout
              </button>
            </div>
          </div>
          <TaskForm />
          <div className="flex gap-4 mb-4">
            <button
              onClick={undoLastAction}
              className="p-2 rounded bg-yellow-500 text-white"
            >
              Undo
            </button>
            <button
              onClick={() => batchDelete([])}
              className="p-2 rounded bg-red-500 text-white"
            >
              Delete Selected
            </button>
            <button
              onClick={() => batchComplete([])}
              className="p-2 rounded bg-green-500 text-white"
            >
              Complete Selected
            </button>
          </div>
          <TaskList />
        </div>
      );
    };

    // Render App
    const Root = () => (
      <AuthProvider>
        <TaskProvider>
          <App />
        </TaskProvider>
      </AuthProvider>
    );

    ReactDOM.render(<Root />, document.getElementById('root'));
  </script>
</body>
</html>
