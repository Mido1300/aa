<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo List App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react,typescript">
    // Types
    type Task = {
      id: string;
      title: string;
      description?: string;
      dueDate?: string;
      category?: string;
      priority?: 'High' | 'Medium' | 'Low';
      completed: boolean;
      userId: string;
    };

    type Category = {
      id: string;
      name: string;
      userId: string;
    };

    type User = {
      id: string;
      name: string;
      email: string;
      password: string;
    };

    // Context
    const ThemeContext = React.createContext({
      theme: 'light',
      toggleTheme: () => {},
    });

    const AuthContext = React.createContext({
      user: null,
      login: (email, password) => false,
      register: (user) => false,
      logout: () => {},
    });

    // Custom Hooks
    const useLocalStorage = (key, initialValue) => {
      const [value, setValue] = React.useState(() => {
        try {
          const stored = localStorage.getItem(key);
          return stored ? JSON.parse(stored) : initialValue;
        } catch {
          return initialValue;
        }
      });

      React.useEffect(() => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }, [value]);

      return [value, setValue];
    };

    // Sample Data
    const sampleTasks = [
      { id: '1', title: 'Buy groceries', description: 'Milk, eggs, bread', dueDate: '2025-04-18', category: 'Personal', priority: 'Medium', completed: false, userId: '' },
      { id: '2', title: 'Finish report', dueDate: '2025-04-17', category: 'Work', priority: 'High', completed: false, userId: '' },
      { id: '3', title: 'Call mom', category: 'Personal', priority: 'Low', completed: true, userId: '' },
      { id: '4', title: 'Plan vacation', description: 'Check flights and hotels', dueDate: '2025-04-20', category: 'Personal', priority: 'Medium', completed: false, userId: '' },
      { id: '5', title: 'Team meeting', dueDate: '2025-04-17', category: 'Work', priority: 'High', completed: false, userId: '' },
      { id: '6', title: 'Gym session', dueDate: '2025-04-17', category: 'Health', priority: 'Medium', completed: false, userId: '' },
      { id: '7', title: 'Read book', category: 'Personal', priority: 'Low', completed: false, userId: '' },
      { id: '8', title: 'Pay bills', dueDate: '2025-04-19', category: 'Finance', priority: 'High', completed: false, userId: '' },
      { id: '9', title: 'Clean house', category: 'Personal', priority: 'Medium', completed: false, userId: '' },
      { id: '10', title: 'Update resume', category: 'Work', priority: 'Low', completed: true, userId: '' },
    ];

    const sampleCategories = [
      { id: '1', name: 'Personal', userId: '' },
      { id: '2', name: 'Work', userId: '' },
      { id: '3', name: 'Health', userId: '' },
      { id: '4', name: 'Finance', userId: '' },
    ];

    // Components
    const TaskItem = ({ task, onToggle, onDelete, onEdit }) => {
      return (
        <li className="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg shadow mb-2 transition-all">
          <input
            type="checkbox"
            checked={task.completed}
            onChange={() => onToggle(task.id)}
            className="mr-4"
          />
          <div className="flex-1">
            <h3 className={`text-lg ${task.completed ? 'line-through text-gray-500' : ''}`}>
              {task.title}
            </h3>
            {task.description && <p className="text-sm text-gray-600 dark:text-gray-400">{task.description}</p>}
            {task.dueDate && (
              <p className="text-sm text-gray-500 dark:text-gray-400">
                Due: {new Date(task.dueDate).toLocaleDateString()}
              </p>
            )}
            {task.category && <p className="text-sm text-blue-500">{task.category}</p>}
            {task.priority && (
              <p className={`text-sm ${task.priority === 'High' ? 'text-red-500' : task.priority === 'Medium' ? 'text-yellow-500' : 'text-green-500'}`}>
                Priority: {task.priority}
              </p>
            )}
          </div>
          <div>
            <button
              onClick={() => onEdit(task)}
              className="text-blue-500 mr-2"
            >
              Edit
            </button>
            <button
              onClick={() => onDelete(task.id)}
              className="text-red-500"
            >
              Delete
            </button>
          </div>
        </li>
      );
    };

    const TaskForm = ({ onSubmit, categories, initialTask, onCancel }) => {
      const [title, setTitle] = React.useState(initialTask?.title || '');
      const [description, setDescription] = React.useState(initialTask?.description || '');
      const [dueDate, setDueDate] = React.useState(initialTask?.dueDate || '');
      const [category, setCategory] = React.useState(initialTask?.category || '');
      const [priority, setPriority] = React.useState(initialTask?.priority || '');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!title.trim()) return;
        onSubmit({ title, description, dueDate, category, priority });
        if (!initialTask) {
          setTitle('');
          setDescription('');
          setDueDate('');
          setCategory('');
          setPriority('');
        }
      };

      return (
        <form onSubmit={handleSubmit} className="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
          <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="Task title"
            className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
            required
          />
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            placeholder="Description"
            className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
          />
          <input
            type="date"
            value={dueDate}
            onChange={(e) => setDueDate(e.target.value)}
            className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
          />
          <select
            value={category}
            onChange={(e) => setCategory(e.target.value)}
            className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
          >
            <option value="">Select Category</option>
            {categories.map((cat) => (
              <option key={cat.id} value={cat.name}>{cat.name}</option>
            ))}
          </select>
          <select
            value={priority}
            onChange={(e) => setPriority(e.target.value)}
            className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
          >
            <option value="">Select Priority</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
          <div className="flex justify-end">
            {onCancel && (
              <button
                type="button"
                onClick={onCancel}
                className="mr-2 px-4 py-2 bg-gray-300 rounded"
              >
                Cancel
              </button>
            )}
            <button
              type="submit"
              className="px-4 py-2 bg-blue-500 text-white rounded"
            >
              {initialTask ? 'Update' : 'Add'} Task
            </button>
          </div>
        </form>
      );
    };

    const RegisterModal = ({ onClose, onRegister }) => {
      const [name, setName] = React.useState('');
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [error, setError] = React.useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!name || !email || !password || !confirmPassword) {
          setError('All fields are required');
          return;
        }
        if (password !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }
        if (!/\S+@\S+\.\S+/.test(email)) {
          setError('Invalid email format');
          return;
        }
        const success = onRegister({ id: Date.now().toString(), name, email, password });
        if (success) {
          onClose();
        } else {
          setError('Email already exists');
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 className="text-2xl mb-4">Register</h2>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <div>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Name"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Password"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <input
                type="password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                placeholder="Confirm Password"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <div className="flex justify-end">
                <button
                  type="button"
                  onClick={onClose}
                  className="mr-2 px-4 py-2 bg-gray-300 rounded"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSubmit}
                  className="px-4 py-2 bg-blue-500 text-white rounded"
                >
                  Register
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const LoginPage = ({ onLogin, onRegisterClick }) => {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        if (!email || !password) {
          setError('All fields are required');
          return;
        }
        setLoading(true);
        setTimeout(() => {
          const success = onLogin(email, password);
          setLoading(false);
          if (!success) {
            setError('Invalid email or password');
          }
        }, 500);
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900">
          <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
            <h2 className="text-2xl mb-4 text-center">Login</h2>
            {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
            <div>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Password"
                className="w-full p-2 mb-2 border rounded dark:bg-gray-800 dark:text-white"
                required
              />
              <button
                onClick={handleSubmit}
                disabled={loading}
                className="w-full px-4 py-2 bg-blue-500 text-white rounded disabled:bg-blue-300"
              >
                {loading ? 'Logging in...' : 'Login'}
              </button>
            </div>
            <p className="mt-4 text-center">
              Don't have an account?{' '}
              <button
                onClick={onRegisterClick}
                className="text-blue-500 underline"
              >
                Register
              </button>
            </p>
          </div>
          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
          )}
        </div>
      );
    };

    const App = () => {
      const [theme, setTheme] = useLocalStorage('theme', 'light');
      const [user, setUser] = useLocalStorage('user', null);
      const [users, setUsers] = useLocalStorage('users', []);
      const [tasks, setTasks] = useLocalStorage('tasks', []);
      const [categories, setCategories] = useLocalStorage('categories', []);
      const [filter, setFilter] = React.useState('All');
      const [categoryFilter, setCategoryFilter] = React.useState('');
      const [priorityFilter, setPriorityFilter] = React.useState('');
      const [search, setSearch] = React.useState('');
      const [sort, setSort] = React.useState('title');
      const [editingTask, setEditingTask] = React.useState(null);
      const [showRegister, setShowRegister] = React.useState(false);
      const [loading, setLoading] = React.useState(false);

      React.useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }, [theme]);

      React.useEffect(() => {
        if (user && tasks.filter((t) => t.userId === user.id).length === 0) {
          const userTasks = sampleTasks.map((task) => ({ ...task, userId: user.id }));
          const userCategories = sampleCategories.map((cat) => ({ ...cat, userId: user.id }));
          setTasks([...tasks, ...userTasks]);
          setCategories([...categories, ...userCategories]);
        }
      }, [user]);

      const toggleTheme = () => {
        setTheme(theme === 'light' ? 'dark' : 'light');
      };

      const login = (email, password) => {
        const foundUser = users.find((u) => u.email === email && u.password === password);
        if (foundUser) {
          setUser(foundUser);
          return true;
        }
        return false;
      };

      const register = (newUser) => {
        if (users.some((u) => u.email === newUser.email)) {
          return false;
        }
        setUsers([...users, newUser]);
        setUser(newUser);
        return true;
      };

      const logout = () => {
        setUser(null);
      };

      const addTask = (task) => {
        setTasks([...tasks, { ...task, id: Date.now().toString(), completed: false, userId: user.id }]);
      };

      const updateTask = (updatedTask) => {
        setTasks(tasks.map((t) => (t.id === updatedTask.id ? { ...updatedTask, userId: user.id } : t)));
        setEditingTask(null);
      };

      const toggleTask = (id) => {
        setTasks(tasks.map((t) => (t.id === id ? { ...t, completed: !t.completed } : t)));
      };

      const deleteTask = (id) => {
        setTasks(tasks.filter((t) => t.id !== id));
      };

      const addCategory = (name) => {
        setCategories([...categories, { id: Date.now().toString(), name, userId: user.id }]);
      };

      const filteredTasks = tasks
        .filter((task) => task.userId === user?.id)
        .filter((task) => {
          if (filter === 'Active') return !task.completed;
          if (filter === 'Completed') return task.completed;
          return true;
        })
        .filter((task) => (categoryFilter ? task.category === categoryFilter : true))
        .filter((task) => (priorityFilter ? task.priority === priorityFilter : true))
        .filter((task) => task.title.toLowerCase().includes(search.toLowerCase()) || (task.description?.toLowerCase().includes(search.toLowerCase()) ?? false))
        .sort((a, b) => {
          if (sort === 'title') return a.title.localeCompare(b.title);
          if (sort === 'dueDate') return (a.dueDate || '9999-12-31').localeCompare(b.dueDate || '9999-12-31');
          if (sort === 'priority') {
            const priorities = { High: 3, Medium: 2, Low: 1 };
            return (priorities[b.priority || 'Low'] - priorities[a.priority || 'Low']);
          }
          return 0;
        });

      if (!user) {
        return (
          <ThemeContext.Provider value={{ theme, toggleTheme }}>
            <AuthContext.Provider value={{ user, login, register, logout }}>
              <LoginPage
                onLogin={login}
                onRegisterClick={() => setShowRegister(true)}
              />
              {showRegister && (
                <RegisterModal
                  onClose={() => setShowRegister(false)}
                  onRegister={register}
                />
              )}
            </AuthContext.Provider>
          </ThemeContext.Provider>
        );
      }

      return (
        <ThemeContext.Provider value={{ theme, toggleTheme }}>
          <AuthContext.Provider value={{ user, login, register, logout }}>
            <div className="min-h-screen bg-gray-100 dark:bg-gray-900 p-4">
              <div className="max-w-4xl mx-auto">
                <header className="flex justify-between items-center mb-6">
                  <h1 className="text-3xl font-bold">Todo List</h1>
                  <div className="flex items-center space-x-4">
                    <button
                      onClick={toggleTheme}
                      className="p-2 rounded bg-gray-200 dark:bg-gray-700"
                    >
                      {theme === 'light' ? '🌙' : '☀️'}
                    </button>
                    <button
                      onClick={logout}
                      className="px-4 py-2 bg-red-500 text-white rounded"
                    >
                      Logout
                    </button>
                  </div>
                </header>

                <TaskForm
                  onSubmit={addTask}
                  categories={categories.filter((c) => c.userId === user.id)}
                />

                <div className="mb-4 flex flex-wrap gap-4">
                  <select
                    value={filter}
                    onChange={(e) => setFilter(e.target.value)}
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  >
                    <option value="All">All</option>
                    <option value="Active">Active</option>
                    <option value="Completed">Completed</option>
                  </select>
                  <select
                    value={categoryFilter}
                    onChange={(e) => setCategoryFilter(e.target.value)}
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  >
                    <option value="">All Categories</option>
                    {categories.filter((c) => c.userId === user.id).map((cat) => (
                      <option key={cat.id} value={cat.name}>{cat.name}</option>
                    ))}
                  </select>
                  <select
                    value={priorityFilter}
                    onChange={(e) => setPriorityFilter(e.target.value)}
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  >
                    <option value="">All Priorities</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                  <input
                    type="text"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder="Search tasks..."
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  />
                  <select
                    value={sort}
                    onChange={(e) => setSort(e.target.value)}
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  >
                    <option value="title">Sort by Title</option>
                    <option value="dueDate">Sort by Due Date</option>
                    <option value="priority">Sort by Priority</option>
                  </select>
                </div>

                <div className="mb-4">
                  <input
                    type="text"
                    placeholder="New category"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && e.currentTarget.value.trim()) {
                        addCategory(e.currentTarget.value.trim());
                        e.currentTarget.value = '';
                      }
                    }}
                    className="p-2 border rounded dark:bg-gray-800 dark:text-white"
                  />
                </div>

                {editingTask && (
                  <TaskForm
                    onSubmit={(task) => updateTask({ ...editingTask, ...task })}
                    categories={categories.filter((c) => c.userId === user.id)}
                    initialTask={editingTask}
                    onCancel={() => setEditingTask(null)}
                  />
                )}

                <ul className="space-y-2">
                  {filteredTasks.map((task) => (
                    <TaskItem
                      key={task.id}
                      task={task}
                      onToggle={toggleTask}
                      onDelete={deleteTask}
                      onEdit={setEditingTask}
                    />
                  ))}
                </ul>

                {loading && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                  </div>
                )}
              </div>
            </div>
          </AuthContext.Provider>
        </ThemeContext.Provider>
      );
    };

    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
