<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-bg: #f5f5f5;
            --light-text: #333;
            --dark-bg: #222;
            --dark-text: #f5f5f5;
            --dark-component: #333;
            --light-component: #fff;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Softer shadow */
            --notification-bg: rgba(0, 0, 0, 0.8);
            --notification-text: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Smooth transitions */
        }

        body {
            background: linear-gradient(135deg, #e0eafc, #cfdef3); /* Lighter gradient for light mode */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--light-text); /* Default text color */
        }

        body.app-view {
             /* Keep gradient for app view */
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            padding: 0;
            display: block;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50, #1a252f); /* Dark gradient */
            color: var(--dark-text);
        }

        .login-container {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        body.dark-mode .login-container {
             background-color: var(--dark-component);
        }


        .login-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: var(--light-text); /* Use variable */
        }
         body.dark-mode .login-title {
             color: var(--dark-text);
         }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        body.dark-mode .input-group label {
             color: #ccc;
        }

        .input-field, .filter-select, .filter-date {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 16px;
            outline: none;
            background-color: var(--light-component); /* Use variable */
            color: var(--light-text); /* Use variable */
        }

        .input-field:focus, .filter-select:focus, .filter-date:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); /* Focus ring */
        }

        body.dark-mode .input-field,
        body.dark-mode .filter-select,
        body.dark-mode .filter-date {
            background-color: #444;
            color: var(--dark-text);
            border-color: #555;
        }
         body.dark-mode .input-field:focus,
         body.dark-mode .filter-select:focus,
         body.dark-mode .filter-date:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        /* Specific styling for Flatpickr inputs */
        .flatpickr-input {
            cursor: pointer;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.2s ease; /* Add transform transition */
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px); /* Subtle lift on hover */
        }

        .btn:active {
             transform: translateY(0); /* Press down effect */
        }


        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-green {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .register-link {
            margin-top: 20px;
            color: #666;
        }
         body.dark-mode .register-link {
             color: #aaa;
         }

        .register-link a {
            color: var(--primary-color);
            text-decoration: none; /* Remove underline */
            font-weight: 500;
        }
         .register-link a:hover {
             text-decoration: underline;
         }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px); /* Add blur effect */
        }

        .modal-content {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px; /* Slightly smaller max-width */
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* Stronger shadow for modal */
            animation: fadeIn 0.3s ease-out; /* Fade-in animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }


        body.dark-mode .modal-content {
            background-color: var(--dark-component);
            color: var(--dark-text);
        }

        .modal-title {
            font-size: 22px;
            margin-bottom: 25px; /* Increased margin */
            color: var(--light-text); /* Use variable */
            text-align: center;
            font-weight: 600; /* Slightly bolder */
        }
         body.dark-mode .modal-title {
             color: var(--dark-text);
         }

        .modal-footer {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .app-container {
            display: none;
            width: 100%;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--light-component);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        body.dark-mode header {
            background-color: var(--dark-component);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            cursor: pointer;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease; /* Smooth hover */
        }

        body.dark-mode .icon-btn {
            color: #ccc;
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
         body.dark-mode .icon-btn:hover {
             background-color: rgba(255, 255, 255, 0.1);
         }

        .notification-badge {
            position: relative;
        }

        .badge {
            position: absolute;
            top: 0px; /* Adjusted position */
            right: 0px; /* Adjusted position */
            background-color: var(--danger-color);
            color: white;
            font-size: 10px;
            width: 18px; /* Slightly larger */
            height: 18px; /* Slightly larger */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid var(--light-component); /* Add border */
        }
         body.dark-mode .badge {
             border-color: var(--dark-component);
         }

        .notification-list {
            display: none;
            position: absolute;
            top: 55px; /* Adjusted position */
            right: 10px; /* Adjusted position */
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 320px; /* Wider */
            padding: 10px 0; /* Adjusted padding */
            z-index: 20;
            max-height: 400px; /* Limit height */
            overflow-y: auto;
        }

        body.dark-mode .notification-list {
            background-color: var(--dark-component);
        }

        .notification-item {
            padding: 12px 15px; /* Adjusted padding */
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: var(--light-text); /* Use variable */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .notification-item.unread {
            background-color: rgba(52, 152, 219, 0.1);
            font-weight: 500;
        }

        body.dark-mode .notification-item {
            color: var(--dark-text);
            border-bottom-color: #444;
        }

        body.dark-mode .notification-item.unread {
            background-color: rgba(52, 152, 219, 0.15);
        }
         .notification-item:hover {
             background-color: rgba(0, 0, 0, 0.03);
         }
         body.dark-mode .notification-item:hover {
             background-color: rgba(255, 255, 255, 0.05);
         }


        .notification-item:last-child {
            border-bottom: none;
        }
         .notification-list-empty {
             padding: 20px;
             text-align: center;
             color: #888;
         }
          body.dark-mode .notification-list-empty {
              color: #666;
          }

        .main-container {
            padding: 20px 30px;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Adjust minmax */
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Add shadow transition */
            border: 1px solid transparent; /* Add border for consistency */
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* Enhanced hover shadow */
        }

        body.dark-mode .stat-card {
            background-color: var(--dark-component);
            border-color: #444; /* Add border in dark mode */
        }
         body.dark-mode .stat-card:hover {
             box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
         }

        .stat-card.total {
            background: linear-gradient(135deg, #5dade2, #2e86c1); /* Adjusted gradient */
            color: white;
        }

        .stat-card.completed {
            background: linear-gradient(135deg, #58d68d, #28b463); /* Adjusted gradient */
            color: white;
        }

        .stat-card.pending {
            background: linear-gradient(135deg, #f5b041, #e67e22); /* Adjusted gradient */
            color: white;
        }
         /* Ensure text color is white for gradient cards */
         .stat-card.total .stat-title, .stat-card.total .stat-value,
         .stat-card.completed .stat-title, .stat-card.completed .stat-value,
         .stat-card.pending .stat-title, .stat-card.pending .stat-value {
             color: white;
         }


        .stat-title {
            font-size: 16px; /* Slightly smaller */
            font-weight: 500; /* Normal weight */
            margin-bottom: 10px;
            color: #555; /* Default color */
        }

        body.dark-mode .stat-title {
            color: #ccc;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
             color: var(--light-text); /* Use variable */
        }
         body.dark-mode .stat-value {
             color: var(--dark-text);
         }

        .progress-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjust minmax */
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-item {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid transparent;
        }

        .progress-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .progress-item {
            background-color: var(--dark-component);
             border-color: #444;
        }
         body.dark-mode .progress-item:hover {
             box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
         }

        .progress-title {
            margin-bottom: 10px;
            color: #666;
            font-weight: 500;
        }
         body.dark-mode .progress-title {
             color: #aaa;
         }


        .progress-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .todo-section {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            padding: 25px; /* Increased padding */
            box-shadow: var(--box-shadow);
            margin-bottom: 30px; /* Increased margin */
        }

        body.dark-mode .todo-section {
            background-color: var(--dark-component);
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Increased margin */
            border-bottom: 1px solid #eee; /* Add separator */
            padding-bottom: 15px; /* Add padding */
        }
         body.dark-mode .todo-header {
             border-bottom-color: #444;
         }

        .todo-header h2 {
            /* Color is now inherited from body */
            font-size: 24px;
            font-weight: 600; /* Slightly bolder */
        }
        /* No need for dark mode specific rule for h2 color anymore */


        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .filters-container {
            /* Removed background, shadow, padding from here - applied to todo-section */
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjust minmax */
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            /* No margin needed */
        }

        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px; /* Smaller label */
        }

        body.dark-mode .filter-label {
            color: #ccc;
        }

        .filter-select, .filter-date {
            padding: 10px 12px; /* Adjusted padding */
            font-size: 15px; /* Adjust font size */
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px; /* Add margin */
        }

        .tasks-container {
             /* Removed background, shadow, padding from here - applied to todo-section */
        }

        .graph-container {
            min-height: 350px; /* Adjusted height */
            display: none; /* Initially hidden */
            flex-direction: row; /* Default to row for side-by-side */
            gap: 25px; /* Increased gap */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: space-around; /* Distribute space */
        }

        .graph-item {
            flex: 1 1 45%; /* Allow shrinking, basis 45% for two columns */
            min-width: 280px; /* Minimum width before wrapping */
            background-color: var(--light-component); /* Add background */
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow); /* Add shadow */
            display: flex; /* Center canvas */
            justify-content: center;
            align-items: center;
        }
         body.dark-mode .graph-item {
             background-color: var(--dark-component);
         }
         .graph-item canvas {
             max-width: 100%;
             max-height: 300px; /* Limit canvas height */
         }


        .task-list {
            list-style-type: none;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 12px; /* Slightly increased margin */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.07); /* Lighter shadow */
            background-color: var(--light-component);
            border-left: 5px solid transparent; /* Add left border for status indication */
            transition: background-color 0.3s ease, border-left-color 0.3s ease;
        }

        body.dark-mode .task-item {
            background-color: var(--dark-component);
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
             border-left-color: #555; /* Default border in dark mode */
        }

        .task-item.completed {
            background-color: rgba(46, 204, 113, 0.1); /* Lighter green */
            border-left-color: var(--secondary-color); /* Green border */
        }
         body.dark-mode .task-item.completed {
             background-color: rgba(46, 204, 113, 0.15);
         }
         .task-item.completed .task-title {
             text-decoration: line-through;
             color: #888;
         }
          body.dark-mode .task-item.completed .task-title {
              color: #777;
          }


        .task-item.pending {
            /* Default state, no specific background needed unless desired */
             border-left-color: var(--warning-color); /* Orange border for pending */
        }
         body.dark-mode .task-item.pending {
             border-left-color: var(--warning-color);
         }

        .task-info {
            flex: 1;
            margin-right: 15px; /* Add margin */
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 5px;
             color: var(--light-text); /* Use variable */
             transition: color 0.3s ease, text-decoration 0.3s ease;
        }
         body.dark-mode .task-title {
             color: var(--dark-text);
         }

        .task-details {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 10px 15px; /* Row and column gap */
            font-size: 13px; /* Slightly smaller */
            color: #666;
        }

        body.dark-mode .task-details {
            color: #aaa;
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }
         .task-detail i {
             font-size: 12px; /* Smaller icons */
         }

        .task-actions {
            display: flex;
            gap: 5px; /* Reduced gap */
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 50px; /* Smaller switch */
            height: 28px; /* Smaller switch */
            margin-right: 5px; /* Add margin */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 28px; /* Match height */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px; /* Smaller circle */
            width: 20px; /* Smaller circle */
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--secondary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px); /* Adjusted translation */
        }

        .tag {
            padding: 4px 10px; /* Adjusted padding */
            border-radius: 12px;
            font-size: 11px; /* Smaller font */
            font-weight: 600; /* Bolder tag */
            text-transform: uppercase; /* Uppercase text */
        }

        .tag-high {
            background-color: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
             border: 1px solid rgba(231, 76, 60, 0.3); /* Subtle border */
        }
         body.dark-mode .tag-high {
             background-color: rgba(231, 76, 60, 0.25);
             border-color: rgba(231, 76, 60, 0.5);
         }

        .tag-medium {
            background-color: rgba(243, 156, 18, 0.15);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
         body.dark-mode .tag-medium {
             background-color: rgba(243, 156, 18, 0.25);
             border-color: rgba(243, 156, 18, 0.5);
         }

        .tag-low {
            background-color: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
         body.dark-mode .tag-low {
             background-color: rgba(46, 204, 113, 0.25);
             border-color: rgba(46, 204, 113, 0.5);
         }

        .insights-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adjust minmax */
            gap: 25px; /* Increased gap */
            margin-top: 30px;
        }

        .insight-card {
            background-color: var(--light-component);
            border-radius: var(--border-radius);
            padding: 25px; /* Increased padding */
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid transparent;
        }

        body.dark-mode .insight-card {
            background-color: var(--dark-component);
             border-color: #444;
        }

        .insight-title {
            font-size: 18px;
            margin-bottom: 20px; /* Increased margin */
            color: var(--light-text); /* Use variable */
            text-align: center;
            width: 100%;
            font-weight: 600;
        }
         body.dark-mode .insight-title {
             color: var(--dark-text);
         }

        .chart-container {
            height: 250px;
            width: 100%; /* Use full width */
            position: relative;
        }

        .task-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Adjust minmax */
            gap: 15px;
            width: 100%;
        }

        .distribution-item {
            background-color: rgba(52, 152, 219, 0.05); /* Lighter background */
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Lighter shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(52, 152, 219, 0.1); /* Subtle border */
        }

        .distribution-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body.dark-mode .distribution-item {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.2);
             box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
         body.dark-mode .distribution-item:hover {
             box-shadow: 0 4px 8px rgba(0,0,0,0.25);
         }

        .distribution-title {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 13px; /* Smaller font */
             color: #555;
        }
         body.dark-mode .distribution-title {
             color: #ccc;
         }

        .distribution-count {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Notification Popup Styles */
        #notification-popup-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-popup {
            background-color: var(--notification-bg);
            color: var(--notification-text);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 14px;
            opacity: 0;
            transform: translateX(-100%);
            animation: slideInFadeOut 5s forwards; /* 5 seconds total duration */
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .notification-popup i {
             font-size: 16px;
         }

        @keyframes slideInFadeOut {
            0% { opacity: 0; transform: translateX(-100%); }
            10% { opacity: 1; transform: translateX(0); } /* Slide in fast */
            90% { opacity: 1; transform: translateX(0); } /* Stay visible */
            100% { opacity: 0; transform: translateX(-100%); } /* Slide out */
        }


        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Add height for horizontal scrollbars */
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #aaa; /* Slightly darker thumb */
            border-radius: 4px;
        }
         ::-webkit-scrollbar-thumb:hover {
             background: #888; /* Darker on hover */
         }

        body.dark-mode ::-webkit-scrollbar-track {
            background: #333;
        }

        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #666;
        }
         body.dark-mode ::-webkit-scrollbar-thumb:hover {
             background: #888;
         }


        #fileUploadContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #fileUpload {
            width: auto;
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
             .graph-container {
                 flex-direction: column; /* Stack graphs vertically */
                 align-items: center; /* Center items */
             }
             .graph-item {
                 flex-basis: 80%; /* Take more width when stacked */
                 min-width: none; /* Remove min-width */
             }
             .insights-container {
                grid-template-columns: 1fr; /* Stack insights */
            }
        }


        @media (max-width: 768px) {
            header {
                padding: 10px 15px; /* Reduce padding */
            }
            .main-container {
                padding: 15px; /* Reduce padding */
            }
            .stats-container, .progress-container, .filters-grid {
                grid-template-columns: 1fr; /* Single column */
            }
            .task-item {
                flex-direction: column; /* Stack task info and actions */
                align-items: flex-start; /* Align items left */
                gap: 10px;
            }
            .task-actions {
                width: 100%;
                justify-content: flex-end; /* Align actions to the right */
            }
             .action-buttons {
                 justify-content: center; /* Center buttons */
                 flex-wrap: wrap; /* Allow wrapping */
             }
             .todo-header {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 10px;
             }
             .view-toggle {
                 width: 100%;
                 justify-content: space-between;
             }
             .view-toggle .btn {
                 flex-grow: 1; /* Make buttons take equal space */
             }
             .modal-content {
                 width: 95%;
                 padding: 20px;
             }
             .login-container {
                 padding: 30px;
             }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 20px;
            }
            .header-actions .btn {
                 padding: 8px 12px; /* Smaller buttons */
                 font-size: 14px;
            }
            .stat-value {
                font-size: 24px;
            }
            .progress-value {
                font-size: 20px;
            }
            .notification-list {
                width: 90%;
                right: 5%;
            }
             #notification-popup-container {
                 left: 10px;
                 right: 10px; /* Allow stretching */
                 bottom: 10px;
                 align-items: center; /* Center popups on small screens */
             }
             .notification-popup {
                 width: 100%;
                 max-width: 350px; /* Max width */
                 animation: fadeInFadeOut 5s forwards; /* Simpler animation */
             }
             @keyframes fadeInFadeOut {
                0% { opacity: 0; transform: translateY(50px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(50px); }
            }
        }

    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h1 class="login-title">Welcome to Todo App</h1>
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="input-field" placeholder="Enter your email">
        </div>
        <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" placeholder="Enter your password">
        </div>
        <button class="btn btn-block" id="loginBtn">Login</button>
        <p class="register-link">Don't have an account? <a id="registerLink">Register</a></p>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title">Create an Account</h2>
            <div class="input-group">
                <label for="regName">Full Name</label>
                <input type="text" id="regName" class="input-field" placeholder="Enter your full name">
            </div>
            <div class="input-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" class="input-field" placeholder="Enter your email">
            </div>
            <div class="input-group">
                <label for="regEmailConfirm">Confirm Email</label>
                <input type="email" id="regEmailConfirm" class="input-field" placeholder="Confirm your email">
            </div>
            <div class="input-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword" class="input-field" placeholder="Enter your password">
            </div>
            <div class="input-group">
                <label for="regPasswordConfirm">Confirm Password</label>
                <input type="password" id="regPasswordConfirm" class="input-field" placeholder="Confirm your password">
            </div>
            <div class="input-group">
                <label for="regCountry">Country</label>
                <select id="regCountry" class="input-field">
                    <option value="">Select your country</option>
                    <option value="USA">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="CA">Canada</option>
                    <option value="AU">Australia</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="JP">Japan</option>
                    <option value="IN">India</option>
                    <option value="BR">Brazil</option>
                    <option value="ZA">South Africa</option>
                    <option value="EG">Egypt</option> {/* Added Egypt */}
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelRegisterBtn">Cancel</button>
                <button class="btn btn-green" id="submitRegisterBtn">Register</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Create a New Task</h2>
            <div class="input-group">
                <label for="taskTitle">Task Title *</label>
                <input type="text" id="taskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="taskDetails">Add More Details</label>
                <textarea id="taskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea> {/* Reduced rows */}
            </div>
            <div class="input-group">
                <label for="taskCategory">Task Category</label>
                <select id="taskCategory" class="input-field">
                    <option value="">Select category</option>
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Health">Health</option>
                    <option value="Education">Education</option>
                    <option value="Finance">Finance</option>
                    <option value="Home">Home</option> {/* Added category */}
                    <option value="Other">Other</option> {/* Added category */}
                </select>
            </div>
            <div class="input-group">
                <label for="taskPriority">Priority</label>
                <select id="taskPriority" class="input-field">
                    <option value="High">High</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="taskDueDate">Due Date</label>
                <input type="text" id="taskDueDate" class="input-field flatpickr-input" placeholder="YYYY-MM-DD or select date"> {/* Use class for Flatpickr */}
                {/* Calendar dropdown removed - handled by Flatpickr */}
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelTaskBtn">Cancel</button>
                <button class="btn btn-green" id="createTaskBtn">Create Task</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <h2 class="modal-title">Edit Task</h2>
             <input type="hidden" id="editTaskId"> {/* Hidden input to store task ID */}
            <div class="input-group">
                <label for="editTaskTitle">Task Title *</label>
                <input type="text" id="editTaskTitle" class="input-field" placeholder="Enter task title">
            </div>
            <div class="input-group">
                <label for="editTaskDetails">Add More Details</label>
                <textarea id="editTaskDetails" class="input-field" rows="3" placeholder="Enter task details"></textarea>
            </div>
            <div class="input-group">
                <label for="editTaskCategory">Task Category</label>
                <select id="editTaskCategory" class="input-field">
                     <option value="">Select category</option>
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Health">Health</option>
                    <option value="Education">Education</option>
                    <option value="Finance">Finance</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskPriority">Priority</label>
                <select id="editTaskPriority" class="input-field">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskDueDate">Due Date</label>
                <input type="text" id="editTaskDueDate" class="input-field flatpickr-input" placeholder="YYYY-MM-DD or select date">
                 {/* Calendar dropdown removed */}
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelEditTaskBtn">Cancel</button>
                <button class="btn btn-green" id="saveTaskBtn">Save Changes</button> {/* Changed button text */}
            </div>
        </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Deletion</h2>
            <p>Are you sure you want to delete the task: "<strong id="deleteTaskTitle"></strong>"?</p> {/* Show task title */}
            <div class="modal-footer">
                <button class="btn" id="cancelDeleteBtn">No, Cancel</button> {/* Changed button text */}
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button> {/* Changed button text */}
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2 class="modal-title">Export Tasks</h2>
            <p>Choose a format to export your tasks:</p>
            <div class="input-group">
                <label for="exportFormat">Export Format</label>
                <select id="exportFormat" class="input-field">
                    <option value="csv">CSV (Comma Separated Values)</option>
                    <option value="json">JSON (JavaScript Object Notation)</option> {/* Added JSON */}
                    {/* Simplified options - DOCX/PDF require complex libraries */}
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-green" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2 class="modal-title">Import Tasks</h2>
            <div class="input-group">
                <label>Import Method</label>
                <div>
                    <button class="btn" id="importFileBtn" style="margin-right: 10px;">From File (.csv, .json)</button>
                    {/* URL import removed for simplicity */}
                </div>
            </div>
            <div class="input-group" id="fileUploadContainer">
                <label for="fileUpload">Select File</label>
                <input type="file" id="fileUpload" class="input-field" accept=".csv,.json"> {/* Accept specific types */}
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-green" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <header>
            <div class="logo" id="refreshLogo" title="Refresh View">To-Do App</div> {/* Added title */}
            <div class="header-actions">
                <button class="icon-btn notification-badge" id="notificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </button>
                <div class="notification-list" id="notificationList">
                    <div class="notification-list-empty">No new notifications</div>
                </div>
                <button class="icon-btn" id="themeToggleBtn" title="Toggle Theme">
                    <i class="fas fa-moon"></i> </button>
                <button class="btn btn-danger" id="logoutBtn">Logout</button> {/* Changed to danger color */}
            </div>
        </header>

        <div class="main-container">
            <div class="action-buttons">
                <button class="btn btn-green" id="addTaskBtn">
                    <i class="fas fa-plus"></i> Add Task
                </button>
                <button class="btn" id="exportBtn" style="background-color: var(--primary-color);">
                    <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn" id="importBtn" style="background-color: var(--primary-color);">
                    <i class="fas fa-file-import"></i> Import
                </button>
            </div>

            <div class="stats-container">
                <div class="stat-card total">
                    <div class="stat-title">Total Tasks</div>
                    <div class="stat-value" id="totalTasksStat">0</div>
                </div>
                <div class="stat-card completed">
                    <div class="stat-title">Completed Tasks</div>
                    <div class="stat-value" id="completedTasksStat">0</div>
                </div>
                <div class="stat-card pending">
                    <div class="stat-title">Pending Tasks</div>
                    <div class="stat-value" id="pendingTasksStat">0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-item">
                    <div class="progress-title">Today</div>
                    <div class="progress-value" id="progressToday">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">This Week</div>
                    <div class="progress-value" id="progressWeek">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">This Month</div>
                    <div class="progress-value" id="progressMonth">0%</div>
                </div>
                <div class="progress-item">
                    <div class="progress-title">Overall</div> {/* Changed from Year */}
                    <div class="progress-value" id="progressOverall">0%</div>
                </div>
            </div>


            <div class="todo-section">
                <div class="todo-header">
                    <h2>Tasks</h2>
                    <div class="view-toggle">
                        <button class="btn" id="listViewBtn">List View</button>
                        <button class="btn" id="graphViewBtn">Graph View</button>
                    </div>
                </div>

                <div class="filters-container">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label" for="statusFilter">Status</label>
                            <select class="filter-select" id="statusFilter">
                                <option value="all">All</option> {/* Changed default value */}
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="dateFilter">Date Filter</label>
                            <select class="filter-select" id="dateFilter">
                                <option value="all">All Time</option> {/* Changed default value */}
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option> {/* Changed text */}
                            </select>
                        </div>
                         {/* Custom Date Inputs - Integrated */}
                        <div class="filter-group custom-date-filter" id="customDateFilterGroup" style="display: none;">
                             <label class="filter-label">Custom Date Range</label>
                             <div style="display: flex; gap: 10px;">
                                <input type="text" id="customStartDate" class="filter-date flatpickr-input" placeholder="Start Date">
                                <input type="text" id="customEndDate" class="filter-date flatpickr-input" placeholder="End Date">
                             </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="categoryFilter">Categories</label>
                            <select class="filter-select" id="categoryFilter">
                                <option value="all">All</option> {/* Changed default value */}
                                <option value="Work">Work</option>
                                <option value="Personal">Personal</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Health">Health</option>
                                <option value="Education">Education</option>
                                <option value="Finance">Finance</option>
                                <option value="Home">Home</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="priorityFilter">Priority</label>
                            <select class="filter-select" id="priorityFilter">
                                <option value="all">All</option> {/* Changed default value */}
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn" id="resetFiltersBtn">Reset Filters</button> {/* Changed text */}
                        {/* Apply Filters button removed - filters apply automatically */}
                    </div>
                </div>

                <div class="tasks-container" id="tasksContainer">
                    <ul class="task-list" id="taskList">
                        <li class="no-tasks" style="text-align: center; padding: 20px; color: #888;">No tasks found. Try adjusting filters or adding a new task!</li>
                    </ul>
                </div>

                <div class="graph-container" id="graphContainer">
                    <div class="graph-item">
                        <canvas id="taskStatusChart"></canvas> {/* Renamed ID */}
                    </div>
                    <div class="graph-item">
                        <canvas id="taskPriorityChart"></canvas> {/* Renamed ID */}
                    </div>
                </div>
            </div>

            <div class="insights-container">
                <div class="insight-card">
                    <h3 class="insight-title">Task Completion Rate</h3>
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                <div class="insight-card">
                    <h3 class="insight-title">Task Distribution by Priority</h3>
                    <div class="task-distribution">
                        <div class="distribution-item">
                            <div class="distribution-title">High Priority</div>
                            <div class="distribution-count" id="highPriorityCount">0</div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-title">Medium Priority</div>
                            <div class="distribution-count" id="mediumPriorityCount">0</div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-title">Low Priority</div>
                            <div class="distribution-count" id="lowPriorityCount">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-popup-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const registerLink = document.getElementById('registerLink');
            const registerModal = document.getElementById('registerModal');
            const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
            const submitRegisterBtn = document.getElementById('submitRegisterBtn');
            const loginBtn = document.getElementById('loginBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const logoutBtn = document.getElementById('logoutBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const addTaskModal = document.getElementById('addTaskModal');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            const createTaskBtn = document.getElementById('createTaskBtn');
            const taskDueDateInput = document.getElementById('taskDueDate'); // Renamed
            const editTaskModal = document.getElementById('editTaskModal');
            const cancelEditTaskBtn = document.getElementById('cancelEditTaskBtn');
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            const editTaskDueDateInput = document.getElementById('editTaskDueDate'); // Renamed
            const editTaskIdInput = document.getElementById('editTaskId');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteTaskTitle = document.getElementById('deleteTaskTitle');
            const customStartDateInput = document.getElementById('customStartDate'); // Renamed
            const customEndDateInput = document.getElementById('customEndDate'); // Renamed
            const customDateFilterGroup = document.getElementById('customDateFilterGroup');
            const listViewBtn = document.getElementById('listViewBtn');
            const graphViewBtn = document.getElementById('graphViewBtn');
            const tasksContainer = document.getElementById('tasksContainer');
            const graphContainer = document.getElementById('graphContainer');
            const exportBtn = document.getElementById('exportBtn');
            const exportModal = document.getElementById('exportModal');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('importModal');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const importFileBtn = document.getElementById('importFileBtn');
            const fileUploadContainer = document.getElementById('fileUploadContainer');
            const fileUploadInput = document.getElementById('fileUpload'); // Renamed
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationList = document.getElementById('notificationList');
            const notificationCountBadge = document.getElementById('notificationCount'); // Renamed
            const notificationPopupContainer = document.getElementById('notification-popup-container');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const taskList = document.getElementById('taskList');
            const refreshLogo = document.getElementById('refreshLogo');

            // Stat & Progress Elements
            const totalTasksStat = document.getElementById('totalTasksStat');
            const completedTasksStat = document.getElementById('completedTasksStat');
            const pendingTasksStat = document.getElementById('pendingTasksStat');
            const progressToday = document.getElementById('progressToday');
            const progressWeek = document.getElementById('progressWeek');
            const progressMonth = document.getElementById('progressMonth');
            const progressOverall = document.getElementById('progressOverall');
            const highPriorityCount = document.getElementById('highPriorityCount');
            const mediumPriorityCount = document.getElementById('mediumPriorityCount');
            const lowPriorityCount = document.getElementById('lowPriorityCount');


            // --- State Variables ---
            let tasks = []; // Initialize empty, load from storage
            let notifications = []; // Initialize empty, load from storage
            let currentTaskIdToDelete = null;
            let flatpickrInstances = {}; // Store flatpickr instances

            // Chart instances
            let taskStatusChart, taskPriorityChart, completionChart;

            // --- Initialization ---

            // Load data from Local Storage
            loadTasks();
            loadNotifications();
            checkLoginStatus(); // Check if user was already logged in
            initializeFlatpickr();
            applyInitialTheme(); // Apply theme based on preference or system
            renderAll(); // Initial render

            // --- Functions ---

            // Local Storage Handling
            function saveTasks() {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }

            function loadTasks() {
                const storedTasks = localStorage.getItem('tasks');
                tasks = storedTasks ? JSON.parse(storedTasks) : getDefaultTasks(); // Use defaults if none stored
                // Ensure date format consistency (optional, good practice)
                tasks.forEach(task => {
                    if (task.dueDate && !/^\d{4}-\d{2}-\d{2}$/.test(task.dueDate)) {
                        try {
                            task.dueDate = new Date(task.dueDate).toISOString().split('T')[0];
                        } catch (e) {
                            task.dueDate = ''; // Handle invalid dates
                        }
                    }
                });
            }

             function getDefaultTasks() {
                // Provide some default tasks if local storage is empty
                return [
                    { id: 1, title: "Review Project Proposal", details: "Check feedback and finalize", status: "Pending", category: "Work", priority: "High", dueDate: getFutureDate(2) },
                    { id: 2, title: "Buy Groceries", details: "Milk, Eggs, Bread", status: "Pending", category: "Shopping", priority: "Medium", dueDate: getFutureDate(0) },
                    { id: 3, title: "Schedule Annual Checkup", details: "Call Dr. Smith's office", status: "Pending", category: "Health", priority: "Low", dueDate: getFutureDate(7) },
                    { id: 4, title: "Complete Chapter 3 Reading", details: "For online course", status: "Completed", category: "Education", priority: "Medium", dueDate: getFutureDate(-1) },
                    { id: 5, title: "Pay Rent", details: "Due by the 5th", status: "Completed", category: "Finance", priority: "High", dueDate: getFutureDate(-5) },
                ];
            }

            function getFutureDate(days) {
                const date = new Date();
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            }


            function saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }

            function loadNotifications() {
                const storedNotifications = localStorage.getItem('notifications');
                notifications = storedNotifications ? JSON.parse(storedNotifications) : [];
            }

            // Theme Handling
            function applyTheme(isDarkMode) {
                const icon = themeToggleBtn.querySelector('i');
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    localStorage.setItem('theme', 'light');
                }
                 // Update chart colors if charts exist
                updateAllCharts();
            }

            function applyInitialTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));
            }

            // Login/Logout
            function checkLoginStatus() {
                if (localStorage.getItem('loggedIn') === 'true') {
                    showAppView();
                } else {
                    showLoginView();
                }
            }

            function showAppView() {
                loginContainer.style.display = 'none';
                document.body.classList.add('app-view');
                appContainer.style.display = 'block';
                tasksContainer.style.display = 'block'; // Default to list view
                graphContainer.style.display = 'none';
                renderAll(); // Render everything when app view is shown
            }

            function showLoginView() {
                appContainer.style.display = 'none';
                document.body.classList.remove('app-view');
                loginContainer.style.display = 'block';
                localStorage.removeItem('loggedIn'); // Clear login status
            }

            // Rendering
            function renderAll() {
                renderTasks();
                renderNotifications();
                updateStats();
                updateProgress();
                updateAllCharts(); // Update charts after rendering tasks
            }

            function renderTasks() {
                const filters = getFilters();
                let filteredTasks = tasks.filter(task => {
                    // Status Filter
                    if (filters.status !== 'all' && task.status !== filters.status) {
                        return false;
                    }
                    // Category Filter
                    if (filters.category !== 'all' && task.category !== filters.category) {
                        return false;
                    }
                    // Priority Filter
                    if (filters.priority !== 'all' && task.priority !== filters.priority) {
                        return false;
                    }
                    // Date Filter
                    if (filters.date !== 'all') {
                        if (!task.dueDate) return false; // Skip tasks without due dates if filtering by date
                        const taskDueDate = new Date(task.dueDate + 'T00:00:00'); // Ensure correct date parsing

                        if (filters.date === 'today') {
                            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                            if (taskDueDate < todayStart || taskDueDate > todayEnd) return false;
                        } else if (filters.date === 'week') {
                            const today = new Date();
                            const dayOfWeek = today.getDay(); // 0 (Sun) - 6 (Sat)
                            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
                            const weekStart = new Date(today.setDate(diff)); weekStart.setHours(0, 0, 0, 0);
                            const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); weekEnd.setHours(23, 59, 59, 999);
                            if (taskDueDate < weekStart || taskDueDate > weekEnd) return false;
                        } else if (filters.date === 'month') {
                            const today = new Date();
                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1); monthStart.setHours(0, 0, 0, 0);
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0); monthEnd.setHours(23, 59, 59, 999);
                            if (taskDueDate < monthStart || taskDueDate > monthEnd) return false;
                        } else if (filters.date === 'custom' && filters.startDate && filters.endDate) {
                             const startDate = new Date(filters.startDate + 'T00:00:00');
                             const endDate = new Date(filters.endDate + 'T23:59:59'); // Include end date fully
                             if (taskDueDate < startDate || taskDueDate > endDate) return false;
                        } else if (filters.date === 'custom' && ( !filters.startDate || !filters.endDate)) {
                             // If custom is selected but dates are missing, show nothing for custom range
                             return false;
                        }
                    }
                    return true;
                });

                taskList.innerHTML = ''; // Clear previous list

                if (filteredTasks.length === 0) {
                    taskList.innerHTML = '<li class="no-tasks" style="text-align: center; padding: 20px; color: #888;">No tasks match the current filters.</li>';
                     if (document.body.classList.contains('dark-mode')) {
                         taskList.querySelector('.no-tasks').style.color = '#666';
                     }
                } else {
                    filteredTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = `task-item ${task.status.toLowerCase()}`;
                        li.dataset.id = task.id;
                        // Add other data attributes if needed for sorting/filtering later
                        li.innerHTML = `
                            <div class="task-info">
                                <div class="task-title">${escapeHtml(task.title)}</div>
                                <div class="task-details">
                                    ${task.dueDate ? `<div class="task-detail"><i class="fas fa-calendar-alt"></i> Due: ${task.dueDate}</div>` : ''}
                                    ${task.category ? `<div class="task-detail"><i class="fas fa-folder"></i> ${escapeHtml(task.category)}</div>` : ''}
                                    <div class="task-detail">
                                        <span class="tag tag-${task.priority.toLowerCase()}">${escapeHtml(task.priority)}</span>
                                    </div>
                                </div>
                                ${task.details ? `<div style="font-size: 12px; color: #777; margin-top: 5px;">${escapeHtml(task.details)}</div>` : ''}
                            </div>
                            <div class="task-actions">
                                <label class="toggle-switch" title="Mark as ${task.status === 'Completed' ? 'Pending' : 'Completed'}">
                                    <input type="checkbox" class="status-toggle" ${task.status === 'Completed' ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                                <button class="icon-btn edit-btn" title="Edit Task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete-btn" title="Delete Task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        taskList.appendChild(li);

                        // Add event listeners directly to the created elements
                        li.querySelector('.status-toggle').addEventListener('change', handleStatusToggle);
                        li.querySelector('.edit-btn').addEventListener('click', handleEditClick);
                        li.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                    });
                }
                 updateStats(); // Update stats after rendering tasks
            }

            function renderNotifications() {
                const unreadCount = notifications.filter(n => !n.read).length;
                notificationCountBadge.textContent = unreadCount;
                notificationCountBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

                if (notifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-list-empty">No notifications</div>';
                     if (document.body.classList.contains('dark-mode')) {
                         notificationList.querySelector('.notification-list-empty').style.color = '#666';
                     }
                    return;
                }

                notificationList.innerHTML = ''; // Clear previous list
                // Show latest notifications first
                [...notifications].reverse().forEach(note => {
                    const div = document.createElement('div');
                    div.className = `notification-item ${note.read ? '' : 'unread'}`;
                    div.dataset.id = note.id;
                    div.innerHTML = `
                        <div style="font-weight: ${note.read ? 'normal' : 'bold'}; margin-bottom: 3px;">${escapeHtml(note.message)}</div>
                        <div style="font-size: 11px; color: #888;">${timeAgo(note.timestamp)}</div>
                    `;
                     if (document.body.classList.contains('dark-mode') && !note.read) {
                         div.style.backgroundColor = 'rgba(52, 152, 219, 0.15)';
                     }
                     if (document.body.classList.contains('dark-mode')) {
                         div.querySelector('div[style*="color: #888"]').style.color = '#666';
                     }

                    div.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        const notification = notifications.find(n => n.id === id);
                        if (notification && !notification.read) {
                            notification.read = true;
                            saveNotifications();
                            renderNotifications(); // Re-render to update style and count
                        }
                    });
                    notificationList.appendChild(div);
                });
            }

            // Stats & Progress Updates
             function updateStats() {
                const total = tasks.length;
                const completed = tasks.filter(task => task.status === 'Completed').length;
                const pending = total - completed;
                const high = tasks.filter(task => task.priority === 'High').length;
                const medium = tasks.filter(task => task.priority === 'Medium').length;
                const low = tasks.filter(task => task.priority === 'Low').length;

                totalTasksStat.textContent = total;
                completedTasksStat.textContent = completed;
                pendingTasksStat.textContent = pending;
                highPriorityCount.textContent = high;
                mediumPriorityCount.textContent = medium;
                lowPriorityCount.textContent = low;
            }

            function updateProgress() {
                const today = new Date().toISOString().split('T')[0];
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);

                const weekStart = new Date(todayStart);
                const dayOfWeek = todayStart.getDay();
                const diff = todayStart.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                weekStart.setDate(diff);
                const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); weekEnd.setHours(23, 59, 59, 999);

                const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                const monthEnd = new Date(todayStart.getFullYear(), todayStart.getMonth() + 1, 0); monthEnd.setHours(23, 59, 59, 999);

                const calculateRate = (start, end) => {
                    const relevantTasks = tasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate + 'T00:00:00');
                        return dueDate >= start && dueDate <= end;
                    });
                    const completed = relevantTasks.filter(t => t.status === 'Completed').length;
                    return relevantTasks.length > 0 ? Math.round((completed / relevantTasks.length) * 100) : 0;
                };

                progressToday.textContent = `${calculateRate(todayStart, todayEnd)}%`;
                progressWeek.textContent = `${calculateRate(weekStart, weekEnd)}%`;
                progressMonth.textContent = `${calculateRate(monthStart, monthEnd)}%`;

                const overallCompleted = tasks.filter(t => t.status === 'Completed').length;
                const overallRate = tasks.length > 0 ? Math.round((overallCompleted / tasks.length) * 100) : 0;
                progressOverall.textContent = `${overallRate}%`;
            }


            // Charting
            function updateAllCharts() {
                 updateTaskStatusChart();
                 updateTaskPriorityChart();
                 updateCompletionChart();
            }

            function getChartColors() {
                const isDark = document.body.classList.contains('dark-mode');
                return {
                    // Status Colors
                    completed: '#2ecc71', // Green
                    pending: '#f39c12',   // Orange/Yellow
                    // Priority Colors
                    high: '#e74c3c',     // Red
                    medium: '#3498db',   // Blue
                    low: '#95a5a6',      // Gray
                    // General Colors
                    gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    ticksColor: isDark ? '#ccc' : '#666',
                    legendColor: isDark ? '#f5f5f5' : '#333',
                    titleColor: isDark ? '#f5f5f5' : '#333'
                };
            }


             function updateTaskStatusChart() {
                const completed = tasks.filter(task => task.status === 'Completed').length;
                const pending = tasks.filter(task => task.status === 'Pending').length;
                const colors = getChartColors();

                const data = {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        label: 'Tasks by Status',
                        data: [completed, pending],
                        backgroundColor: [colors.completed, colors.pending],
                        borderColor: [colors.completed, colors.pending], // Use same color for border
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: { color: colors.legendColor }
                        },
                        title: {
                            display: true,
                            text: 'Tasks by Status',
                            font: { size: 16 },
                            color: colors.titleColor
                        }
                    }
                };

                 const ctx = document.getElementById('taskStatusChart')?.getContext('2d');
                 if (!ctx) return; // Exit if canvas not found

                if (taskStatusChart) {
                    taskStatusChart.data = data;
                    taskStatusChart.options = options; // Update options for theme changes
                    taskStatusChart.update();
                } else {
                    taskStatusChart = new Chart(ctx, { type: 'doughnut', data, options });
                }
            }

            function updateTaskPriorityChart() {
                const high = tasks.filter(task => task.priority === 'High').length;
                const medium = tasks.filter(task => task.priority === 'Medium').length;
                const low = tasks.filter(task => task.priority === 'Low').length;
                 const colors = getChartColors();

                const data = {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Tasks by Priority',
                        data: [high, medium, low],
                        backgroundColor: [colors.high, colors.medium, colors.low],
                        borderColor: [colors.high, colors.medium, colors.low],
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Make it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: colors.ticksColor
                            },
                             grid: { color: colors.gridColor }
                        },
                         y: {
                             ticks: { color: colors.ticksColor },
                             grid: { display: false } // Hide y-axis grid lines
                         }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend for bar chart
                        },
                        title: {
                            display: true,
                            text: 'Tasks by Priority',
                            font: { size: 16 },
                            color: colors.titleColor
                        }
                    }
                };

                 const ctx = document.getElementById('taskPriorityChart')?.getContext('2d');
                 if (!ctx) return;

                if (taskPriorityChart) {
                     taskPriorityChart.data = data;
                     taskPriorityChart.options = options;
                     taskPriorityChart.update();
                } else {
                    taskPriorityChart = new Chart(ctx, { type: 'bar', data, options });
                }
            }

             function updateCompletionChart() {
                 // Example: Completion rate over the last 7 days
                 const rates = [];
                 const labels = [];
                 const today = new Date();
                 const colors = getChartColors();

                 for (let i = 6; i >= 0; i--) {
                     const date = new Date(today);
                     date.setDate(today.getDate() - i);
                     const dateStr = date.toISOString().split('T')[0];
                     labels.push(dateStr);

                     const dayStart = new Date(date); dayStart.setHours(0, 0, 0, 0);
                     const dayEnd = new Date(date); dayEnd.setHours(23, 59, 59, 999);

                     const relevantTasks = tasks.filter(task => task.dueDate === dateStr);
                     const completed = relevantTasks.filter(t => t.status === 'Completed').length;
                     rates.push(relevantTasks.length > 0 ? (completed / relevantTasks.length) * 100 : 0);
                 }

                 const data = {
                     labels: labels,
                     datasets: [{
                         label: 'Completion Rate (%)',
                         data: rates,
                         fill: false,
                         borderColor: colors.primary || '#3498db', // Use primary color
                         tension: 0.1
                     }]
                 };

                 const options = {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         y: {
                             beginAtZero: true,
                             max: 100,
                             ticks: {
                                 callback: function(value) { return value + "%" },
                                 color: colors.ticksColor
                             },
                             grid: { color: colors.gridColor }
                         },
                         x: {
                             ticks: { color: colors.ticksColor },
                             grid: { display: false }
                         }
                     },
                     plugins: {
                         legend: { display: false },
                         title: {
                             display: true,
                             text: 'Daily Task Completion Rate (Last 7 Days)',
                             font: { size: 16 },
                             color: colors.titleColor
                         }
                     }
                 };

                 const ctx = document.getElementById('completionChart')?.getContext('2d');
                 if (!ctx) return;

                 if (completionChart) {
                     completionChart.data = data;
                     completionChart.options = options;
                     completionChart.update();
                 } else {
                     completionChart = new Chart(ctx, { type: 'line', data, options });
                 }
             }


            // Date Picker (Flatpickr) Initialization
            function initializeFlatpickr() {
                const commonOptions = {
                    dateFormat: "Y-m-d", // Use YYYY-MM-DD format
                    allowInput: true, // Allow direct typing
                     // You can add more options like disabling past dates, etc.
                     // disable: [ function(date) { return date < new Date().setHours(0,0,0,0); } ] // Example: disable past dates
                };

                // Destroy existing instances if re-initializing
                Object.values(flatpickrInstances).forEach(instance => instance.destroy());
                flatpickrInstances = {};

                // Add/Edit Task Due Dates
                flatpickrInstances.taskDueDate = flatpickr(taskDueDateInput, commonOptions);
                flatpickrInstances.editTaskDueDate = flatpickr(editTaskDueDateInput, commonOptions);

                // Custom Date Range Filter
                flatpickrInstances.customStart = flatpickr(customStartDateInput, {
                    ...commonOptions,
                    onChange: function(selectedDates, dateStr, instance) {
                        // If end date is selected and earlier than start date, clear end date
                        if (flatpickrInstances.customEnd.selectedDates[0] && selectedDates[0] > flatpickrInstances.customEnd.selectedDates[0]) {
                            flatpickrInstances.customEnd.clear();
                        }
                        // Set minDate for end date picker
                        flatpickrInstances.customEnd.set('minDate', selectedDates[0]);
                         renderTasks(); // Re-render tasks when start date changes
                    }
                });
                flatpickrInstances.customEnd = flatpickr(customEndDateInput, {
                    ...commonOptions,
                     onChange: function(selectedDates, dateStr, instance) {
                         renderTasks(); // Re-render tasks when end date changes
                     }
                    // minDate will be set dynamically by the start date picker
                });
            }

            // Notifications
            function addNotification(message, type = 'info') {
                const newNotification = {
                    id: Date.now(), // Use timestamp for unique ID
                    message: message,
                    read: false,
                    timestamp: Date.now(),
                    type: type // 'info', 'success', 'error', 'warning'
                };
                notifications.push(newNotification);
                saveNotifications();
                renderNotifications(); // Update the bell dropdown
                showNotificationPopup(message, type); // Show the popup
            }

            function showNotificationPopup(message, type = 'info') {
                const popup = document.createElement('div');
                popup.className = 'notification-popup';

                let iconClass = 'fa-info-circle'; // Default icon
                if (type === 'success') iconClass = 'fa-check-circle';
                else if (type === 'error') iconClass = 'fa-times-circle';
                else if (type === 'warning') iconClass = 'fa-exclamation-triangle';

                popup.innerHTML = `<i class="fas ${iconClass}"></i> ${escapeHtml(message)}`;

                notificationPopupContainer.appendChild(popup);

                // Force reflow to ensure animation plays
                void popup.offsetWidth;

                // Remove the popup after animation finishes (5 seconds)
                setTimeout(() => {
                    // Add a class to fade out smoothly (optional, CSS handles fade out now)
                    // popup.style.opacity = '0';
                    // popup.style.transform = 'translateX(-100%)'; // Or translateY based on animation
                    // setTimeout(() => popup.remove(), 300); // Remove after fade out transition
                     popup.remove(); // CSS animation handles removal implicitly
                }, 5000); // Match CSS animation duration
            }

            // Utility Functions
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

             function timeAgo(timestamp) {
                const now = new Date();
                const past = new Date(timestamp);
                const diffInSeconds = Math.floor((now - past) / 1000);
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                const diffInHours = Math.floor(diffInMinutes / 60);
                const diffInDays = Math.floor(diffInHours / 24);

                if (diffInSeconds < 60) {
                    return "just now";
                } else if (diffInMinutes < 60) {
                    return `${diffInMinutes}m ago`;
                } else if (diffInHours < 24) {
                    return `${diffInHours}h ago`;
                } else if (diffInDays < 7) {
                    return `${diffInDays}d ago`;
                } else {
                    return past.toLocaleDateString(); // Or format as needed
                }
            }

            function getFilters() {
                return {
                    status: statusFilter.value,
                    date: dateFilter.value,
                    category: categoryFilter.value,
                    priority: priorityFilter.value,
                    startDate: customStartDateInput.value,
                    endDate: customEndDateInput.value
                };
            }

            function openModal(modalElement) {
                 modalElement.style.display = 'flex';
                 // Focus first input field in the modal
                 const firstInput = modalElement.querySelector('input:not([type="hidden"]), select, textarea');
                 if (firstInput) {
                     setTimeout(() => firstInput.focus(), 50); // Delay focus slightly
                 }
            }

            function closeModal(modalElement) {
                modalElement.style.display = 'none';
            }

            // --- Event Handlers ---

            // Login/Register/Logout
            loginBtn.addEventListener('click', function() {
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();

                // Basic validation (replace with actual auth)
                if (email === 'test@example.com' && password === 'password123') {
                    localStorage.setItem('loggedIn', 'true');
                    showAppView();
                    addNotification('Login successful!', 'success');
                } else {
                    addNotification('Incorrect email or password.', 'error');
                }
            });

            registerLink.addEventListener('click', () => openModal(registerModal));
            cancelRegisterBtn.addEventListener('click', () => closeModal(registerModal));
            submitRegisterBtn.addEventListener('click', () => {
                // Add registration logic here
                closeModal(registerModal);
                addNotification('Account created successfully! Please login.', 'success');
            });

            logoutBtn.addEventListener('click', () => {
                showLoginView();
                addNotification('Logged out successfully.', 'info');
            });

            // Theme Toggle
            themeToggleBtn.addEventListener('click', function() {
                applyTheme(!document.body.classList.contains('dark-mode'));
            });

            // Task CRUD Operations
            addTaskBtn.addEventListener('click', () => {
                // Reset Add Task form
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDetails').value = '';
                document.getElementById('taskCategory').value = '';
                document.getElementById('taskPriority').value = 'Medium';
                flatpickrInstances.taskDueDate.clear(); // Clear date picker
                openModal(addTaskModal);
            });

            cancelTaskBtn.addEventListener('click', () => closeModal(addTaskModal));

            createTaskBtn.addEventListener('click', function() {
                const title = document.getElementById('taskTitle').value.trim();
                const details = document.getElementById('taskDetails').value.trim();
                const category = document.getElementById('taskCategory').value;
                const priority = document.getElementById('taskPriority').value;
                const dueDate = taskDueDateInput.value; // Get value from Flatpickr input

                if (!title) {
                    addNotification('Task title is required.', 'warning');
                    return;
                }

                const newTask = {
                    id: Date.now(), // Use timestamp for ID
                    title,
                    details,
                    status: "Pending",
                    category,
                    priority,
                    dueDate // Already in YYYY-MM-DD format
                };
                tasks.push(newTask);
                saveTasks();
                renderAll(); // Re-render everything
                closeModal(addTaskModal);
                addNotification(`Task "${escapeHtml(title)}" created!`, 'success');
            });

            function handleEditClick(event) {
                const taskItem = event.target.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);

                if (task) {
                    editTaskIdInput.value = task.id;
                    document.getElementById('editTaskTitle').value = task.title;
                    document.getElementById('editTaskDetails').value = task.details;
                    document.getElementById('editTaskCategory').value = task.category;
                    document.getElementById('editTaskPriority').value = task.priority;
                    flatpickrInstances.editTaskDueDate.setDate(task.dueDate, false); // Set date without triggering change event
                    openModal(editTaskModal);
                }
            }

            cancelEditTaskBtn.addEventListener('click', () => closeModal(editTaskModal));

            saveTaskBtn.addEventListener('click', function() {
                const taskId = parseInt(editTaskIdInput.value);
                const title = document.getElementById('editTaskTitle').value.trim();
                const details = document.getElementById('editTaskDetails').value.trim();
                const category = document.getElementById('editTaskCategory').value;
                const priority = document.getElementById('editTaskPriority').value;
                const dueDate = editTaskDueDateInput.value;

                if (!title) {
                    addNotification('Task title is required.', 'warning');
                    return;
                }

                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], title, details, category, priority, dueDate };
                    saveTasks();
                    renderAll();
                    closeModal(editTaskModal);
                    addNotification(`Task "${escapeHtml(title)}" updated!`, 'success');
                } else {
                     addNotification('Error updating task. Task not found.', 'error');
                }
            });

            function handleDeleteClick(event) {
                const taskItem = event.target.closest('.task-item');
                currentTaskIdToDelete = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === currentTaskIdToDelete);
                if (task) {
                    deleteTaskTitle.textContent = task.title; // Show title in confirmation
                    openModal(deleteConfirmModal);
                }
            }

            cancelDeleteBtn.addEventListener('click', () => {
                 closeModal(deleteConfirmModal);
                 currentTaskIdToDelete = null;
            });

            confirmDeleteBtn.addEventListener('click', function() {
                if (currentTaskIdToDelete) {
                    const taskIndex = tasks.findIndex(t => t.id === currentTaskIdToDelete);
                    if (taskIndex > -1) {
                        const deletedTaskTitle = tasks[taskIndex].title;
                        tasks.splice(taskIndex, 1); // Remove task from array
                        saveTasks();
                        renderAll();
                        closeModal(deleteConfirmModal);
                        addNotification(`Task "${escapeHtml(deletedTaskTitle)}" deleted!`, 'success');
                        currentTaskIdToDelete = null;
                    } else {
                         addNotification('Error deleting task. Task not found.', 'error');
                    }
                }
            });

            function handleStatusToggle(event) {
                const taskItem = event.target.closest('.task-item');
                const taskId = parseInt(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                const isChecked = event.target.checked;

                if (task) {
                    task.status = isChecked ? 'Completed' : 'Pending';
                    saveTasks();
                    // Update UI immediately for responsiveness
                    taskItem.classList.toggle('completed', isChecked);
                    taskItem.classList.toggle('pending', !isChecked);
                    taskItem.querySelector('.task-title').style.textDecoration = isChecked ? 'line-through' : 'none';
                     taskItem.querySelector('.task-title').style.color = isChecked ? (document.body.classList.contains('dark-mode') ? '#777' : '#888') : (document.body.classList.contains('dark-mode') ? 'var(--dark-text)' : 'var(--light-text)');

                    addNotification(`Task "${escapeHtml(task.title)}" marked as ${task.status.toLowerCase()}.`, 'info');

                    // Update stats and charts after a short delay to allow UI update
                    setTimeout(() => {
                         updateStats();
                         updateProgress();
                         updateAllCharts();
                    }, 100);
                }
            }

            // View Toggle
            listViewBtn.addEventListener('click', function() {
                tasksContainer.style.display = 'block';
                graphContainer.style.display = 'none';
            });

            graphViewBtn.addEventListener('click', function() {
                tasksContainer.style.display = 'none';
                graphContainer.style.display = 'flex'; // Use flex for side-by-side
                updateAllCharts(); // Ensure charts are up-to-date when shown
            });

            // Filtering
            [statusFilter, categoryFilter, priorityFilter].forEach(el => {
                el.addEventListener('change', renderTasks);
            });

            dateFilter.addEventListener('change', function() {
                if (dateFilter.value === 'custom') {
                    customDateFilterGroup.style.display = 'block';
                     // Automatically render when custom is selected (might show no tasks initially)
                     renderTasks();
                } else {
                    customDateFilterGroup.style.display = 'none';
                    // Clear custom dates when switching away
                    flatpickrInstances.customStart.clear();
                    flatpickrInstances.customEnd.clear();
                    renderTasks(); // Re-render with the new non-custom filter
                }
            });

            // Custom date inputs already trigger renderTasks via Flatpickr's onChange

            resetFiltersBtn.addEventListener('click', function() {
                statusFilter.value = 'all';
                dateFilter.value = 'all';
                categoryFilter.value = 'all';
                priorityFilter.value = 'all';
                customDateFilterGroup.style.display = 'none';
                flatpickrInstances.customStart.clear();
                flatpickrInstances.customEnd.clear();
                renderTasks();
                 addNotification('Filters reset.', 'info');
            });

            // Import/Export
            exportBtn.addEventListener('click', () => openModal(exportModal));
            cancelExportBtn.addEventListener('click', () => closeModal(exportModal));
            confirmExportBtn.addEventListener('click', function() {
                const format = document.getElementById('exportFormat').value;
                let content;
                let mimeType;
                let extension;

                const tasksToExport = JSON.stringify(tasks, null, 2); // Pretty print JSON

                if (format === 'csv') {
                    // Basic CSV export
                    const header = "ID,Title,Details,Status,Category,Priority,DueDate\n";
                    const rows = tasks.map(task =>
                        [
                            task.id,
                            `"${task.title.replace(/"/g, '""')}"`, // Handle quotes in title
                            `"${task.details.replace(/"/g, '""')}"`,
                            task.status,
                            task.category,
                            task.priority,
                            task.dueDate
                        ].join(',')
                    ).join('\n');
                    content = header + rows;
                    mimeType = 'text/csv;charset=utf-8;';
                    extension = 'csv';
                } else if (format === 'json') {
                    content = tasksToExport;
                    mimeType = 'application/json;charset=utf-8;';
                    extension = 'json';
                } else {
                     addNotification('Invalid export format selected.', 'warning');
                     return;
                }


                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tasks_export_${new Date().toISOString().split('T')[0]}.${extension}`;
                document.body.appendChild(a); // Required for Firefox
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                closeModal(exportModal);
                addNotification('Tasks exported successfully!', 'success');
            });

            importBtn.addEventListener('click', () => {
                 fileUploadInput.value = ''; // Clear previous selection
                 openModal(importModal);
            });
            cancelImportBtn.addEventListener('click', () => closeModal(importModal));
            confirmImportBtn.addEventListener('click', function() {
                const file = fileUploadInput.files[0];
                if (!file) {
                    addNotification('Please select a file to import.', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        let importedTasks = [];
                        if (file.name.endsWith('.csv')) {
                             // Basic CSV parsing (assumes specific column order and no complex quoting/newlines within fields)
                             const lines = event.target.result.split('\n');
                             const headers = lines[0].trim().toLowerCase().split(',');
                             const idIndex = headers.indexOf('id');
                             const titleIndex = headers.indexOf('title');
                             const detailsIndex = headers.indexOf('details');
                             const statusIndex = headers.indexOf('status');
                             const categoryIndex = headers.indexOf('category');
                             const priorityIndex = headers.indexOf('priority');
                             const dueDateIndex = headers.indexOf('duedate'); // Lowercase

                             if (titleIndex === -1 || statusIndex === -1 || priorityIndex === -1 || dueDateIndex === -1) {
                                 throw new Error("CSV missing required columns (Title, Status, Priority, DueDate).");
                             }

                             for (let i = 1; i < lines.length; i++) {
                                 if (!lines[i].trim()) continue; // Skip empty lines
                                 const values = lines[i].split(','); // Simple split, may fail with commas in fields
                                 const newTask = {
                                     id: idIndex !== -1 ? parseInt(values[idIndex] || Date.now() + i) : Date.now() + i, // Generate ID if missing
                                     title: values[titleIndex]?.replace(/^"|"$/g, '').replace(/""/g, '"') || `Untitled Task ${i}`,
                                     details: detailsIndex !== -1 ? values[detailsIndex]?.replace(/^"|"$/g, '').replace(/""/g, '"') : '',
                                     status: ['Completed', 'Pending'].includes(values[statusIndex]) ? values[statusIndex] : 'Pending',
                                     category: categoryIndex !== -1 ? values[categoryIndex] : '',
                                     priority: ['High', 'Medium', 'Low'].includes(values[priorityIndex]) ? values[priorityIndex] : 'Medium',
                                     dueDate: values[dueDateIndex] && /^\d{4}-\d{2}-\d{2}$/.test(values[dueDateIndex]) ? values[dueDateIndex] : ''
                                 };
                                 importedTasks.push(newTask);
                             }

                        } else if (file.name.endsWith('.json')) {
                            importedTasks = JSON.parse(event.target.result);
                            if (!Array.isArray(importedTasks)) {
                                throw new Error("JSON file must contain an array of tasks.");
                            }
                            // Basic validation of imported task structure (optional)
                            importedTasks = importedTasks.filter(task => task.title && task.status && task.priority);
                             // Ensure unique IDs (optional: could merge or replace based on ID)
                             importedTasks.forEach((task, index) => task.id = Date.now() + index);
                        } else {
                            throw new Error("Unsupported file type. Please use .csv or .json.");
                        }

                        // Add imported tasks to the existing list (or replace, depending on desired behavior)
                        tasks = tasks.concat(importedTasks);
                        saveTasks();
                        renderAll();
                        closeModal(importModal);
                        addNotification(`${importedTasks.length} tasks imported successfully!`, 'success');

                    } catch (error) {
                        console.error("Import Error:", error);
                        addNotification(`Error importing file: ${error.message}`, 'error');
                    }
                };
                reader.onerror = function() {
                     addNotification('Error reading file.', 'error');
                };
                reader.readAsText(file);
            });

            // Notification Interaction
            notificationBtn.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent window click listener from closing it immediately
                notificationList.style.display = notificationList.style.display === 'block' ? 'none' : 'block';
                // Mark all as read when opening (optional)
                /*
                if (notificationList.style.display === 'block') {
                    notifications.forEach(n => n.read = true);
                    saveNotifications();
                    renderNotifications();
                }
                */
            });

            // Other Event Listeners
            refreshLogo.addEventListener('click', () => {
                 renderAll(); // Re-render everything
                 addNotification('View refreshed.', 'info');
            });

            // Close dropdowns/modals on outside click
            window.addEventListener('click', function(event) {
                // Close notification list
                if (!notificationBtn.contains(event.target) && !notificationList.contains(event.target)) {
                    notificationList.style.display = 'none';
                }
                // Close modals if click is on the overlay
                if (event.target.classList.contains('modal')) {
                     closeModal(event.target);
                }
            });

             // Close modals on Escape key press
             window.addEventListener('keydown', function(event) {
                 if (event.key === 'Escape') {
                     document.querySelectorAll('.modal').forEach(modal => {
                         if (modal.style.display === 'flex') {
                             closeModal(modal);
                         }
                     });
                     if (notificationList.style.display === 'block') {
                         notificationList.style.display = 'none';
                     }
                 }
             });

        }); // End DOMContentLoaded
    </script>
</body>
</html>
